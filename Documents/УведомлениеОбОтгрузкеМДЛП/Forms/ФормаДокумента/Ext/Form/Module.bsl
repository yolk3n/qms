
#Область ОписаниеПеременных

&НаКлиенте
Перем КэшированныеЗначения;

#КонецОбласти

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	УстановитьУсловноеОформление();
	
	Если Параметры.Свойство("АвтоТест") Тогда // Возврат при получении формы для анализа.
		Возврат;
	КонецЕсли;
	
	ОбновлениеИнформационнойБазы.ПроверитьОбъектОбработан(Объект, ЭтотОбъект);
	
	// СтандартныеПодсистемы.ВерсионированиеОбъектов
	Если ОбщегоНазначения.ПодсистемаСуществует("СтандартныеПодсистемы.ВерсионированиеОбъектов") Тогда
		МодульВерсионированиеОбъектов = ОбщегоНазначения.ОбщийМодуль("ВерсионированиеОбъектов");
		МодульВерсионированиеОбъектов.ПриСозданииНаСервере(ЭтотОбъект);
	КонецЕсли;
	// Конец СтандартныеПодсистемы.ВерсионированиеОбъектов
	
	// СтандартныеПодсистемы.ПодключаемыеКоманды
	Если ОбщегоНазначения.ПодсистемаСуществует("СтандартныеПодсистемы.ПодключаемыеКоманды") Тогда
		МодульПодключаемыеКоманды = ОбщегоНазначения.ОбщийМодуль("ПодключаемыеКоманды");
		МодульПодключаемыеКоманды.ПриСозданииНаСервере(ЭтотОбъект);
	КонецЕсли;
	// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
	
	ИнтеграцияМДЛППереопределяемый.НастроитьПодключаемоеОборудование(ЭтотОбъект);
	
	Если Объект.Ссылка.Пустая() Тогда
		ПриСозданииЧтенииНаСервере();
	КонецЕсли;
	
	ГосударственныеИнформационныеСистемыПереопределяемый.УстановитьПараметрыВыбораНоменклатуры(ЭтотОбъект);
	ГосударственныеИнформационныеСистемыПереопределяемый.УстановитьСвязиПараметровВыбораСНоменклатурой(ЭтотОбъект, Элементы.ТоварыХарактеристика.Имя);
	ГосударственныеИнформационныеСистемыПереопределяемый.УстановитьСвязиПараметровВыбораСНоменклатурой(ЭтотОбъект, Элементы.ТоварыСерия.Имя);
	ГосударственныеИнформационныеСистемыПереопределяемый.УстановитьСвязиПараметровВыбораСНоменклатурой(ЭтотОбъект, Элементы.ТоварыУпаковка.Имя);
	
	ГосударственныеИнформационныеСистемыПереопределяемый.УстановитьПараметрыВыбораНоменклатуры(ЭтотОбъект, Элементы.СоставТранспортныхУпаковокНоменклатура.Имя);
	ГосударственныеИнформационныеСистемыПереопределяемый.УстановитьСвязиПараметровВыбораСНоменклатурой(ЭтотОбъект, Элементы.СоставТранспортныхУпаковокХарактеристика.Имя, "Элементы.СоставТранспортныхУпаковок.ТекущиеДанные.Номенклатура");
	ГосударственныеИнформационныеСистемыПереопределяемый.УстановитьСвязиПараметровВыбораСНоменклатурой(ЭтотОбъект, Элементы.СоставТранспортныхУпаковокСерия.Имя, "Элементы.СоставТранспортныхУпаковок.ТекущиеДанные.Номенклатура");
	
	ИспользоватьХарактеристики = ИнтеграцияМДЛП.ИспользоватьХарактеристикиНоменклатуры();
	Элементы.ТоварыХарактеристика.Видимость = ИспользоватьХарактеристики;
	Элементы.СоставТранспортныхУпаковокХарактеристика.Видимость = ИспользоватьХарактеристики;
	ИспользоватьСерии = ИнтеграцияМДЛП.ИспользоватьСерииНоменклатуры();
	Элементы.ТоварыСерия.Видимость = ИспользоватьСерии;
	Элементы.СоставТранспортныхУпаковокСерия.Видимость = ИспользоватьСерии;
	Элементы.ТоварыУпаковка.Видимость = ИнтеграцияМДЛП.ИспользоватьУпаковкиНоменклатуры();
	
	ВалютаРегламентированногоУчета = ИнтеграцияМДЛППереопределяемый.ВалютаРегламентированногоУчета();
	Элементы.ТоварыЦена.Заголовок               = СтрЗаменить(НСтр("ru = 'Цена (%Валюта%)'"), "%Валюта%", ВалютаРегламентированногоУчета);
	Элементы.ТранспортныеУпаковкиЦена.Заголовок = СтрЗаменить(НСтр("ru = 'Цена (%Валюта%)'"), "%Валюта%", ВалютаРегламентированногоУчета);
	Элементы.СоставТранспортныхУпаковокЦена.Заголовок = СтрЗаменить(НСтр("ru = 'Цена (%Валюта%)'"), "%Валюта%", ВалютаРегламентированногоУчета);
	
	СобытияФормМДЛППереопределяемый.ПриСозданииНаСервере(ЭтотОбъект, Отказ, СтандартнаяОбработка);
	
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	
	ПриСозданииЧтенииНаСервере();
	
	// СтандартныеПодсистемы.ПодключаемыеКоманды
	Если ОбщегоНазначения.ПодсистемаСуществует("СтандартныеПодсистемы.ПодключаемыеКоманды") Тогда
		МодульПодключаемыеКомандыКлиентСервер = ОбщегоНазначения.ОбщийМодуль("ПодключаемыеКомандыКлиентСервер");
		МодульПодключаемыеКомандыКлиентСервер.ОбновитьКоманды(ЭтотОбъект, Объект);
	КонецЕсли;
	// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
	
	СобытияФормМДЛППереопределяемый.ПриЧтенииНаСервере(ЭтотОбъект, ТекущийОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	Элементы.ТоварыОтображатьВсеНомераУпаковок.Пометка = Не ПоказыватьВсеНомераУпаковок;
	
	// ПодключаемоеОборудование.СканерыШтрихкода
	Если ОбщегоНазначенияКлиент.ПодсистемаСуществует("ПоддержкаОборудования.ПодключаемоеОборудование.УстройстваВвода") Тогда
		ПоддерживаемыеТипыПодключаемогоОборудования = "СканерШтрихкода";
		МодульМенеджерОборудованияКлиент = ОбщегоНазначенияКлиент.ОбщийМодуль("МенеджерОборудованияКлиент");
		МодульМенеджерОборудованияКлиент.НачатьПодключениеОборудованиеПриОткрытииФормы(Неопределено, ЭтотОбъект, ПоддерживаемыеТипыПодключаемогоОборудования);
	КонецЕсли;
	// Конец ПодключаемоеОборудование.СканерыШтрихкода
	
	// СтандартныеПодсистемы.ПодключаемыеКоманды
	Если ОбщегоНазначенияКлиент.ПодсистемаСуществует("СтандартныеПодсистемы.ПодключаемыеКоманды") Тогда
		МодульПодключаемыеКомандыКлиент = ОбщегоНазначенияКлиент.ОбщийМодуль("ПодключаемыеКомандыКлиент");
		МодульПодключаемыеКомандыКлиент.НачатьОбновлениеКоманд(ЭтотОбъект);
	КонецЕсли;
	// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если ИмяСобытия = "ИзменениеСостоянияМДЛП"
	   И Параметр.Ссылка = Объект.Ссылка Тогда
		
		Прочитать();
		
	КонецЕсли;
	
	Если ИмяСобытия = "ВыполненОбменМДЛП" Тогда
		
		ОбновитьСтатусУведомления();
		ОбновитьПредставленияСостоянияПодтвержденияУпаковок(Объект);
		
	КонецЕсли;
	
	Если Источник = "ПодключаемоеОборудование" И ВводДоступен() И Не ТолькоПросмотр Тогда
		Если ИмяСобытия = "ScanData" Тогда
			
			ОбработатьШтрихкоды(ИнтеграцияМДЛПКлиент.ПреобразоватьДанныеСоСканераВМассив(Параметр));
			
		КонецЕсли;
	КонецЕсли;
	
	СобытияФормМДЛПКлиентПереопределяемый.ОбработкаОповещения(ЭтотОбъект, ИмяСобытия, Параметр, Источник);
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	
	Если ПараметрыЗаписи.РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
		Если ОбщегоНазначенияКлиент.ПодсистемаСуществует("СтандартныеПодсистемы.ОценкаПроизводительности") Тогда
			МодульОценкаПроизводительностиКлиент = ОбщегоНазначенияКлиент.ОбщийМодуль("ОценкаПроизводительностиКлиент");
			МодульОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина, "Документ.УведомлениеОбОтгрузкеМДЛП.Форма.ФормаДокумента.Провести");
		КонецЕсли;
	КонецЕсли;
	
	СобытияФормМДЛПКлиентПереопределяемый.ПередЗаписью(ЭтотОбъект, Отказ, ПараметрыЗаписи);
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	ГосударственныеИнформационныеСистемыПереопределяемый.ЗаполнитьСлужебныеРеквизитыВКоллекции(ЭтотОбъект, Объект.Товары);
	
	ОбновитьСтатусУведомления();
	ОбновитьПредставленияСостоянияПодтвержденияУпаковок(Объект);
	ОбновитьСтатусыЗаполненияНомеровУпаковок(Объект);
	
	СобытияФормМДЛППереопределяемый.ПослеЗаписиНаСервере(ЭтотОбъект, ТекущийОбъект, ПараметрыЗаписи);
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	
	ПараметрыЗаписи.Вставить("Основание", Объект.Основание);
	Оповестить("Запись_УведомлениеОбОтгрузкеМДЛП", ПараметрыЗаписи, Объект.Ссылка);
	
	// СтандартныеПодсистемы.ПодключаемыеКоманды
	Если ОбщегоНазначенияКлиент.ПодсистемаСуществует("СтандартныеПодсистемы.ПодключаемыеКоманды") Тогда
		МодульПодключаемыеКомандыКлиент = ОбщегоНазначенияКлиент.ОбщийМодуль("ПодключаемыеКомандыКлиент");
		МодульПодключаемыеКомандыКлиент.ПослеЗаписи(ЭтотОбъект, Объект, ПараметрыЗаписи);
	КонецЕсли;
	// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
	
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии(ЗавершениеРаботы)
	
	// ПодключаемоеОборудование
	Если ОбщегоНазначенияКлиент.ПодсистемаСуществует("ПоддержкаОборудования.ПодключаемоеОборудование") Тогда
		МодульМенеджерОборудованияКлиент = ОбщегоНазначенияКлиент.ОбщийМодуль("МенеджерОборудованияКлиент");
		МодульМенеджерОборудованияКлиент.НачатьОтключениеОборудованиеПриЗакрытииФормы(Неопределено, ЭтотОбъект);
	КонецЕсли;
	// Конец ПодключаемоеОборудование
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура СтатусПредставлениеОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылкаФорматированнойСтроки, СтандартнаяОбработка)
	
	ОчиститьСообщения();
	
	Если НавигационнаяСсылкаФорматированнойСтроки = "АктуализироватьДанныеОбУпаковках" Тогда
		СтандартнаяОбработка = Ложь;
		Обработчик = Новый ОписаниеОповещения("АктуализироватьДанныеОбУпаковках", ЭтотОбъект);
		ИнтеграцияМДЛПСлужебныйКлиент.ЗаписатьДокументВФормеПриНеобходимости(Обработчик, ЭтотОбъект, Истина);
	Иначе
		ИнтеграцияМДЛПКлиент.ОбработатьНавигационнуюСсылкуСтатуса(ЭтотОбъект, НавигационнаяСсылкаФорматированнойСтроки, СтандартнаяОбработка);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОперацияПриИзменении(Элемент)
	
	Если Объект.Операция <> ПредопределенноеЗначение("Перечисление.ОперацииОтгрузкиМДЛП.Продажа") Тогда
		Если Объект.КонтрагентНеЗарегистрированВГИСМ Тогда
			Объект.КонтрагентНеЗарегистрированВГИСМ = Ложь;
		КонецЕсли;
	КонецЕсли;
	
	УстановитьВидимостьЭлементовПоОперации();
	
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентНеЗарегистрированВГИСМПриИзменении(Элемент)
	
	УстановитьВидимостьРеквизитовКонтрагента();
	
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентПриИзменении(Элемент)
	
	Если ЗначениеЗаполнено(Объект.Контрагент) Тогда
		ОбработатьИзменениеКонтрагента();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентФизическоеЛицоПриИзменении(Элемент)
	
	Объект.КонтрагентФизическоеЛицо = (КонтрагентФизическоеЛицо = 1);
	НастроитьВидимостьРеквизитовКонтрагента(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентИННПриИзменении(Элемент)
	
	ТекстСообщения = "";
	ОчиститьСообщения();
	Если Не ПустаяСтрока(Объект.КонтрагентИНН)
	   И Не РегламентированныеДанныеКлиентСервер.ИННСоответствуетТребованиям(Объект.КонтрагентИНН, Не Объект.КонтрагентФизическоеЛицо, ТекстСообщения) Тогда
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,, "Объект.КонтрагентИНН");
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентКПППриИзменении(Элемент)
	
	ТекстСообщения = "";
	ОчиститьСообщения();
	Если Не ПустаяСтрока(Объект.КонтрагентКПП)
	   И Не РегламентированныеДанныеКлиентСервер.КППСоответствуетТребованиям(Объект.КонтрагентКПП, ТекстСообщения) Тогда
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,, "Объект.КонтрагентКПП");
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура АдресСкладаКонтрагентаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	ИнтеграцияМДЛПКлиент.РедактироватьАдресВДиалоге(ЭтотОбъект, Объект, "АдресСкладаКонтрагента");
	
КонецПроцедуры

&НаКлиенте
Процедура АдресСкладаКонтрагентаПриИзменении(Элемент)
	
	Если ЗначениеЗаполнено(Объект.АдресСкладаКонтрагента) Тогда
		ОбработатьИзменениеАдреса();
	Иначе
		Объект.АдресСкладаКонтрагентаЗначенияПолей = "";
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура АдресСкладаКонтрагентаОчистка(Элемент, СтандартнаяОбработка)
	
	Объект.АдресСкладаКонтрагентаЗначенияПолей = "";
	
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентКодСтраныНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ПараметрыВыбораСтраны = Новый Структура;
	ПараметрыВыбораСтраны.Вставить("РежимВыбора", Истина);
	ПараметрыВыбораСтраны.Вставить("ЗакрыватьПриВыборе", ЗакрыватьПриВыборе);
	
	ОткрытьФорму(
		"Справочник.СтраныМира.Форма.Классификатор",
		ПараметрыВыбораСтраны,
		ЭтотОбъект,
		,
		,
		,
		Новый ОписаниеОповещения("ОбработатьВыборСтраны", ЭтотОбъект),
		РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура НомерКонтрактаПриИзменении(Элемент)
	
	Объект.НомерКонтракта = СокрЛП(Объект.НомерКонтракта);
	
КонецПроцедуры

&НаКлиенте
Процедура НомерГосударственногоКонтрактаПриИзменении(Элемент)
	
	Объект.НомерГосударственногоКонтракта = СокрЛП(Объект.НомерГосударственногоКонтракта);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТабличнойЧастиТовары

&НаКлиенте
Процедура ТоварыПриАктивизацииСтроки(Элемент)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	
	Если ТекущиеДанные <> Неопределено Тогда
		УстановитьОтборНомеровУпаковок(ТекущиеДанные.ИдентификаторСтроки);
		СобытияФормМДЛПКлиентСервер.ОбновитьЗаголовокКоличествоНомеровУпаковок(ЭтотОбъект);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	Если НоваяСтрока Тогда
		ТекущиеДанные = Элемент.ТекущиеДанные;
		ТекущиеДанные.ИдентификаторСтроки = Строка(Новый УникальныйИдентификатор);
		УстановитьОтборНомеровУпаковок(ТекущиеДанные.ИдентификаторСтроки);
		СобытияФормМДЛПКлиентСервер.ОбновитьЗаголовокКоличествоНомеровУпаковок(ЭтотОбъект);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыПередУдалением(Элемент, Отказ)
	
	СобытияФормМДЛПКлиент.ТоварыПередУдалением(ЭтотОбъект, Элемент, Отказ);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыНоменклатураНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	СобытияФормМДЛПКлиентПереопределяемый.НачалоВыбораНоменклатуры(ЭтотОбъект, ТекущаяСтрока, Элемент, ДанныеВыбора, СтандартнаяОбработка);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыНоменклатураПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	ПараметрыЗаполнения = ИнтеграцияМДЛПКлиентСервер.ПараметрыЗаполненияТабличнойЧасти();
	Если Объект.СхемаАкцептования = ПредопределенноеЗначение("Перечисление.СхемыАкцептованияМДЛП.ОбратныйПорядок") Тогда
		ПараметрыЗаполнения.ПересчитатьКоличествоУпаковок = Истина;
		ПараметрыЗаполнения.ПересчитатьЦену = Истина;
	Иначе
		ПараметрыЗаполнения.ПересчитатьКоличествоЕдиниц   = Истина;
	КонецЕсли;
	ПараметрыЗаполнения.ПроверитьСериюРассчитатьСтатус = Истина;
	ПараметрыЗаполнения.ПараметрыУказанияСерий = ПараметрыУказанияСерий;
	
	СобытияФормМДЛПКлиентПереопределяемый.ПриИзмененииНоменклатуры(ЭтотОбъект, ТекущаяСтрока, КэшированныеЗначения, ПараметрыЗаполнения);
	
	ОбновитьСтатусЗаполненияУпаковокВСтроке(ТекущаяСтрока);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыХарактеристикаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	СобытияФормМДЛПКлиентПереопределяемый.НачалоВыбораХарактеристики(ЭтотОбъект, ТекущаяСтрока, Элемент, ДанныеВыбора, СтандартнаяОбработка);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыХарактеристикаПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	ПараметрыЗаполнения = ИнтеграцияМДЛПКлиентСервер.ПараметрыЗаполненияТабличнойЧасти();
	Если Объект.СхемаАкцептования = ПредопределенноеЗначение("Перечисление.СхемыАкцептованияМДЛП.ОбратныйПорядок") Тогда
		ПараметрыЗаполнения.ПересчитатьКоличествоУпаковок = Истина;
		ПараметрыЗаполнения.ПересчитатьЦену = Истина;
	Иначе
		ПараметрыЗаполнения.ПересчитатьКоличествоЕдиниц   = Истина;
	КонецЕсли;
	
	СобытияФормМДЛПКлиентПереопределяемый.ПриИзмененииХарактеристики(ЭтотОбъект, ТекущаяСтрока, КэшированныеЗначения, ПараметрыЗаполнения);
	
	ОбновитьСтатусЗаполненияУпаковокВСтроке(ТекущаяСтрока);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСерияНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	СобытияФормМДЛПКлиентПереопределяемый.НачалоВыбораСерии(ЭтотОбъект, ТекущаяСтрока, ПараметрыУказанияСерий, Элемент, ДанныеВыбора, СтандартнаяОбработка);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСерияПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	ПараметрыЗаполнения = ИнтеграцияМДЛПКлиентСервер.ПараметрыЗаполненияТабличнойЧасти();
	ПараметрыЗаполнения.ПараметрыУказанияСерий = ПараметрыУказанияСерий;
	
	СобытияФормМДЛПКлиентПереопределяемый.ПриИзмененииСерии(ЭтотОбъект, ТекущаяСтрока, КэшированныеЗначения, ПараметрыЗаполнения);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыУпаковкаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	СобытияФормМДЛПКлиентПереопределяемый.НачалоВыбораУпаковки(ЭтотОбъект, ТекущаяСтрока, Элемент, ДанныеВыбора, СтандартнаяОбработка);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыУпаковкаПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	ПараметрыЗаполнения = ИнтеграцияМДЛПКлиентСервер.ПараметрыЗаполненияТабличнойЧасти();
	Если Объект.СхемаАкцептования = ПредопределенноеЗначение("Перечисление.СхемыАкцептованияМДЛП.ОбратныйПорядок") Тогда
		ПараметрыЗаполнения.ПересчитатьКоличествоУпаковок = Истина;
		ПараметрыЗаполнения.ПересчитатьЦену = (Объект.Операция = ПредопределенноеЗначение("Перечисление.ОперацииОтгрузкиМДЛП.Продажа")
			Или Объект.Операция = ПредопределенноеЗначение("Перечисление.ОперацииОтгрузкиМДЛП.Возврат"));
	Иначе
		ПараметрыЗаполнения.ПересчитатьКоличествоЕдиниц   = Истина;
	КонецЕсли;
	
	СобытияФормМДЛПКлиентПереопределяемый.ПриИзмененииУпаковки(ЭтотОбъект, ТекущаяСтрока, КэшированныеЗначения, ПараметрыЗаполнения);
	
	ОбновитьСтатусЗаполненияУпаковокВСтроке(ТекущаяСтрока);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыКоличествоУпаковокПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	ПараметрыЗаполнения = ИнтеграцияМДЛПКлиентСервер.ПараметрыЗаполненияТабличнойЧасти();
	ПараметрыЗаполнения.ПересчитатьКоличествоЕдиниц = Истина;
	ПараметрыЗаполнения.ПересчитатьЦену = (Объект.Операция = ПредопределенноеЗначение("Перечисление.ОперацииОтгрузкиМДЛП.Продажа")
		Или Объект.Операция = ПредопределенноеЗначение("Перечисление.ОперацииОтгрузкиМДЛП.Возврат"));
	
	СобытияФормМДЛПКлиентПереопределяемый.ПриИзмененииКоличестваУпаковок(ЭтотОбъект, ТекущаяСтрока, КэшированныеЗначения, ПараметрыЗаполнения);
	
	ОбновитьСтатусЗаполненияУпаковокВСтроке(ТекущаяСтрока);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	ПараметрыЗаполнения = ИнтеграцияМДЛПКлиентСервер.ПараметрыЗаполненияТабличнойЧасти();
	ПараметрыЗаполнения.ПересчитатьСумму = Истина;
	
	СобытияФормМДЛПКлиентПереопределяемый.ПриИзмененииЦены(ЭтотОбъект, ТекущаяСтрока, КэшированныеЗначения, ПараметрыЗаполнения);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	ПараметрыЗаполнения = ИнтеграцияМДЛПКлиентСервер.ПараметрыЗаполненияТабличнойЧасти();
	ПараметрыЗаполнения.ПересчитатьЦену = Истина;
	
	СобытияФормМДЛПКлиентПереопределяемый.ПриИзмененииСуммы(ЭтотОбъект, ТекущаяСтрока, КэшированныеЗначения, ПараметрыЗаполнения);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТабличнойЧастиНомераУпаковок

&НаКлиенте
Процедура НомераУпаковокПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'Не выбрана строка с товаром.'"));
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	ПараметрыОтбора = Новый Структура("ИдентификаторСтроки", ТекущиеДанные.ИдентификаторСтроки);
	СтрокиУпаковок = Объект.НомераУпаковок.НайтиСтроки(ПараметрыОтбора);
	
	Если ТекущиеДанные.Количество <= СтрокиУпаковок.Количество() Тогда
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура НомераУпаковокПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	Если НоваяСтрока Тогда
		ТекущиеДанные = Элемент.ТекущиеДанные;
		Если Копирование Тогда
			ТекущиеДанные.НомерКиЗ = "";
		Иначе
			ТекущиеДанные.ИдентификаторСтроки = Элементы.Товары.ТекущиеДанные.ИдентификаторСтроки;
		КонецЕсли;
		ТекущиеДанные.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.КПередаче");
		ТекущиеДанные.СостояниеПолученияИнформации = Неопределено;
		ТекущиеДанные.Статус = "";
		ОбновитьПредставленияСостоянияПодтвержденияУпаковок(Объект);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура НомераУпаковокПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)
	
	Если НоваяСтрока И Не ОтменаРедактирования Тогда
		ОбновитьСтатусЗаполненияУпаковокВСтроке(Элементы.Товары.ТекущиеДанные);
		СобытияФормМДЛПКлиентСервер.ОбновитьЗаголовокКоличествоНомеровУпаковок(ЭтотОбъект);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура НомераУпаковокПередУдалением(Элемент, Отказ)
	
	Отказ = Истина;
	Если СобытияФормМДЛПКлиент.УдалитьСтрокиУпаковокИзТабличнойЧасти(Объект.НомераУпаковок, Элемент.ВыделенныеСтроки) Тогда
		ОбновитьСтатусыЗаполненияНомеровУпаковок(Объект);
		СобытияФормМДЛПКлиентСервер.ОбновитьЗаголовокКоличествоНомеровУпаковок(ЭтотОбъект);
		Модифицированность = Истина;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТабличнойЧастиТранспортныеУпаковки

&НаКлиенте
Процедура ТранспортныеУпаковкиПриАктивизацииСтроки(Элемент)
	
	ТекущиеДанные = Элемент.ТекущиеДанные;
	Если ТекущиеДанные <> Неопределено Тогда
		ИнтеграцияМДЛПКлиент.УстановитьОтборСтрок(
			Элементы.СоставТранспортныхУпаковок.ОтборСтрок,
			Новый Структура("ИдентификаторСтроки", ТекущиеДанные.ИдентификаторСтроки));
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТранспортныеУпаковкиПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	Если НоваяСтрока Тогда
		ТекущиеДанные = Элемент.ТекущиеДанные;
		ТекущиеДанные.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.КПередаче");
		ТекущиеДанные.ИдентификаторСтроки = Строка(Новый УникальныйИдентификатор);
		ИнтеграцияМДЛПКлиент.УстановитьОтборСтрок(
			Элементы.СоставТранспортныхУпаковок.ОтборСтрок,
			Новый Структура("ИдентификаторСтроки", ТекущиеДанные.ИдентификаторСтроки));
		Если Копирование Тогда
			ТекущиеДанные.НомерУпаковки = "";
		КонецЕсли;
		ТекущиеДанные.СостояниеПолученияИнформации = Неопределено;
		ТекущиеДанные.Статус = "";
		ОбновитьПредставленияСостоянияПодтвержденияУпаковок(Объект);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТранспортныеУпаковкиПередУдалением(Элемент, Отказ)
	
	Отказ = Истина;
	Если СобытияФормМДЛПКлиент.УдалитьСтрокиУпаковокИзТабличнойЧасти(
			Объект.ТранспортныеУпаковки,
			Элемент.ВыделенныеСтроки,
			Объект.СоставТранспортныхУпаковок,
			Объект.НомераУпаковок,
			Объект.ИерархияГрупповыхУпаковок) Тогда
		Модифицированность = Истина;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТабличнойЧастиСоставТранспортныхУпаковок

&НаКлиенте
Процедура СоставТранспортныхУпаковокПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	
	ТекущиеДанные = Элементы.ТранспортныеУпаковки.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'Не выбрана транспортная упаковка.'"));
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СоставТранспортныхУпаковокПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	Если НоваяСтрока Тогда
		ТекущиеДанные = Элемент.ТекущиеДанные;
		ТекущиеДанные.ИдентификаторСтроки = Элементы.ТранспортныеУпаковки.ТекущиеДанные.ИдентификаторСтроки;
		Если Копирование Тогда
			ТекущиеДанные.ИдентификаторСтрокиУпаковки = "";
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СоставТранспортныхУпаковокНоменклатураНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	ТекущаяСтрока = Элементы.СоставТранспортныхУпаковок.ТекущиеДанные;
	СобытияФормМДЛПКлиентПереопределяемый.НачалоВыбораНоменклатуры(ЭтотОбъект, ТекущаяСтрока, Элемент, ДанныеВыбора, СтандартнаяОбработка);
	
КонецПроцедуры

&НаКлиенте
Процедура СоставТранспортныхУпаковокНоменклатураПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.СоставТранспортныхУпаковок.ТекущиеДанные;
	
	ПараметрыЗаполнения = ИнтеграцияМДЛПКлиентСервер.ПараметрыЗаполненияТабличнойЧасти();
	ПараметрыЗаполнения.ОбработатьУпаковки = Ложь;
	ПараметрыЗаполнения.ПроверитьСериюРассчитатьСтатус = Истина;
	ПараметрыЗаполнения.ПараметрыУказанияСерий = ПараметрыУказанияСерий;
	
	СобытияФормМДЛПКлиентПереопределяемый.ПриИзмененииНоменклатуры(ЭтотОбъект, ТекущаяСтрока, КэшированныеЗначения, ПараметрыЗаполнения);
	
КонецПроцедуры

&НаКлиенте
Процедура СоставТранспортныхУпаковокСерияНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	ТекущаяСтрока = Элементы.СоставТранспортныхУпаковок.ТекущиеДанные;
	СобытияФормМДЛПКлиентПереопределяемый.НачалоВыбораСерии(ЭтотОбъект, ТекущаяСтрока, ПараметрыУказанияСерий, Элемент, ДанныеВыбора, СтандартнаяОбработка);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ОтображатьВсеНомераУпаковок(Команда)
	
	ПоказыватьВсеНомераУпаковок = Не ПоказыватьВсеНомераУпаковок;
	Элементы.ТоварыОтображатьВсеНомераУпаковок.Пометка = Не ПоказыватьВсеНомераУпаковок;
	
	УстановитьОтборНомеровУпаковок(ИдентификаторТекущейСтроки);
	СобытияФормМДЛПКлиентСервер.ОбновитьЗаголовокКоличествоНомеровУпаковок(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтметитьКПередаче(Команда)
	
	КоличествоСтрок = Объект.НомераУпаковок.Количество() + Объект.ТранспортныеУпаковки.Количество();
	Если КоличествоСтрок = 0 Тогда
		ТекстСообщения = НСтр("ru = 'Нет строк для подтверждения.'");
		ПоказатьПредупреждение(,ТекстСообщения);
		Возврат;
	КонецЕсли;
	
	ЭтоПрямаяСхемаАкцептования = Объект.СхемаАкцептования = ПредопределенноеЗначение("Перечисление.СхемыАкцептованияМДЛП.ПрямойПорядок");
	
	КоличествоУстановленныхСостоянийКПередаче = 0;
	Для Каждого ТекущаяСтрока Из Объект.НомераУпаковок Цикл
		
		АрбитражНеУстановлен             = ТекущаяСтрока.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.ПустаяСсылка");
		ИнициацияПостановкиВАрбитраж     = ТекущаяСтрока.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.УстановленПередача");
		ИнициацияСнятияАрбитража         = ТекущаяСтрока.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.СнятПередача");
		ПодтверждениеПостановкиВАрбитраж = ТекущаяСтрока.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.УстановленПолучение");
		ПодтверждениеСнятияАрбитража     = ТекущаяСтрока.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.СнятПолучение");
		
		Если Не ЗначениеЗаполнено(ТекущаяСтрока.СостояниеПодтверждения)
		 Или АрбитражНеУстановлен И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоГИСМ")
		 Или АрбитражНеУстановлен И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ПодтвердитьОтклоненоГИСМ")
		 Или АрбитражНеУстановлен И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Отозвать")
		 Или АрбитражНеУстановлен И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтозватьОтклоненоГИСМ") Тогда
			
			// Передач еще не было;
			// Возврат исходного состояния подтверждения в случае, если передача товаров была отклонена ГИСМ;
			// Возврат исходного состояния подтверждения в случае, если подтверждение передачи товаров было отклонена ГИСМ.
			// Возврат исходного состояния подтверждения в случае, если отзыв передачи товаров или подтверждение отгрузки товаров еще не были выполнены;
			// Возврат исходного состояния подтверждения в случае, если отзыв передачи товаров или подтверждение отгрузки товаров был отклонен ГИСМ;
			
			Если ЭтоПрямаяСхемаАкцептования Тогда
				ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.КПередаче");
			Иначе
				ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтвердить");
			КонецЕсли;
			КоличествоУстановленныхСостоянийКПередаче = КоличествоУстановленныхСостоянийКПередаче + 1;
			
		ИначеЕсли ИнициацияПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.КПередаче")
			  Или ИнициацияПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоГИСМ")
			  Или ИнициацияПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоПокупателем")
			  Или ПодтверждениеПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоПоставщиком")
			  Или ИнициацияСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтверждено")
			  Или ПодтверждениеСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтверждено") Тогда
			
			// Возврат исходного состояния подтверждения в случае, если постановка в арбитраж еще не была выполнена;
			// возврат исходного состояния подтверждения в случае, если постановка в арбитраж была отклонена ГИСМ;
			// возврат исходного состояния подтверждения в случае, если постановка в арбитраж была отклонена покупателем;
			// возврат исходного состояния подтверждения в случае, если подтверждение постановки в арбитраж было отклонено нами и мы получили подтверждение от ГИСМ;
			// возврат исходного состояния подтверждения в случае, если снятие арбитража было подтверждено;
			// возврат исходного состояния подтверждения в случае, если подтверждение снятия арбитража было подтверждено;
			ТекущаяСтрока.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.ПустаяСсылка");
			Если ЭтоПрямаяСхемаАкцептования Тогда
				ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ПринятоГИСМ");
			Иначе
				ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтвердить");
			КонецЕсли;
			КоличествоУстановленныхСостоянийКПередаче = КоличествоУстановленныхСостоянийКПередаче + 1;
			
		ИначеЕсли ПодтверждениеПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.КПередаче")
			  Или ПодтверждениеПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ПодтвердитьОтклоненоГИСМ")
			  Или ПодтверждениеПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Отказаться")
			  Или ПодтверждениеПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтказатьсяОтклоненоГИСМ")
			  Или ПодтверждениеСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.КПередаче")
			  Или ПодтверждениеСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ПодтвердитьОтклоненоГИСМ")
			  Или ПодтверждениеСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Отказаться")
			  Или ПодтверждениеСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтказатьсяОтклоненоГИСМ") Тогда
			
			// Возврат исходного состояния подтверждения в случае, если подтверждение постановки в арбитраж еще не было выполнено;
			// возврат исходного состояния подтверждения в случае, если подтверждение постановки в арбитраж было отклонено ГИСМ;
			// Возврат исходного состояния подтверждения в случае, если отказ от подтверждения постановки в арбитраж еще не был выполнен;
			// Возврат исходного состояния подтверждения в случае, если отказ от подтверждения постановки в арбитраж был отклонен ГИСМ;
			// Возврат исходного состояния подтверждения в случае, если подтверждение снятия арбитража еще не было выполнено;
			// возврат исходного состояния подтверждения в случае, если подтверждение снятия арбитража было отклонено ГИСМ;
			// Возврат исходного состояния подтверждения в случае, если отказ от подтверждения снятия арбитража еще не был выполнен;
			// Возврат исходного состояния подтверждения в случае, если отказ от подтверждения снятия арбитража был отклонен ГИСМ;
			// Примечание. Отозвать, принятое ГИСМ, подтверждение о постановке в арбитраж - нельзя.
			// Примечание. Отозвать, принятое ГИСМ, подтверждение о снятии арбитража - нельзя.
			ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтвердить");
			КоличествоУстановленныхСостоянийКПередаче = КоличествоУстановленныхСостоянийКПередаче + 1;
			
		ИначеЕсли ИнициацияСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.КПередаче")
			  Или ИнициацияСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоГИСМ")
			  Или ИнициацияСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоПокупателем") Тогда
			
			// Исходного состояния, при этой ситуации нет, т.к. можно только повторно инициировать снятие арбитража.
			
		ИначеЕсли ИнициацияПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Отказаться")
			  Или ИнициацияПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтказатьсяОтклоненоГИСМ")
			  Или ИнициацияСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Отказаться")
			  Или ИнициацияСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтказатьсяОтклоненоГИСМ") Тогда
			
			// Инициировавший постановку или снятие арбитража не может отказаться от операции.
			
		ИначеЕсли ИнициацияПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтверждено")
			  Или ПодтверждениеПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтверждено") Тогда
			
			// Исходное состояние уже установлено.
			
		КонецЕсли;
		
	КонецЦикла;
	
	Для Каждого ТекущаяСтрока Из Объект.ТранспортныеУпаковки Цикл
		
		АрбитражНеУстановлен             = ТекущаяСтрока.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.ПустаяСсылка");
		ИнициацияПостановкиВАрбитраж     = ТекущаяСтрока.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.УстановленПередача");
		ИнициацияСнятияАрбитража         = ТекущаяСтрока.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.СнятПередача");
		ПодтверждениеПостановкиВАрбитраж = ТекущаяСтрока.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.УстановленПолучение");
		ПодтверждениеСнятияАрбитража     = ТекущаяСтрока.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.СнятПолучение");
		
		Если Не ЗначениеЗаполнено(ТекущаяСтрока.СостояниеПодтверждения)
		 Или АрбитражНеУстановлен И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоГИСМ")
		 Или АрбитражНеУстановлен И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ПодтвердитьОтклоненоГИСМ")
		 Или АрбитражНеУстановлен И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Отозвать")
		 Или АрбитражНеУстановлен И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтозватьОтклоненоГИСМ") Тогда
			
			// Передач еще не было;
			// Возврат исходного состояния подтверждения в случае, если передача товаров была отклонена ГИСМ;
			// Возврат исходного состояния подтверждения в случае, если подтверждение передачи товаров было отклонена ГИСМ.
			// Возврат исходного состояния подтверждения в случае, если отзыв передачи товаров или подтверждение отгрузки товаров еще не были выполнены;
			// Возврат исходного состояния подтверждения в случае, если отзыв передачи товаров или подтверждение отгрузки товаров был отклонен ГИСМ;
			
			Если ЭтоПрямаяСхемаАкцептования Тогда
				ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.КПередаче");
			Иначе
				ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтвердить");
			КонецЕсли;
			КоличествоУстановленныхСостоянийКПередаче = КоличествоУстановленныхСостоянийКПередаче + 1;
			
		ИначеЕсли ИнициацияПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.КПередаче")
			  Или ИнициацияПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоГИСМ")
			  Или ИнициацияПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоПокупателем")
			  Или ПодтверждениеПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоПоставщиком")
			  Или ИнициацияСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтверждено")
			  Или ПодтверждениеСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтверждено") Тогда
			
			// Возврат исходного состояния подтверждения в случае, если постановка в арбитраж еще не была выполнена;
			// возврат исходного состояния подтверждения в случае, если постановка в арбитраж была отклонена ГИСМ;
			// возврат исходного состояния подтверждения в случае, если постановка в арбитраж была отклонена покупателем;
			// возврат исходного состояния подтверждения в случае, если подтверждение постановки в арбитраж было отклонено нами и получили подтверждение от ГИСМ;
			// возврат исходного состояния подтверждения в случае, если снятие арбитража было подтверждено;
			// возврат исходного состояния подтверждения в случае, если подтверждение снятия арбитража было подтверждено;
			ТекущаяСтрока.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.ПустаяСсылка");
			Если ЭтоПрямаяСхемаАкцептования Тогда
				ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ПринятоГИСМ");
			Иначе
				ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтвердить");
			КонецЕсли;
			КоличествоУстановленныхСостоянийКПередаче = КоличествоУстановленныхСостоянийКПередаче + 1;
			
		ИначеЕсли ПодтверждениеПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.КПередаче")
			  Или ПодтверждениеПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ПодтвердитьОтклоненоГИСМ")
			  Или ПодтверждениеПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Отказаться")
			  Или ПодтверждениеПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтказатьсяОтклоненоГИСМ")
			  Или ПодтверждениеСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.КПередаче")
			  Или ПодтверждениеСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ПодтвердитьОтклоненоГИСМ")
			  Или ПодтверждениеСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Отказаться")
			  Или ПодтверждениеСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтказатьсяОтклоненоГИСМ") Тогда
			
			// Возврат исходного состояния подтверждения в случае, если подтверждение постановки в арбитраж еще не было выполнено;
			// возврат исходного состояния подтверждения в случае, если подтверждение постановки в арбитраж было отклонено ГИСМ;
			// Возврат исходного состояния подтверждения в случае, если отказ от подтверждения постановки в арбитраж еще не был выполнен;
			// Возврат исходного состояния подтверждения в случае, если отказ от подтверждения постановки в арбитраж был отклонен ГИСМ;
			// Возврат исходного состояния подтверждения в случае, если подтверждение снятия арбитража еще не было выполнено;
			// возврат исходного состояния подтверждения в случае, если подтверждение снятия арбитража было отклонено ГИСМ;
			// Возврат исходного состояния подтверждения в случае, если отказ от подтверждения снятия арбитража еще не был выполнен;
			// Возврат исходного состояния подтверждения в случае, если отказ от подтверждения снятия арбитража был отклонен ГИСМ;
			// Примечание. Отозвать, принятое ГИСМ, подтверждение о постановке в арбитраж - нельзя.
			// Примечание. Отозвать, принятое ГИСМ, подтверждение о снятии арбитража - нельзя.
			ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтвердить");
			КоличествоУстановленныхСостоянийКПередаче = КоличествоУстановленныхСостоянийКПередаче + 1;
			
		ИначеЕсли ИнициацияСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.КПередаче")
			  Или ИнициацияСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоГИСМ")
			  Или ИнициацияСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоПокупателем") Тогда
			
			// Исходного состояния, при этой ситуации нет, т.к. можно только повторно инициировать снятие арбитража.
			
		ИначеЕсли ИнициацияПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Отказаться")
			  Или ИнициацияПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтказатьсяОтклоненоГИСМ")
			  Или ИнициацияСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Отказаться")
			  Или ИнициацияСнятияАрбитража И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтказатьсяОтклоненоГИСМ") Тогда
			
			// Инициировавший постановку или снятие арбитража не может отказаться от операции.
			
		ИначеЕсли ИнициацияПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтверждено")
			  Или ПодтверждениеПостановкиВАрбитраж И ТекущаяСтрока.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтверждено") Тогда
			
			// Исходное состояние уже установлено.
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если КоличествоУстановленныхСостоянийКПередаче > 0 Тогда
		ОбновитьПредставленияСостоянияПодтвержденияУпаковок(Объект);
		ТекстОповещения = НСтр("ru = 'Отмечено к передаче %1 из %2 строк'");
		ТекстОповещения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			ТекстОповещения, КоличествоУстановленныхСостоянийКПередаче, КоличествоСтрок);
	Иначе
		ТекстОповещения = НСтр("ru = 'Отсутствуют неотработанные строки или строки с состоянием ""Отклонено ГИСМ""'");
	КонецЕсли;
	
	ТекстЗаголовка = НСтр("ru = 'Отметка к передаче'");
	ПоказатьОповещениеПользователя(ТекстЗаголовка,, ТекстОповещения, БиблиотекаКартинок.Информация32);
	
КонецПроцедуры

&НаКлиенте
Процедура УстановитьОтборПоСостояниюПодтверждения(Команда)
	
	СостояниеПодтверждения = Сред(Команда.Имя, СтрДлина("Отбор") + 1);
	ИнтеграцияМДЛПКлиент.УстановитьОтборПоСостояниюПодтверждения(ЭтотОбъект, "НомераУпаковок, ТранспортныеУпаковки", СостояниеПодтверждения, Команда);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтозватьВыделенныеУпаковки(Команда)
	
	ОтозватьВыделенныеСтроки(Элементы.НомераУпаковок);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтозватьВыделенныеТранспортныеУпаковки(Команда)
	
	ОтозватьВыделенныеСтроки(Элементы.ТранспортныеУпаковки);
	
КонецПроцедуры

&НаКлиенте
Процедура ПостановитьВАрбитражВыделенныеУпаковки(Команда)
	
	ПостановитьВАрбитражСтроки(Элементы.НомераУпаковок);
	
КонецПроцедуры

&НаКлиенте
Процедура ПостановитьВАрбитражВыделенныеТранспортныеУпаковки(Команда)
	
	ПостановитьВАрбитражСтроки(Элементы.ТранспортныеУпаковки);
	
КонецПроцедуры

&НаКлиенте
Процедура СнятьАрбитражВыделенныхУпаковок(Команда)
	
	СнятьАрбитражСтроки(Элементы.НомераУпаковок);
	
КонецПроцедуры

&НаКлиенте
Процедура СнятьАрбитражВыделенныхТранспортныхУпаковок(Команда)
	
	СнятьАрбитражСтроки(Элементы.ТранспортныеУпаковки);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтказатьсяОтПостановкиСнятияАрбитражаУпаковок(Команда)
	
	ОтказатьсяОтПостановкиСнятияАрбитражаСтроки(Элементы.НомераУпаковок);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтказатьсяОтПостановкиСнятияАрбитражаТранспортныхУпаковок(Команда)
	
	ОтказатьсяОтПостановкиСнятияАрбитражаСтроки(Элементы.ТранспортныеУпаковки);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьДанныеИзТСД(Команда)
	
	ОчиститьСообщения();
	
	Если ОбщегоНазначенияКлиент.ПодсистемаСуществует("ПоддержкаОборудования.ПодключаемоеОборудование.ТерминалыСбораДанных") Тогда
		МодульОборудованиеТерминалыСбораДанныхКлиент = ОбщегоНазначенияКлиент.ОбщийМодуль("ОборудованиеТерминалыСбораДанныхКлиент");
		МодульОборудованиеТерминалыСбораДанныхКлиент.НачатьЗагрузкуДанныеИзТСД(
			Новый ОписаниеОповещения("ЗагрузитьИзТСДЗавершение", ЭтотОбъект),
			УникальныйИдентификатор);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗапроситьИнформациюОКиЗ(Команда)
	
	ЗапроситьИнформациюОбУпаковках();
	
КонецПроцедуры

&НаКлиенте
Процедура ЗапроситьИнформациюОВыделенныхПотребительскихУпаковках(Команда)
	
	Отбор = Новый Массив;
	Отбор.Добавить(Новый Структура("Поле, Значение", "Организация", Объект.Организация));
	Отбор.Добавить(Новый Структура("Поле, Значение", "МестоДеятельности", Объект.МестоДеятельности));
	
	ДоступныйТранспорт = ТранспортМДЛПВызовСервера.ДоступныеТранспортныеМодули(Отбор);
	Если ДоступныйТранспорт.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Элемент = Элементы.НомераУпаковок;
	Если Элемент.ВыделенныеСтроки.Количество() = 0 Тогда
		ТекстСообщения = НСтр("ru = 'Нет строк для получения информации.'");
		ПоказатьПредупреждение(, ТекстСообщения);
		Возврат;
	КонецЕсли;
	
	ДанныеВыделенныхСтрок = Новый Массив;
	Для Каждого ТекущаяСтрока Из Элемент.ВыделенныеСтроки Цикл
		ТекущиеДанные = Элемент.ДанныеСтроки(ТекущаяСтрока);
		ДанныеВыделенныхСтрок.Добавить(ТекущиеДанные);
	КонецЦикла;
	
	ЗапроситьИнформациюОПотребительскихУпаковках(ДоступныйТранспорт[0].ПараметрыПодключения, ДанныеВыделенныхСтрок);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗапроситьИнформациюОВыделенныхТранспортныхУпаковках(Команда)
	
	Отбор = Новый Массив;
	Отбор.Добавить(Новый Структура("Поле, Значение", "Организация", Объект.Организация));
	Отбор.Добавить(Новый Структура("Поле, Значение", "МестоДеятельности", Объект.МестоДеятельности));
	
	ДоступныйТранспорт = ТранспортМДЛПВызовСервера.ДоступныеТранспортныеМодули(Отбор);
	Если ДоступныйТранспорт.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Элемент = Элементы.ТранспортныеУпаковки;
	Если Элемент.ВыделенныеСтроки.Количество() = 0 Тогда
		ТекстСообщения = НСтр("ru = 'Нет строк для получения информации.'");
		ПоказатьПредупреждение(, ТекстСообщения);
		Возврат;
	КонецЕсли;
	
	ДанныеВыделенныхСтрок = Новый Массив;
	Для Каждого ТекущаяСтрока Из Элемент.ВыделенныеСтроки Цикл
		ТекущиеДанные = Элемент.ДанныеСтроки(ТекущаяСтрока);
		ДанныеВыделенныхСтрок.Добавить(ТекущиеДанные);
	КонецЦикла;
	
	ЗапроситьИнформациюОТранспортныхУпаковках(ДоступныйТранспорт[0].ПараметрыПодключения, ДанныеВыделенныхСтрок);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтменитьЗапросИнформацииОКиЗ(Команда)
	
	ОтменитьЗапросИнформацииОбУпаковках();
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ВыполнитьПереопределяемуюКоманду(Команда)
	
	СобытияФормМДЛПКлиентПереопределяемый.ВыполнитьПереопределяемуюКоманду(ЭтотОбъект, Команда);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ПриСозданииЧтенииНаСервере()
	
	ГосударственныеИнформационныеСистемыПереопределяемый.ЗаполнитьСлужебныеРеквизитыВКоллекции(ЭтотОбъект, Объект.Товары);
	ГосударственныеИнформационныеСистемыПереопределяемый.ЗаполнитьСлужебныеРеквизитыВКоллекции(ЭтотОбъект, Объект.СоставТранспортныхУпаковок);
	
	ПараметрыУказанияСерий = ГосударственныеИнформационныеСистемыПереопределяемый.ПараметрыУказанияСерийФормыОбъекта(Объект, ОбщегоНазначения.МенеджерОбъектаПоСсылке(Объект.Ссылка));
	
	ОбновитьСтатусУведомления();
	ОбновитьПредставленияСостоянияПодтвержденияУпаковок(Объект);
	ОбновитьСтатусыЗаполненияНомеровУпаковок(Объект);
	
	КонтрагентФизическоеЛицо = Объект.КонтрагентФизическоеЛицо;
	
	ДоступноОснование = ИнтеграцияМДЛП.ДоступноОснованиеУведомления(Объект.Ссылка);
	Если Объект.СхемаАкцептования = Перечисления.СхемыАкцептованияМДЛП.ОбратныйПорядок Тогда
		Элементы.ОснованиеПредставление.Видимость = Ложь;
		Элементы.Основание.Видимость = ДоступноОснование;
		Элементы.ИдентификаторОрганизации.Видимость = Истина;
		Элементы.ИдентификаторКонтрагента.Видимость = Истина;
	Иначе
		Элементы.ОснованиеПредставление.Видимость = ДоступноОснование;
		Элементы.Основание.Видимость = Ложь;
		Элементы.ИдентификаторОрганизации.Видимость = Ложь;
		Элементы.ИдентификаторКонтрагента.Видимость = Ложь;
	КонецЕсли;
	
	УстановитьВидимостьЭлементовПоОперации();
	
КонецПроцедуры

&НаСервере
Процедура УстановитьУсловноеОформление()
	
	ГосударственныеИнформационныеСистемыПереопределяемый.УстановитьУсловноеОформлениеЕдиницИзмерения(ЭтотОбъект);
	ГосударственныеИнформационныеСистемыПереопределяемый.УстановитьУсловноеОформлениеХарактеристикНоменклатуры(ЭтотОбъект);
	ГосударственныеИнформационныеСистемыПереопределяемый.УстановитьУсловноеОформлениеХарактеристикНоменклатуры(
		ЭтотОбъект, Элементы.СоставТранспортныхУпаковокХарактеристика.Имя, "Объект.СоставТранспортныхУпаковок.ХарактеристикиИспользуются");
	ГосударственныеИнформационныеСистемыПереопределяемый.УстановитьУсловноеОформлениеСерийНоменклатуры(ЭтотОбъект);
	ГосударственныеИнформационныеСистемыПереопределяемый.УстановитьУсловноеОформлениеСерийНоменклатуры(ЭтотОбъект,
		Элементы.СоставТранспортныхУпаковокСерия.Имя, "Объект.СоставТранспортныхУпаковок.СтатусУказанияСерий", "Объект.СоставТранспортныхУпаковок.ТипНоменклатуры");
	
	ИнтеграцияМДЛП.УстановитьУсловноеОформлениеСостоянияПодтверждения(ЭтотОбъект);
	
	//
	Элемент = УсловноеОформление.Элементы.Добавить();
	Элемент.Поля.Элементы.Добавить().Поле = Новый ПолеКомпоновкиДанных(Элементы.НомераУпаковок.Имя);
	
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбора(Элемент.Отбор,
		"Объект.НомераУпаковок.ИдентификаторСтроки", Новый ПолеКомпоновкиДанных("ИдентификаторТекущейСтроки"), ВидСравненияКомпоновкиДанных.НеРавно);
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ЦветТекстаНеТребуетВниманияМДЛП);
	
	//
	Элемент = УсловноеОформление.Элементы.Добавить();
	Элемент.Поля.Элементы.Добавить().Поле = Новый ПолеКомпоновкиДанных(Элементы.ТоварыСумма.Имя);
	Элемент.Поля.Элементы.Добавить().Поле = Новый ПолеКомпоновкиДанных(Элементы.СоставТранспортныхУпаковокЦена.Имя);
	
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбора(Элемент.Отбор,
		"Объект.ТипДоговора", Перечисления.ТипыДоговоровМДЛП.ПередачаНаБезвозмезднойОснове);
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ОтметкаНезаполненного", Ложь);
	
#Область СостояниеПолученияИнформации
	
	ДанныеЗапрошены = Новый СписокЗначений;
	ДанныеЗапрошены.Добавить(Перечисления.СостоянияПодтвержденияМДЛП.КПередаче);
	ДанныеЗапрошены.Добавить(Перечисления.СостоянияПодтвержденияМДЛП.Передано);
	
	НетДанных = Новый СписокЗначений;
	НетДанных.Добавить(Перечисления.СостоянияПодтвержденияМДЛП.ПустаяСсылка());
	НетДанных.Добавить(Перечисления.СостоянияПодтвержденияМДЛП.ОтклоненоГИСМ);
	
#Область НомераУпаковок
	
	//
	Элемент = УсловноеОформление.Элементы.Добавить();
	Элемент.Поля.Элементы.Добавить().Поле = Новый ПолеКомпоновкиДанных(Элементы.НомераУпаковокСтатус.Имя);
	
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбора(Элемент.Отбор,
		"Объект.НомераУпаковок.СостояниеПолученияИнформации", Перечисления.СостоянияПодтвержденияМДЛП.ПустаяСсылка());
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ЦветТекстаНеТребуетВниманияМДЛП);
	Элемент.Оформление.УстановитьЗначениеПараметра("Текст", НСтр("ru = '<данные не запрашивались>'"));
	
	//
	Элемент = УсловноеОформление.Элементы.Добавить();
	Элемент.Поля.Элементы.Добавить().Поле = Новый ПолеКомпоновкиДанных(Элементы.НомераУпаковокСтатус.Имя);
	
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбора(Элемент.Отбор,
		"Объект.НомераУпаковок.СостояниеПолученияИнформации", ДанныеЗапрошены, ВидСравненияКомпоновкиДанных.ВСписке);
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ЦветТекстаНеТребуетВниманияМДЛП);
	Элемент.Оформление.УстановитьЗначениеПараметра("Текст", НСтр("ru = '<сформирован запрос>'"));
	
	//
	Элемент = УсловноеОформление.Элементы.Добавить();
	Элемент.Поля.Элементы.Добавить().Поле = Новый ПолеКомпоновкиДанных(Элементы.НомераУпаковокНомерУпаковки.Имя);
	
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбора(Элемент.Отбор,
		"Объект.НомераУпаковок.СостояниеПолученияИнформации", НетДанных, ВидСравненияКомпоновкиДанных.НеВСписке);
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	//
	Элемент = УсловноеОформление.Элементы.Добавить();
	Элемент.Поля.Элементы.Добавить().Поле = Новый ПолеКомпоновкиДанных(Элементы.НомераУпаковокСтатус.Имя);
	
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбора(Элемент.Отбор,
		"Объект.НомераУпаковок.СостояниеПолученияИнформации", Перечисления.СостоянияПодтвержденияМДЛП.ОтклоненоГИСМ);
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ЦветТекстаТребуетВниманияМДЛП);
	
#КонецОбласти
	
#Область ТранспортныеУпаковки
	
	// 
	Элемент = УсловноеОформление.Элементы.Добавить();
	Элемент.Поля.Элементы.Добавить().Поле = Новый ПолеКомпоновкиДанных(Элементы.ТранспортныеУпаковкиСтатус.Имя);
	
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбора(Элемент.Отбор,
		"Объект.ТранспортныеУпаковки.СостояниеПолученияИнформации", Перечисления.СостоянияПодтвержденияМДЛП.ПустаяСсылка());
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ЦветТекстаНеТребуетВниманияМДЛП);
	Элемент.Оформление.УстановитьЗначениеПараметра("Текст", НСтр("ru = '<данные не запрашивались>'"));
	
	//
	Элемент = УсловноеОформление.Элементы.Добавить();
	Элемент.Поля.Элементы.Добавить().Поле = Новый ПолеКомпоновкиДанных(Элементы.ТранспортныеУпаковкиСтатус.Имя);
	
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбора(Элемент.Отбор,
		"Объект.ТранспортныеУпаковки.СостояниеПолученияИнформации", ДанныеЗапрошены, ВидСравненияКомпоновкиДанных.ВСписке);
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ЦветТекстаНеТребуетВниманияМДЛП);
	Элемент.Оформление.УстановитьЗначениеПараметра("Текст", НСтр("ru = '<сформирован запрос>'"));
	
	//
	Элемент = УсловноеОформление.Элементы.Добавить();
	Элемент.Поля.Элементы.Добавить().Поле = Новый ПолеКомпоновкиДанных(Элементы.ТранспортныеУпаковкиНомерУпаковки.Имя);
	
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбора(Элемент.Отбор,
		"Объект.ТранспортныеУпаковки.СостояниеПолученияИнформации", НетДанных, ВидСравненияКомпоновкиДанных.НеВСписке);
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	//
	Элемент = УсловноеОформление.Элементы.Добавить();
	Элемент.Поля.Элементы.Добавить().Поле = Новый ПолеКомпоновкиДанных(Элементы.ТранспортныеУпаковкиСтатус.Имя);
	
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбора(Элемент.Отбор,
		"Объект.ТранспортныеУпаковки.СостояниеПолученияИнформации", Перечисления.СостоянияПодтвержденияМДЛП.ОтклоненоГИСМ);
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ЦветТекстаТребуетВниманияМДЛП);
	
#КонецОбласти
	
#КонецОбласти

КонецПроцедуры

&НаСервере
Процедура УстановитьВидимостьЭлементовПоОперации()
	
	ВсеРеквизиты = Неопределено;
	РеквизитыОперации = Неопределено;
	Документы.УведомлениеОбОтгрузкеМДЛП.ЗаполнитьИменаРеквизитовПоТипуОперации(Объект.Операция, ВсеРеквизиты, РеквизитыОперации);
	
	Для Каждого Реквизит Из ВсеРеквизиты Цикл
		ВидимостьРеквизита = РеквизитыОперации.Найти(Реквизит) <> Неопределено;
		ИмяЭлемента = Элементы[СтрЗаменить(Реквизит, ".", "")].Имя;
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, ИмяЭлемента, "Видимость", ВидимостьРеквизита);
	КонецЦикла;
	
	Элементы.КонтрагентНеЗарегистрированВГИСМ.Видимость =
		(Объект.Операция = Перечисления.ОперацииОтгрузкиМДЛП.Продажа
		И Объект.СхемаАкцептования = Перечисления.СхемыАкцептованияМДЛП.ПрямойПорядок);
	УстановитьВидимостьРеквизитовКонтрагента();
	
	ЭтоВывозВЕАЭС = Объект.Операция = Перечисления.ОперацииОтгрузкиМДЛП.ВывозВЕАЭС;
	Если ЭтоВывозВЕАЭС Тогда
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, Элементы.Контрагент.Имя, "Видимость", Истина);
	КонецЕсли;
	
	Если Объект.Операция = Перечисления.ОперацииОтгрузкиМДЛП.ПередачаСобственникуВРамкахГЛО И Элементы.ТипОперации.Видимость Тогда
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, Элементы.ТипОперации.Имя, "АвтоОтметкаНезаполненного", Ложь);
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, Элементы.ТипОперации.Имя, "ОтметкаНезаполненного", Ложь);
	Иначе
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, Элементы.ТипОперации.Имя, "АвтоОтметкаНезаполненного", Неопределено);
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, Элементы.ТипОперации.Имя, "ОтметкаНезаполненного", Истина);
	КонецЕсли;
	
	ВерсияСхемОбмена = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Объект.Организация, "ВерсияСхемОбмена");
	ВозможнаПостановкаВАрбитраж = Документы.УведомлениеОбОтгрузкеМДЛП.ВозможнаПостановкаВАрбитраж(Объект.Операция, ВерсияСхемОбмена);
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, Элементы.НомераУпаковокКонтекстноеМенюПостановитьВАрбитражВыделенныеУпаковки.Имя, "Видимость", ВозможнаПостановкаВАрбитраж);
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, Элементы.НомераУпаковокКонтекстноеМенюСнятьАрбитражВыделенныхУпаковок.Имя, "Видимость", ВозможнаПостановкаВАрбитраж);
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, Элементы.ТранспортныеУпаковкиКонтекстноеМенюПостановитьВАрбитражВыделенныеТранспортныеУпаковки.Имя, "Видимость", ВозможнаПостановкаВАрбитраж);
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, Элементы.ТранспортныеУпаковкиКонтекстноеМенюСнятьАрбитражВыделенныхТранспортныхУпаковок.Имя, "Видимость", ВозможнаПостановкаВАрбитраж);
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, Элементы.НомераУпаковокКонтекстноеМенюОтказатьсяОтПостановкиСнятияАрбитражаУпаковок.Имя, "Видимость", ВозможнаПостановкаВАрбитраж);
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, Элементы.ТранспортныеУпаковкиКонтекстноеМенюОтказатьсяОтПостановкиСнятияАрбитражаТранспортныхУпаковок.Имя, "Видимость", ВозможнаПостановкаВАрбитраж);
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьСтатусУведомления()
	
	ТекущийСтатус = ИнтеграцияМДЛП.ТекущийСтатусУведомления(Объект.Ссылка);
	СтатусМДЛП = ТекущийСтатус.Статус;
	СтатусПредставление = ИнтеграцияМДЛП.ПредставлениеСтатусаУведомления(ТекущийСтатус);
	РежимОтладки = ОбщегоНазначенияКлиентСервер.РежимОтладки();
	
	Если ЗначениеЗаполнено(ТекущийСтатус.ДальнейшееДействие)
	   И ТекущийСтатус.ДальнейшееДействие.Найти(Перечисления.ДальнейшиеДействияПоВзаимодействиюМДЛП.ПередайтеДанные) <> Неопределено Тогда
		РедактированиеФормыНедоступно = Ложь;
	Иначе
		РедактированиеФормыНедоступно = Не РежимОтладки;
	КонецЕсли;
	
	ИменаЭлементов = Новый Массив;
	ИменаЭлементов.Добавить(Элементы.ТоварыGTIN.Имя);
	ИменаЭлементов.Добавить(Элементы.ТоварыКоличествоУпаковок.Имя);
	ИменаЭлементов.Добавить(Элементы.ТоварыЦена.Имя);
	ИменаЭлементов.Добавить(Элементы.ТоварыСумма.Имя);
	ИменаЭлементов.Добавить(Элементы.ТоварыСуммаНДС.Имя);
	ИменаЭлементов.Добавить(Элементы.НомераУпаковок.Имя);
	ИменаЭлементов.Добавить(Элементы.ТранспортныеУпаковки.Имя);
	ИменаЭлементов.Добавить(Элементы.СоставТранспортныхУпаковокGTIN.Имя);
	ИменаЭлементов.Добавить(Элементы.СоставТранспортныхУпаковокНомерСерии.Имя);
	ИменаЭлементов.Добавить(Элементы.СоставТранспортныхУпаковокЦена.Имя);
	ИменаЭлементов.Добавить(Элементы.СоставТранспортныхУпаковокСуммаНДС.Имя);
	ИменаЭлементов.Добавить(Элементы.Операция.Имя);
	ИменаЭлементов.Добавить(Элементы.ТипОперации.Имя);
	ИменаЭлементов.Добавить(Элементы.НомерДокумента.Имя);
	ИменаЭлементов.Добавить(Элементы.ДатаДокумента.Имя);
	ИменаЭлементов.Добавить(Элементы.ТипДоговора.Имя);
	ИменаЭлементов.Добавить(Элементы.НомерКонтракта.Имя);
	ИменаЭлементов.Добавить(Элементы.ИсточникФинансирования.Имя);
	ИменаЭлементов.Добавить(Элементы.НомерГосударственногоКонтракта.Имя);
	ИменаЭлементов.Добавить(Элементы.ДатаГосударственногоКонтракта.Имя);
	
	ИменаЭлементов.Добавить(Элементы.КонтрагентНеЗарегистрированВГИСМ.Имя);
	ИменаЭлементов.Добавить(Элементы.Контрагент.Имя);
	ИменаЭлементов.Добавить(Элементы.КонтрагентФизическоеЛицо.Имя);
	ИменаЭлементов.Добавить(Элементы.КонтрагентИННФизЛицо.Имя);
	ИменаЭлементов.Добавить(Элементы.КонтрагентИНН.Имя);
	ИменаЭлементов.Добавить(Элементы.КонтрагентКПП.Имя);
	ИменаЭлементов.Добавить(Элементы.АдресСкладаКонтрагента.Имя);
	ИменаЭлементов.Добавить(Элементы.ИдентификаторАдресногоОбъекта.Имя);
	ИменаЭлементов.Добавить(Элементы.ИдентификаторДома.Имя);
	ИменаЭлементов.Добавить(Элементы.Помещение.Имя);
	
	Если Объект.СхемаАкцептования = Перечисления.СхемыАкцептованияМДЛП.ОбратныйПорядок Тогда
		Если ТекущийСтатус.Статус <> Перечисления.СтатусыИнформированияМДЛП.ПринятоИзМДЛП Тогда
			ИменаЭлементов.Добавить(Элементы.Организация.Имя);
			ИменаЭлементов.Добавить(Элементы.МестоДеятельности.Имя);
			ИменаЭлементов.Добавить(Элементы.Грузополучатель.Имя);
			ИменаЭлементов.Добавить(Элементы.МестоДеятельностиГрузополучателя.Имя);
		КонецЕсли;
		
		Элементы.Товары.ИзменятьСоставСтрок = Ложь;
		Элементы.СоставТранспортныхУпаковок.ИзменятьСоставСтрок = Ложь;
		Для Каждого ИмяЭлемента Из ИменаЭлементов Цикл
			ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, ИмяЭлемента, "ТолькоПросмотр", Не РежимОтладки);
		КонецЦикла;
	Иначе
		ИменаЭлементов.Добавить(Элементы.Организация.Имя);
		ИменаЭлементов.Добавить(Элементы.МестоДеятельности.Имя);
		ИменаЭлементов.Добавить(Элементы.Грузополучатель.Имя);
		ИменаЭлементов.Добавить(Элементы.МестоДеятельностиГрузополучателя.Имя);
		
		Элементы.Товары.ИзменятьСоставСтрок = Не РедактированиеФормыНедоступно;
		Элементы.СоставТранспортныхУпаковок.ИзменятьСоставСтрок = Не РедактированиеФормыНедоступно;
		Для Каждого ИмяЭлемента Из ИменаЭлементов Цикл
			ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, ИмяЭлемента, "ТолькоПросмотр", РедактированиеФормыНедоступно);
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура ОбновитьПредставленияСостоянияПодтвержденияУпаковок(Объект)
	
	Для Каждого ТекущаяСтрока Из Объект.НомераУпаковок Цикл
		
		Если ЗначениеЗаполнено(ТекущаяСтрока.Арбитраж) Тогда
			ТекущаяСтрока.ПредставлениеСостоянияПодтверждения = СтрШаблон(НСтр("ru = '%1 (%2)'"), ТекущаяСтрока.Арбитраж, ТекущаяСтрока.СостояниеПодтверждения);
		Иначе
			ТекущаяСтрока.ПредставлениеСостоянияПодтверждения = ТекущаяСтрока.СостояниеПодтверждения;
		КонецЕсли;
		
	КонецЦикла;
	
	Для Каждого ТекущаяСтрока Из Объект.ТранспортныеУпаковки Цикл
		
		Если ЗначениеЗаполнено(ТекущаяСтрока.Арбитраж) Тогда
			ТекущаяСтрока.ПредставлениеСостоянияПодтверждения = СтрШаблон(НСтр("ru = '%1 (%2)'"), ТекущаяСтрока.Арбитраж, ТекущаяСтрока.СостояниеПодтверждения);
		Иначе
			ТекущаяСтрока.ПредставлениеСостоянияПодтверждения = ТекущаяСтрока.СостояниеПодтверждения;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура ОбновитьСтатусыЗаполненияНомеровУпаковок(Объект)
	
	Для Каждого СтрокаТЧ Из Объект.Товары Цикл
		
		ПараметрыОтбора = Новый Структура("ИдентификаторСтроки", СтрокаТЧ.ИдентификаторСтроки);
		СтрокиНомеров = Объект.НомераУпаковок.НайтиСтроки(ПараметрыОтбора);
		Если СтрокиНомеров.Количество() = СтрокаТЧ.Количество Тогда
			СтрокаТЧ.СтатусЗаполненияУпаковок = 1;
		Иначе
			СтрокаТЧ.СтатусЗаполненияУпаковок = 0;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьСтатусЗаполненияУпаковокВСтроке(ТекущиеДанные)
	
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ПараметрыОтбора = Новый Структура("ИдентификаторСтроки", ТекущиеДанные.ИдентификаторСтроки);
	СтрокиНомеров = Объект.НомераУпаковок.НайтиСтроки(ПараметрыОтбора);
	
	Если СтрокиНомеров.Количество() = ТекущиеДанные.Количество Тогда
		ТекущиеДанные.СтатусЗаполненияУпаковок = 1;
	Иначе
		ТекущиеДанные.СтатусЗаполненияУпаковок = 0;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура УстановитьОтборНомеровУпаковок(ИдентификаторСтроки)
	
	Если ИдентификаторТекущейСтроки <> ИдентификаторСтроки Тогда
		ИдентификаторТекущейСтроки = ИдентификаторСтроки;
	КонецЕсли;
	
	Если Не ПоказыватьВсеНомераУпаковок Тогда
		ИнтеграцияМДЛПКлиент.УстановитьОтборСтрок(
			Элементы.НомераУпаковок.ОтборСтрок,
			Новый Структура("ИдентификаторСтроки", ИдентификаторТекущейСтроки));
	Иначе
		ИнтеграцияМДЛПКлиент.СнятьОтборСтрок(Элементы.НомераУпаковок.ОтборСтрок, "ИдентификаторСтроки");
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОтозватьВыделенныеСтроки(Элемент)
	
	КоличествоСтрок = Элемент.ВыделенныеСтроки.Количество();
	Если КоличествоСтрок = 0 Тогда
		ТекстСообщения = НСтр("ru = 'Нет строк для отзыва.'");
		ПоказатьПредупреждение(, ТекстСообщения);
		Возврат;
	КонецЕсли;
	
	КоличествоУстановленныхСостоянийКОтзыву = 0;
	Для Каждого ТекущаяСтрока Из Элемент.ВыделенныеСтроки Цикл
		
		ДанныеСтроки = Элемент.ДанныеСтроки(ТекущаяСтрока);
		
		АрбитражНеУстановлен             = ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.ПустаяСсылка");
		ИнициацияПостановкиВАрбитраж     = ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.УстановленПередача");
		ИнициацияСнятияАрбитража         = ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.СнятПередача");
		ПодтверждениеПостановкиВАрбитраж = ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.УстановленПолучение");
		ПодтверждениеСнятияАрбитража     = ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.СнятПолучение");
		
		Если АрбитражНеУстановлен И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ПринятоГИСМ")
		 Или АрбитражНеУстановлен И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтвердить")
		 Или АрбитражНеУстановлен И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ПодтвердитьОтклоненоГИСМ")
		 Или АрбитражНеУстановлен И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтозватьОтклоненоГИСМ")
		 Или ИнициацияПостановкиВАрбитраж И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.КПередаче")
		 Или ИнициацияПостановкиВАрбитраж И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоГИСМ")
		 Или ИнициацияПостановкиВАрбитраж И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоПокупателем")
		 Или ПодтверждениеПостановкиВАрбитраж И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоПоставщиком")
		 Или ИнициацияСнятияАрбитража И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтверждено")
		 Или ПодтверждениеСнятияАрбитража И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтверждено") Тогда
			
			// Отзывать товары можно если
			// информация об отгрузке была принята ГИСМ
			// или нужно подтвердить отгрузку товаров
			// или подтверждение отгрузки было отклонено ГИСМ
			// или сам отзыв товаров был отклонен ГИСМ
			// или инициация постановки в арбитраж еще не была выполнена
			// или инициация постановки в арбитраж была отклонена ГИСМ
			// или инициация постановки в арбитраж была отклонена покупателем
			// или подтверждение постановки в арбитраж было отклонено нами
			// или наша инициация снятия арбитража была подтверждена покупателем
			// или подтверждение снятия арбитража было подтверждено нами.
			
			ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.ПустаяСсылка");
			ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Отозвать");
			КоличествоУстановленныхСостоянийКОтзыву = КоличествоУстановленныхСостоянийКОтзыву + 1;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если КоличествоУстановленныхСостоянийКОтзыву > 0 Тогда
		ОбновитьПредставленияСостоянияПодтвержденияУпаковок(Объект);
		ТекстОповещения = НСтр("ru = 'Состояние ""Отозвать"" установлено для %1 из %2 строк'");
		ТекстОповещения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			ТекстОповещения, КоличествоУстановленныхСостоянийКОтзыву, КоличествоСтрок);
	Иначе
		ТекстОповещения = НСтр("ru = 'Отсутствуют строки которые можно отозвать'");
	КонецЕсли;
	
	ТекстЗаголовка  = НСтр("ru = 'Отозвать'");
	ПоказатьОповещениеПользователя(ТекстЗаголовка,, ТекстОповещения, БиблиотекаКартинок.Информация32);
	
КонецПроцедуры

&НаКлиенте
Процедура ПостановитьВАрбитражСтроки(Элемент)
	
	КоличествоСтрок = Элемент.ВыделенныеСтроки.Количество();
	Если КоличествоСтрок = 0 Тогда
		ТекстСообщения = НСтр("ru = 'Нет строк для постановки в арбитраж.'");
		ПоказатьПредупреждение(, ТекстСообщения);
		Возврат;
	КонецЕсли;
	
	КоличествоУстановленныхСостоянийКПостановкеВАрбитраж = 0;
	Для Каждого ТекущаяСтрока Из Элемент.ВыделенныеСтроки Цикл
		
		ДанныеСтроки = Элемент.ДанныеСтроки(ТекущаяСтрока);
		
		АрбитражНеУстановлен         = ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.ПустаяСсылка");
		ИнициацияПостановкиВАрбитраж = ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.УстановленПередача");
		ИнициацияСнятияАрбитража     = ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.СнятПередача");
		ПодтверждениеСнятияАрбитража = ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.СнятПолучение");
		
		Если АрбитражНеУстановлен И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтвердить")
		 Или АрбитражНеУстановлен И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ПодтвердитьОтклоненоГИСМ")
		 Или АрбитражНеУстановлен И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Отозвать")
		 Или АрбитражНеУстановлен И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтозватьОтклоненоГИСМ")
		 Или ИнициацияПостановкиВАрбитраж И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоГИСМ")
		 Или ИнициацияПостановкиВАрбитраж И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоПокупателем")
		 Или ИнициацияСнятияАрбитража И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтверждено")
		 Или ПодтверждениеСнятияАрбитража И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтверждено") Тогда
			
			// Инициировать постановку в арбитраж можно если арбитраж еще не был постановлен и
			// отгрузка была принята ГИСМ
			// или нужно подтвердить отгрузку
			// или подтверждение отгрузки было отклонено ГИСМ
			// или отзыв отгрузки еще не был выполнен
			// или отзыв отгрузки был отклонен ГИСМ.
			
			// Инициировать постановку в арбитраж можно повторно если постановка в арбитраж была инициирована, но
			// инициация была отклонена ГИСМ
			// или инициация была отклонена покупателем.
			// или наша инициация снятия арбитража была подтверждена покупателем
			// или подтверждение снятия арбитража было подтверждено нами.
			
			// Инициатор документооборота не должен быть также инициатором постановки в арбитраж,
			// т.к. на стороне подтверждения нельзя будет опраделить что подтверждается, приемка/отгрузка товаров или постановка в арбитраж.
			// АрбитражНеУстановлен И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ПринятоГИСМ")
			
			// Инициацию или подтверждение постановки или снятия арбитража можно только отклонить. Отзыв - не поддерживаем.
			// ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтозваноПоставщиком")
			
			ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.УстановленПередача");
			ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.КПередаче");
			КоличествоУстановленныхСостоянийКПостановкеВАрбитраж = КоличествоУстановленныхСостоянийКПостановкеВАрбитраж + 1;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если КоличествоУстановленныхСостоянийКПостановкеВАрбитраж > 0 Тогда
		ОбновитьПредставленияСостоянияПодтвержденияУпаковок(Объект);
		ТекстОповещения = НСтр("ru = 'Состояние ""Арбитраж"" установлено для %1 из %2 строк'");
		ТекстОповещения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			ТекстОповещения, КоличествоУстановленныхСостоянийКПостановкеВАрбитраж, КоличествоСтрок);
	Иначе
		ТекстОповещения = НСтр("ru = 'Отсутствуют строки которые можно постановить в арбитраж'");
	КонецЕсли;
	
	ТекстЗаголовка = НСтр("ru = 'Арбитраж'");
	ПоказатьОповещениеПользователя(ТекстЗаголовка,, ТекстОповещения, БиблиотекаКартинок.Информация32);
	
КонецПроцедуры

&НаКлиенте
Процедура СнятьАрбитражСтроки(Элемент)
	
	КоличествоСтрок = Элемент.ВыделенныеСтроки.Количество();
	Если КоличествоСтрок = 0 Тогда
		ТекстСообщения = НСтр("ru = 'Нет строк для снятия арбитража.'");
		ПоказатьПредупреждение(, ТекстСообщения);
		Возврат;
	КонецЕсли;
	
	КоличествоУстановленныхСостоянийКСнятиюАрбитража = 0;
	Для Каждого ТекущаяСтрока Из Элемент.ВыделенныеСтроки Цикл
		
		ДанныеСтроки = Элемент.ДанныеСтроки(ТекущаяСтрока);
		
		ИнициацияПостановкиВАрбитраж     = ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.УстановленПередача");
		ИнициацияСнятияАрбитража         = ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.СнятПередача");
		ПодтверждениеПостановкиВАрбитраж = ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.УстановленПолучение");
		ПодтверждениеСнятияАрбитража     = ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.СнятПолучение");
		
		Если ИнициацияПостановкиВАрбитраж И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтверждено")
		 Или ПодтверждениеПостановкиВАрбитраж И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтверждено")
		 Или ИнициацияСнятияАрбитража И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоГИСМ")
		 Или ИнициацияСнятияАрбитража И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоПокупателем")
		 Или ПодтверждениеСнятияАрбитража И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтклоненоПоставщиком") Тогда
			
			// Инициировать снятие арбитража можно если арбитраж постановлен и подтвержден.
			// Инициировать снятие арбитража можно повторно если снятие арбитража было инициировано, но
			// инициация снятия арбитража была отклонена ГИСМ
			// или инициация снятия арбитража была отклонена покупателем
			// или подтверждение снятия арбитража было отклонено нами.
			
			// Инициацию или подтверждение постановки или снятия арбитража можно только отклонить. Отзыв - не поддерживаем.
			// ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтозваноПоставщиком")
			
			ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.СнятПередача");
			ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.КПередаче");
			КоличествоУстановленныхСостоянийКСнятиюАрбитража = КоличествоУстановленныхСостоянийКСнятиюАрбитража + 1;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если КоличествоУстановленныхСостоянийКСнятиюАрбитража > 0 Тогда
		ОбновитьПредставленияСостоянияПодтвержденияУпаковок(Объект);
		ТекстОповещения = НСтр("ru = 'Состояние ""Арбитраж"" снято для %1 из %2 строк'");
		ТекстОповещения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			ТекстОповещения, КоличествоУстановленныхСостоянийКСнятиюАрбитража, КоличествоСтрок);
	Иначе
		ТекстОповещения = НСтр("ru = 'Отсутствуют строки которым можно снять арбитраж'");
	КонецЕсли;
	
	ТекстЗаголовка = НСтр("ru = 'Арбитраж'");
	ПоказатьОповещениеПользователя(ТекстЗаголовка,, ТекстОповещения, БиблиотекаКартинок.Информация32);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтказатьсяОтПостановкиСнятияАрбитражаСтроки(Элемент)
	
	КоличествоСтрок = Элемент.ВыделенныеСтроки.Количество();
	Если КоличествоСтрок = 0 Тогда
		ТекстСообщения = НСтр("ru = 'Нет строк для отказа.'");
		ПоказатьПредупреждение(, ТекстСообщения);
		Возврат;
	КонецЕсли;
	
	КоличествоУстановленныхСостоянийКОтказу = 0;
	Для Каждого ТекущаяСтрока Из Элемент.ВыделенныеСтроки Цикл
		
		ДанныеСтроки = Элемент.ДанныеСтроки(ТекущаяСтрока);
		
		ПодтверждениеПостановкиВАрбитраж = ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.УстановленПолучение");
		ПодтверждениеСнятияАрбитража     = ДанныеСтроки.Арбитраж = ПредопределенноеЗначение("Перечисление.СостоянияАрбитражаМДЛП.СнятПолучение");
		
		Если ПодтверждениеПостановкиВАрбитраж И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтвердить")
		  Или ПодтверждениеПостановкиВАрбитраж И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ПодтвердитьОтклоненоГИСМ")
		  Или ПодтверждениеПостановкиВАрбитраж И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтказатьсяОтклоненоГИСМ")
		  Или ПодтверждениеСнятияАрбитража И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Подтвердить")
		  Или ПодтверждениеСнятияАрбитража И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ПодтвердитьОтклоненоГИСМ")
		  Или ПодтверждениеСнятияАрбитража И ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.ОтказатьсяОтклоненоГИСМ") Тогда
			
			// Отказаться от подтверждения постановки в арбитраж можно если
			// нужно подтвердить постановку в арбитраж
			// или подтверждение постановки в арбитраж было отклонено ГИСМ
			// или сам отказ от подтверждения постановки в арбитраж был отклонен ГИСМ.
			
			// Отозвать подтверждение снятия арбитража можно если
			// нужно подтвердить снятие арбитраж
			// или подтверждение снятия арбитража было отклонено ГИСМ.
			// или сам отказ от подтверждения снятия арбитража был отклонен ГИСМ.
			
			ДанныеСтроки.СостояниеПодтверждения = ПредопределенноеЗначение("Перечисление.СостоянияПодтвержденияМДЛП.Отказаться");
			КоличествоУстановленныхСостоянийКОтказу = КоличествоУстановленныхСостоянийКОтказу + 1;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если КоличествоУстановленныхСостоянийКОтказу > 0 Тогда
		ОбновитьПредставленияСостоянияПодтвержденияУпаковок(Объект);
		ТекстОповещения = НСтр("ru = 'Состояние ""Арбитраж (Отказаться)"" установлено для %1 из %2 строк'");
		ТекстОповещения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			ТекстОповещения, КоличествоУстановленныхСостоянийКОтказу, КоличествоСтрок);
	Иначе
		ТекстОповещения = НСтр("ru = 'Отсутствуют строки которые можно пометить к отказу'");
	КонецЕсли;
	
	ТекстЗаголовка  = НСтр("ru = 'Отказаться'");
	ПоказатьОповещениеПользователя(ТекстЗаголовка,, ТекстОповещения, БиблиотекаКартинок.Информация32);
	
КонецПроцедуры


&НаСервере
Процедура ОбработатьИзменениеКонтрагента()
	
	Если Объект.КонтрагентНеЗарегистрированВГИСМ Тогда
		
		Реквизиты = ИнтеграцияМДЛП.РеквизитыКонтрагента(Объект.Контрагент);
		Объект.КонтрагентФизическоеЛицо = Реквизиты.ЭтоФизическоеЛицо;
		Объект.КонтрагентИНН            = Реквизиты.ИНН;
		Объект.КонтрагентКПП            = Реквизиты.КПП;
		Объект.АдресСкладаКонтрагента   = Реквизиты.ЮридическийАдрес;
		
		НастроитьВидимостьРеквизитовКонтрагента(ЭтотОбъект);
		ОбработатьИзменениеАдреса();
		
	ИначеЕсли Объект.Операция = Перечисления.ОперацииОтгрузкиМДЛП.ВывозВЕАЭС Тогда
		
		Реквизиты = ИнтеграцияМДЛП.РеквизитыКонтрагента(Объект.Контрагент);
		Объект.КонтрагентИТИН = ОбщегоНазначенияКлиентСервер.СвойствоСтруктуры(Реквизиты, "ИТИН");
		Страна = ОбщегоНазначенияКлиентСервер.СвойствоСтруктуры(Реквизиты, "Страна");
		Если ТипЗнч(Страна) = Тип("СправочникСсылка.СтраныМира") Тогда
			Объект.КонтрагентКодСтраны = ПолучитьКодСтраны(Страна);
		Иначе
			Объект.КонтрагентКодСтраны = Страна;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьВыборСтраны(Страна, _) Экспорт
	
	Если ЗначениеЗаполнено(Страна) Тогда
		Объект.КонтрагентКодСтраны = ПолучитьКодСтраны(Страна);
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьКодСтраны(Знач Страна)
	Возврат ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Страна, "КодАльфа2");
КонецФункции

&НаСервере
Процедура ОбработатьИзменениеАдреса()
	
	ИнтеграцияМДЛП.ЗаполнитьЗначенияПолейКИПоПредставлению(Объект, Объект.АдресСкладаКонтрагента, "АдресСкладаКонтрагента");
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура НастроитьВидимостьРеквизитовКонтрагента(Форма)
	
	Форма.Элементы.КонтрагентИНН.Видимость = Не Форма.Объект.КонтрагентФизическоеЛицо;
	Форма.Элементы.КонтрагентКПП.Видимость = Не Форма.Объект.КонтрагентФизическоеЛицо;
	Форма.Элементы.КонтрагентИННФизЛицо.Видимость = Форма.Объект.КонтрагентФизическоеЛицо;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьВидимостьРеквизитовКонтрагента()
	
	ЭлементыКонтрагентЗарегистрирован = Новый Массив;
	ЭлементыКонтрагентЗарегистрирован.Добавить(Элементы.Грузополучатель.Имя);
	ЭлементыКонтрагентЗарегистрирован.Добавить(Элементы.МестоДеятельностиГрузополучателя.Имя);
	ЭлементыКонтрагентНеЗарегистрирован = Новый Массив;
	ЭлементыКонтрагентНеЗарегистрирован.Добавить(Элементы.Контрагент.Имя);
	ЭлементыКонтрагентНеЗарегистрирован.Добавить(Элементы.КонтрагентФизическоеЛицо.Имя);
	ЭлементыКонтрагентНеЗарегистрирован.Добавить(Элементы.КонтрагентИННФизЛицо.Имя);
	ЭлементыКонтрагентНеЗарегистрирован.Добавить(Элементы.КонтрагентИНН.Имя);
	ЭлементыКонтрагентНеЗарегистрирован.Добавить(Элементы.КонтрагентКПП.Имя);
	ЭлементыКонтрагентНеЗарегистрирован.Добавить(Элементы.АдресСкладаКонтрагента.Имя);
	ЭлементыКонтрагентНеЗарегистрирован.Добавить(Элементы.ИдентификаторАдресногоОбъекта.Имя);
	ЭлементыКонтрагентНеЗарегистрирован.Добавить(Элементы.ИдентификаторДома.Имя);
	ЭлементыКонтрагентНеЗарегистрирован.Добавить(Элементы.Помещение.Имя);
	
	Если Элементы.КонтрагентНеЗарегистрированВГИСМ.Видимость Тогда
		Для Каждого ИмяЭлемента Из ЭлементыКонтрагентЗарегистрирован Цикл
			ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, ИмяЭлемента, "Видимость", Не Объект.КонтрагентНеЗарегистрированВГИСМ);
		КонецЦикла;
	КонецЕсли;
	
	КонтрагентНеЗарегистрирован = Элементы.КонтрагентНеЗарегистрированВГИСМ.Видимость И Объект.КонтрагентНеЗарегистрированВГИСМ;
	Для Каждого ИмяЭлемента Из ЭлементыКонтрагентНеЗарегистрирован Цикл
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, ИмяЭлемента, "Видимость", КонтрагентНеЗарегистрирован);
	КонецЦикла;
	
	Если КонтрагентНеЗарегистрирован Тогда
		НастроитьВидимостьРеквизитовКонтрагента(ЭтотОбъект);
	КонецЕсли;
	
КонецПроцедуры

#Область ОбработкаШтрихкодов

&НаКлиенте
Процедура ЗагрузитьИзТСДЗавершение(РезультатВыполнения, ДополнительныеПараметры) Экспорт
	
	Если РезультатВыполнения.Результат Тогда
		ОбработатьШтрихкоды(РезультатВыполнения.ТаблицаТоваров);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьШтрихкоды(ДанныеШтрихкодов)
	
	Если РедактированиеФормыНедоступно Тогда
		Возврат;
	КонецЕсли;
	
	Если Объект.СхемаАкцептования <> ПредопределенноеЗначение("Перечисление.СхемыАкцептованияМДЛП.ПрямойПорядок") Тогда
		Возврат;
	КонецЕсли;
	
	ДанныеШтрихкодовПоТипам = ИнтеграцияМДЛПКлиентСервер.РазобратьШтрихкодыПоТипам(ДанныеШтрихкодов);
	
	ПараметрыЗаполнения = ИнтеграцияМДЛПКлиентСервер.ПараметрыЗаполненияТабличнойЧасти();
	ПараметрыЗаполнения.ПересчитатьКоличествоЕдиниц = Истина;
	
	ДанныеДляОбработки = СобытияФормМДЛПКлиентПереопределяемый.ПодготовитьДанныеДляОбработкиШтрихкодов(
		ЭтотОбъект, ДанныеШтрихкодовПоТипам, КэшированныеЗначения, ПараметрыЗаполнения);
	
	ИнтеграцияМДЛПСлужебныйКлиент.ЗаполнитьДокументПоШтрихкодам(ЭтотОбъект, Объект, КэшированныеЗначения, ДанныеШтрихкодовПоТипам.НомераКиЗ, ДанныеШтрихкодовПоТипам.НомераТранспортныхУпаковок);
	
	ОбработатьПолученныеШтрихкодыСервер(ДанныеДляОбработки, КэшированныеЗначения);
	
	СобытияФормМДЛПКлиентСервер.ОбновитьЗаголовокКоличествоНомеровУпаковок(ЭтотОбъект);
	
	СобытияФормМДЛПКлиентПереопределяемый.ПослеОбработкиШтрихкодов(
		ЭтотОбъект,
		ДанныеДляОбработки,
		КэшированныеЗначения);
	
КонецПроцедуры

&НаСервере
Процедура ОбработатьПолученныеШтрихкодыСервер(ДанныеДляОбработки, КэшированныеЗначения)
	
	СобытияФормМДЛППереопределяемый.ОбработатьШтрихкоды(ЭтотОбъект, ДанныеДляОбработки, КэшированныеЗначения);
	
	ОбновитьСтатусыЗаполненияНомеровУпаковок(Объект);
	
	ГосударственныеИнформационныеСистемыПереопределяемый.ЗаполнитьСлужебныеРеквизитыВКоллекции(ЭтотОбъект, Объект.Товары);
	
КонецПроцедуры

#КонецОбласти

#Область ЗапросИнформацииОбУпаковках

&НаКлиенте
Процедура ЗапроситьИнформациюОбУпаковках()
	
	Отбор = Новый Массив;
	Отбор.Добавить(Новый Структура("Поле, Значение", "Организация", Объект.Организация));
	Отбор.Добавить(Новый Структура("Поле, Значение", "МестоДеятельности", Объект.МестоДеятельности));
	
	ДоступныйТранспорт = ТранспортМДЛПВызовСервера.ДоступныеТранспортныеМодули(Отбор);
	Если ДоступныйТранспорт.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Оповещение = Новый ОписаниеОповещения("ЗапроситьИнформациюОбУпаковках_ПослеПопыткиАвторизации", ЭтотОбъект);
	ТранспортМДЛПАПИКлиент.ПолучитьТекущийКлючСессии(ДоступныйТранспорт[0].ПараметрыПодключения, Оповещение);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗапроситьИнформациюОбУпаковках_ПослеПопыткиАвторизации(РезультатАвторизации, Контекст) Экспорт
	
	Если РезультатАвторизации.Статус = "Ошибка" Тогда
		ВызватьИсключение РезультатАвторизации.ОписаниеОшибки;
	КонецЕсли;
	
	ЗапроситьИнформациюОПотребительскихУпаковках(РезультатАвторизации.ТранспортныйМодуль, Объект.НомераУпаковок);
	Если Объект.СхемаАкцептования = ПредопределенноеЗначение("Перечисление.СхемыАкцептованияМДЛП.ОбратныйПорядок") Тогда
		// Параллельно запускать получение информации о транспортных упаковках есть смысл только при обратном порядке акцептования,
		// когда точно известно, что количество и состав транспортных упаковок не изменится.
		ЗапроситьИнформациюОТранспортныхУпаковках(РезультатАвторизации.ТранспортныйМодуль, Объект.ТранспортныеУпаковки);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОтменитьЗапросИнформацииОбУпаковках()
	
	ОтменитьПолучениеИнформациюОПотребительскихУпаковках();
	ОтменитьПолучениеИнформациюОТранспортныхУпаковках();
	
КонецПроцедуры

&НаКлиенте
Процедура ОтобразитьВыполнениеПолученияИнформацииОбУпаковках(Состояние)
	
	Если Состояние = "Начало" Тогда
		
		Элементы.ОтменитьЗапросИнформацииОКиЗ.Видимость = Истина;
		
		Элементы.СтатусПредставление.Доступность = Ложь;
		Элементы.Товары.Доступность = Ложь;
		Элементы.НомераУпаковок.Доступность = Ложь;
		Элементы.ТранспортныеУпаковки.Доступность = Ложь;
		Элементы.СоставТранспортныхУпаковок.Доступность = Ложь;
		
		ТекстОповещения = НСтр("ru = 'Получение информации'");
		ПояснениеОповещения = НСтр("ru = 'Получение информации об упаковках запущено'");
		ПоказатьОповещениеПользователя(ТекстОповещения,, ПояснениеОповещения, БиблиотекаКартинок.Информация32);
		
	Иначе
		
		Если Не ЗначениеЗаполнено(ИдентификаторЗаданияПолученияИнформацииОКИЗ)
		   И Не ЗначениеЗаполнено(ИдентификаторЗаданияПолученияИнформацииОТранспортныхУпаковках) Тогда
			
			Элементы.ОтменитьЗапросИнформацииОКиЗ.Видимость = Ложь;
			
			Элементы.СтатусПредставление.Доступность = Истина;
			Элементы.Товары.Доступность = Истина;
			Элементы.НомераУпаковок.Доступность = Истина;
			Элементы.ТранспортныеУпаковки.Доступность = Истина;
			Элементы.СоставТранспортныхУпаковок.Доступность = Истина;
			
			ТекстОповещения = НСтр("ru = 'Получение информации'");
			ПояснениеОповещения = НСтр("ru = 'Получение информации об упаковках завершено'");
			ПоказатьОповещениеПользователя(ТекстОповещения,, ПояснениеОповещения, БиблиотекаКартинок.Информация32);
			
		КонецЕсли;
		
	КонецЕсли;
	
	ОбновитьИнтерфейс();
	
КонецПроцедуры

#Область ЗапросИнформацииОПотребительскихУпаковках

&НаКлиенте
Процедура ЗапроситьИнформациюОПотребительскихУпаковках(ПараметрыПодключения, НомераУпаковок)
	
	СтандартнаяОбработка = Истина;
	СобытияФормМДЛПКлиентПереопределяемый.ЗапроситьИнформациюОПотребительскихУпаковках(ЭтотОбъект, ПараметрыПодключения, НомераУпаковок, СтандартнаяОбработка);
	Если Не СтандартнаяОбработка Тогда
		Возврат;
	КонецЕсли;
	
	ОтменитьПолучениеИнформациюОПотребительскихУпаковках();
	
	ОтобразитьВыполнениеПолученияИнформацииОбУпаковках("Начало");
	
	Контекст = Новый Структура;
	Контекст.Вставить("ПараметрыПодключения", ПараметрыПодключения);
	
	Оповещение = Новый ОписаниеОповещения("ОбработатьПолучениеИнформацииОПотребительскихУпаковках", ЭтотОбъект, Контекст);
	
	НомераКИЗ = Новый Массив;
	Для Каждого Строка Из Объект.Товары Цикл
		Для Каждого СтрокаУпаковки Из НомераУпаковок Цикл
			Если Строка.ИдентификаторСтроки = СтрокаУпаковки.ИдентификаторСтроки И ЗначениеЗаполнено(СтрокаУпаковки.НомерКИЗ) Тогда
				НомераКИЗ.Добавить(СтрокаУпаковки.НомерКИЗ);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	Если НомераКИЗ.Количество() = 0 Тогда
		ТекстОповещения = НСтр("ru = 'Получение информации'");
		ПояснениеОповещения = НСтр("ru = 'Нет данных потребительских упаковок для обработки'");
		ПоказатьОповещениеПользователя(ТекстОповещения,, ПояснениеОповещения, БиблиотекаКартинок.Информация32);
		ВыполнитьОбработкуОповещения(Оповещение, ТранспортМДЛПКлиентСервер.РезультатВыполненияОперации());
		Возврат;
	КонецЕсли;
	
	ПараметрыМетода = ТранспортМДЛПАПИКлиентСервер.ПараметрыПолученияИнформацииОПотребительскихУпаковках(Строка(УникальныйИдентификатор));
	ПараметрыМетода.НомераУпаковок = НомераКИЗ;
	// Для документа нужно получение информации, принадлежит ли упаковка организации-отправителю.
	// Эта информация определяется только синхронным методом получения приватной информации об упаковках.
	ПараметрыМетода.ТипЗапросаМетодовАПИ = ПредопределенноеЗначение("Перечисление.ТипыЗапросовМетодовАПИМДЛП.Синхронный");
	ПараметрыМетода.ТипИсточникаИнформацииОбУпаковках = ПредопределенноеЗначение("Перечисление.ТипыИсточниковИнформацииОбУпаковкахМДЛП.Приватный");
	ПараметрыМетода.ПолучатьВерхнеуровневыеУпаковки = Истина;
	
	ПараметрыЗапуска = ТранспортМДЛПАПИКлиент.ПараметрыЗапускаМетодовАПИВДлительнойОперации(ЭтотОбъект);
	ПараметрыЗапуска.ОповещениеПередОжиданиемДлительнойОперации = Новый ОписаниеОповещения("ПередОжиданиемПолученияИнформацииОПотребительскихУпаковках", ЭтотОбъект);
	
	ТранспортМДЛПАПИКлиент.НачатьПолучениеИнформацииОКИЗ(ПараметрыПодключения, Оповещение, ПараметрыМетода, ПараметрыЗапуска);
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьПолучениеИнформацииОПотребительскихУпаковках(Результат, Контекст) Экспорт
	
	СтандартнаяОбработка = Истина;
	СобытияФормМДЛПКлиентПереопределяемый.ОбработатьПолучениеИнформацииОПотребительскихУпаковках(ЭтотОбъект, Результат, Контекст, СтандартнаяОбработка);
	Если Не СтандартнаяОбработка Тогда
		Возврат;
	КонецЕсли;
	
	ИдентификаторЗаданияПолученияИнформацииОКИЗ = Неопределено;
	Если Не Открыта() Тогда
		Возврат;
	КонецЕсли;
	
	ОтобразитьВыполнениеПолученияИнформацииОбУпаковках("Конец");
	
	АдресРезультатаМетодаАПИ = ОбщегоНазначенияКлиентСервер.СвойствоСтруктуры(Результат, "АдресРезультатаМетодаАПИ");
	Если АдресРезультатаМетодаАПИ <> Неопределено Тогда
		ОбработатьПолучениеИнформацииОПотребительскихУпаковкахНаСервере(АдресРезультатаМетодаАПИ);
		СобытияФормМДЛПКлиентСервер.ОбновитьЗаголовокКоличествоНомеровУпаковок(ЭтотОбъект);
	КонецЕсли;
	
	Если Результат.Статус = "Ошибка" Тогда
		ВызватьИсключение Результат.ОписаниеОшибки;
	КонецЕсли;
	
	Если Объект.СхемаАкцептования = ПредопределенноеЗначение("Перечисление.СхемыАкцептованияМДЛП.ПрямойПорядок") Тогда
		// При прямом порядке акцептования запрос информации о транспортных упаковках
		// есть смылс запускать только после получения информации о потребительских упаковках,
		// т.к. введенные пользователем номера потребительских упаковок, могут находится, по данным ИС МДЛП, внутри транспортной упаковки.
		// Эти данные мы получаем из ответа на запрос информации о потребительских упаковках,
		// после чего можем получать информацию о тех транспортных упаковках, которые ввел пользователь
		// и тех, которые мы получили в ответе на запрос информцаии о потребительских упаковках.
		ЗапроситьИнформациюОТранспортныхУпаковках(Контекст.ПараметрыПодключения, Объект.ТранспортныеУпаковки);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОбработатьПолучениеИнформацииОПотребительскихУпаковкахНаСервере(Знач АдресРезультата)
	
	Результат = ПолучитьИзВременногоХранилища(АдресРезультата);
	Данные = ОбщегоНазначенияКлиентСервер.СвойствоСтруктуры(Результат, "Данные");
	Если ЗначениеЗаполнено(Данные) Тогда
		
		СтандартнаяОбработка = Истина;
		СобытияФормМДЛППереопределяемый.ОбработатьПолучениеИнформацииОПотребительскихУпаковках(ЭтотОбъект, Данные, СтандартнаяОбработка);
		Если Не СтандартнаяОбработка Тогда
			Возврат;
		КонецЕсли;
		
		Если Объект.СхемаАкцептования = Перечисления.СхемыАкцептованияМДЛП.ПрямойПорядок Тогда
			
			ЗаполнитьДанныеКИЗ(Данные);
			
			Модифицированность = Истина;
			
		Иначе
			
			НачатьТранзакцию();
			Попытка
				
				ЗаполнитьДанныеКИЗ(Данные);
				
				Если Не Записать() Тогда
					ВызватьИсключение НСтр("ru = 'Ошибка записи документа.'");
				КонецЕсли;
				
				ДальнейшиеДействия = Документы.УведомлениеОбОтгрузкеМДЛП.ПолучитьДальнейшиеДействияПоДокументу(Объект.Ссылка, Объект.Операция);
				
				Статусы = РегистрыСведений.СтатусыИнформированияМДЛП.СтатусыОбработки();
				Статусы.Принят = СтатусМДЛП;
				ОбщегоНазначенияКлиентСервер.ДополнитьМассив(Статусы.ПринятДействия, ДальнейшиеДействия);
				ПараметрыОбновления = РегистрыСведений.СтатусыИнформированияМДЛП.РассчитатьСтатусы(Объект.Ссылка, Перечисления.СтатусыОбработкиСообщенийМДЛП.Принято, Статусы);
				РегистрыСведений.СтатусыИнформированияМДЛП.ОбновитьСтатус(Объект.Ссылка, ПараметрыОбновления);
				
				ЗафиксироватьТранзакцию();
				
			Исключение
				
				ОтменитьТранзакцию();
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Не удалось получить информацию об упаковках в документе: %1 по причине: %2'"), 
					Объект.Ссылка,
					ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
				
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
				
			КонецПопытки;
			
			Прочитать();
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьДанныеКИЗ(Данные)
	
	Документ = Объект;
	ТоварыДоИзменения = Документ.Товары.Выгрузить();
	Для Каждого КлючЗначение Из Данные Цикл
		
		НайденныйСтроки = Документ.НомераУпаковок.НайтиСтроки(Новый Структура("НомерКиЗ", КлючЗначение.Ключ));
		Если НайденныйСтроки.Количество() = 0 Тогда
			Продолжить;
		КонецЕсли;
		СтрокаУпаковки = НайденныйСтроки[0];
		
		ДанныеУпаковки = КлючЗначение.Значение;
		ЕстьИнформация = ДанныеУпаковки["error_code"] = Неопределено;
		Если ЕстьИнформация Тогда
			
			Если ДанныеУпаковки["gtin"] = Неопределено Тогда
				GTIN = Лев(14, КлючЗначение.Ключ);
				Статус = НСтр("ru = 'Не известен'");
			Иначе
				GTIN = ДанныеУпаковки["gtin"];
				Статус = ДанныеУпаковки["status"];
			КонецЕсли;
			
			СтрокаУпаковки.СостояниеПолученияИнформации = Перечисления.СостоянияПодтвержденияМДЛП.Подтверждено;
			СтрокаУпаковки.Статус = Статус;
			
			ПараметрыЗаполнения = ИнтеграцияМДЛПКлиентСервер.ПараметрыЗаполненияТабличнойЧасти();
			ПараметрыЗаполнения.ПересчитатьКоличествоУпаковок = Истина;
			ПараметрыЗаполнения.ПересчитатьСумму = Истина;
			
			СтрокаТовараСтарая = Документ.Товары.НайтиСтроки(Новый Структура("ИдентификаторСтроки", СтрокаУпаковки.ИдентификаторСтроки))[0];
			Если СтрокаТовараСтарая.Количество > 1 Тогда
				СуммаНДС = Окр(СтрокаТовараСтарая.СуммаНДС / СтрокаТовараСтарая.Количество, 2);
			Иначе
				СуммаНДС = СтрокаТовараСтарая.СуммаНДС;
			КонецЕсли;
			
			НомерВерхнеуровневойТранспортнойУпаковки = ДанныеУпаковки["parent_sscc"];
			Если ЗначениеЗаполнено(НомерВерхнеуровневойТранспортнойУпаковки) Тогда
				
				// При прямом порядке акцептования может быть случай, когда потребительская упаковка, введенная розсыпью,
				// на самом деле находится в транспортной упаковке.
				// В этом случае нужно получить полный состав транспортной упаковки
				// и при необходимости соединить с составом транспортной упаковки вместо товара розсыпью (см. ЗаполнитьДанныеТранспортныхУпаковок).
				// В случае, если в ИС МДЛП выполняется авторазагрегирование или автоизъятие, тогда данный механизм может быть неактуальным.
				// Для включения/отключения механизма необходимо установить параметр ПолучатьВерхнеуровневыеУпаковки = Истина/Ложь.
				
				Отбор = Новый Структура;
				Отбор.Вставить("НомерУпаковки", НомерВерхнеуровневойТранспортнойУпаковки);
				
				НайденныеСтроки = Документ.ТранспортныеУпаковки.НайтиСтроки(Отбор);
				Если НайденныеСтроки.Количество() = 0 Тогда
					НоваяСтрокаТранспортнойУпаковки = Документ.ТранспортныеУпаковки.Добавить();
					НоваяСтрокаТранспортнойУпаковки.НомерУпаковки          = НомерВерхнеуровневойТранспортнойУпаковки;
					НоваяСтрокаТранспортнойУпаковки.ИдентификаторСтроки    = Строка(Новый УникальныйИдентификатор);
					НоваяСтрокаТранспортнойУпаковки.СостояниеПодтверждения = Перечисления.СостоянияПодтвержденияМДЛП.КПередаче;
					НоваяСтрокаТранспортнойУпаковки.СуммаНДС               = СуммаНДС;
					НоваяСтрокаТранспортнойУпаковки.Цена                   = СтрокаТовараСтарая.Цена;
					НоваяСтрокаТранспортнойУпаковки.ДобавляемаяПерераспределением = Истина;
				КонецЕсли;
				
				СтрокаУпаковки.Статус = СтрШаблон("(%1) %2", 0, НСтр("ru = 'В транспортной упаковке'"));
				СтрокаУпаковки.СостояниеПолученияИнформации = Перечисления.СостоянияПодтвержденияМДЛП.ОтклоненоГИСМ;
				СтрокаУпаковки.Перераспределяемая = Истина;
				
			КонецЕсли;
			
			Отбор = Новый Структура;
			Отбор.Вставить("GTIN"      , GTIN);
			Отбор.Вставить("НомерСерии", Строка(ДанныеУпаковки["batch"]));
			Отбор.Вставить("ГоденДо"   , ТранспортМДЛПАПИКлиентСервер.СтрокаВДату(ДанныеУпаковки["expiration_date"]));
			Отбор.Вставить("Цена"      , СтрокаТовараСтарая.Цена);
			
			НайденныеСтроки = Документ.Товары.НайтиСтроки(Отбор);
			Если НайденныеСтроки.Количество() > 0 Тогда
				
				Если НайденныеСтроки.Найти(СтрокаТовараСтарая) = Неопределено Тогда
				
					СтрокаТовараСтарая.Количество = СтрокаТовараСтарая.Количество - 1;
					СтрокаТовараСтарая.СуммаНДС = СтрокаТовараСтарая.СуммаНДС - СуммаНДС;
					Если СтрокаТовараСтарая.Количество = 0 Тогда
						Документ.Товары.Удалить(СтрокаТовараСтарая);
					Иначе
						ИнтеграцияМДЛППереопределяемый.ПриИзмененииКоличества(Документ, СтрокаТовараСтарая, ПараметрыЗаполнения);
					КонецЕсли;
					
					НоваяСтрокаТовара = НайденныеСтроки[0];
					СтрокаУпаковки.ИдентификаторСтроки = НоваяСтрокаТовара.ИдентификаторСтроки;
					НоваяСтрокаТовара.Количество = НоваяСтрокаТовара.Количество + 1;
					НоваяСтрокаТовара.СуммаНДС = НоваяСтрокаТовара.СуммаНДС + СуммаНДС;
					ИнтеграцияМДЛППереопределяемый.ПриИзмененииКоличества(Документ, НоваяСтрокаТовара, ПараметрыЗаполнения);
					
				КонецЕсли;
				
			Иначе
				
				ОтборПоИдентификатору = Новый Структура("ИдентификаторСтроки", СтрокаУпаковки.ИдентификаторСтроки);
				НайденныеСтроки = Документ.НомераУпаковок.НайтиСтроки(ОтборПоИдентификатору);
				Если НайденныеСтроки.Количество() > 1 Тогда
					СтрокаТовараСтарая.Количество = СтрокаТовараСтарая.Количество - 1;
					СтрокаТовараСтарая.СуммаНДС = СтрокаТовараСтарая.СуммаНДС - СуммаНДС;
					ИнтеграцияМДЛППереопределяемый.ПриИзмененииКоличества(Документ, СтрокаТовараСтарая, ПараметрыЗаполнения);
					
					НоваяСтрокаТовара = Документ.Товары.Вставить(СтрокаТовараСтарая.НомерСтроки);
					ЗаполнитьЗначенияСвойств(НоваяСтрокаТовара, СтрокаТовараСтарая,, "Серия, Количество, КоличествоУпаковок, ИдентификаторСтроки");
					НоваяСтрокаТовара.Количество = 1;
					НоваяСтрокаТовара.СуммаНДС = СуммаНДС;
					НоваяСтрокаТовара.ИдентификаторСтроки = Строка(Новый УникальныйИдентификатор);
					СтрокаУпаковки.ИдентификаторСтроки = НоваяСтрокаТовара.ИдентификаторСтроки;
					
					ИнтеграцияМДЛППереопределяемый.ПриИзмененииКоличества(Документ, НоваяСтрокаТовара, ПараметрыЗаполнения);
				Иначе
					НоваяСтрокаТовара = СтрокаТовараСтарая;
				КонецЕсли;
				
				ЗаполнитьЗначенияСвойств(НоваяСтрокаТовара, Отбор);
				
				ПараметрыЗаполнения = ИнтеграцияМДЛПКлиентСервер.ПараметрыЗаполненияТабличнойЧасти();
				ПараметрыЗаполнения.ОбработатьУпаковки = Ложь;
				ПараметрыЗаполнения.ПроверитьСериюРассчитатьСтатус = Истина;
				ПараметрыЗаполнения.ПараметрыУказанияСерий = ПараметрыУказанияСерий;
				ИнтеграцияМДЛППереопределяемый.ПриИзмененииПараметровНоменклатуры(Документ, НоваяСтрокаТовара, ПараметрыЗаполнения);
				
			КонецЕсли;
			
		Иначе
			ОписаниеОшибки = ДанныеУпаковки["error_desc"];
			Если Не ЗначениеЗаполнено(ОписаниеОшибки) Тогда
				ОписаниеОшибки = ДанныеУпаковки["error_description"];
			КонецЕсли;
			СтрокаУпаковки.Статус = СтрШаблон("(%1) %2", ДанныеУпаковки["error_code"], ОписаниеОшибки);
			СтрокаУпаковки.СостояниеПолученияИнформации = Перечисления.СостоянияПодтвержденияМДЛП.ОтклоненоГИСМ;
			Если Объект.СхемаАкцептования = Перечисления.СхемыАкцептованияМДЛП.ОбратныйПорядок Тогда
				СтрокаУпаковки.СостояниеПодтверждения = Перечисления.СостоянияПодтвержденияМДЛП.АктуализироватьДанныеОбУпаковках;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	// Для прямого порядка акцептования, после получения информации об упаковках,
	// нужно перезаполнить цены, в соответствии с данными, которые были получены из документа-основания
	// или введены вручную без данных о сериях упаковок.
	Если Документ.СхемаАкцептования = Перечисления.СхемыАкцептованияМДЛП.ПрямойПорядок Тогда
		
		Очередь = Новый Массив;
		Для Каждого СтрокаТовара Из Документ.Товары Цикл
			Отбор = Новый Структура("Номенклатура, Серия");
			ЗаполнитьЗначенияСвойств(Отбор, СтрокаТовара);
			Очередь.Добавить(Новый Структура("СтрокаТовара, Отбор, НомерПопытки", СтрокаТовара, Отбор, 1));
		КонецЦикла;
		
		Пока Очередь.Количество() > 0 Цикл
			
			ЭлементОчереди = Очередь[0];
			
			СтрокаТовара = ЭлементОчереди.СтрокаТовара;
			Отбор        = ЭлементОчереди.Отбор;
			НомерПопытки = ЭлементОчереди.НомерПопытки;
			
			Очередь.Удалить(0);
			
			НайденныеСтроки = ТоварыДоИзменения.НайтиСтроки(Отбор);
			
			СтрокаТовара.СуммаНДС  = 0;
			СтрокаТовара.Цена      = 0;
			ОбработанноеКоличество = 0;
			
			Если НайденныеСтроки.Количество() = 0 Тогда
				// Если не удалось найти строки по отбору с учетом серии, тогда добавим в конец очереди строку с отбором по пустой серии.
				// Возможно, серия в строке не была заполнена изначально.
				Если НомерПопытки < 2 Тогда
					Отбор = Новый Структура("Номенклатура, Серия", СтрокаТовара.Номенклатура, Метаданные.ОпределяемыеТипы.СерияНоменклатуры.Тип.ПривестиЗначение());
					Очередь.Добавить(Новый Структура("СтрокаТовара, Отбор, НомерПопытки", СтрокаТовара, Отбор, 2));
				КонецЕсли;
			КонецЕсли;
			
			Для Каждого НайденнаяСтрока Из НайденныеСтроки Цикл
				
				// Пропускаем строки, у которых количество не заполнено.
				Если СтрокаТовара.Количество = 0 Тогда
					Продолжить;
				КонецЕсли;
				
				// Прерываем обход найденных строк, т.к. по строке товара уже все количество обработано.
				Если ОбработанноеКоличество = СтрокаТовара.Количество Тогда
					Прервать;
				КонецЕсли;
				
				// Если в очередной найденной строке цена отличается от цены, которую установили на предыдущей итерации,
				// а количество упаковок еще не полностью обработано,
				// тогда переходим к следующей строке, может у нее цена будет такая же.
				// Если ни одна строка не подойдет, тогда будет добавлена новая строка товара и выполнен новый поиск подходящих цен (см. механизм после цикла).
				Если СтрокаТовара.Цена > 0 И СтрокаТовара.Цена <> НайденнаяСтрока.Цена Тогда
					Продолжить;
				КонецЕсли;
				
				// Рассчитываем количество упаковок, для которого будет установлена новая цена.
				КоличествоЗачета = Мин(СтрокаТовара.Количество - ОбработанноеКоличество, НайденнаяСтрока.Количество);
				ОбработанноеКоличество = ОбработанноеКоличество + КоличествоЗачета;
				
				// Расчет Суммы НДС
				Если НайденнаяСтрока.Количество = КоличествоЗачета Тогда
					СуммаНДС = НайденнаяСтрока.СуммаНДС;
				ИначеЕсли НайденнаяСтрока.Количество > 1 Тогда
					СуммаНДС = Окр(КоличествоЗачета * НайденнаяСтрока.СуммаНДС / НайденнаяСтрока.Количество, 2);
				Иначе // НайденнаяСтрока.Количество = 1
					СуммаНДС = НайденнаяСтрока.СуммаНДС;
				КонецЕсли;
				
				// Устанавливаем новую сумму НДС и цену.
				СтрокаТовара.СуммаНДС = СтрокаТовара.СуммаНДС + СуммаНДС;
				СтрокаТовара.Цена     = НайденнаяСтрока.Цена;
				
				// Уменьшаем количество упаковок и сумму НДС в строке поиска, для использования в следующих итерациях.
				НайденнаяСтрока.Количество = НайденнаяСтрока.Количество - КоличествоЗачета;
				НайденнаяСтрока.СуммаНДС = НайденнаяСтрока.СуммаНДС - СуммаНДС;
				
				// Если все количество упаковок было зачтено,
				// тогда текущая найденная строка считается обработанной полностью и ее можно удалять из коллекции поиска.
				Если НайденнаяСтрока.Количество = 0 Тогда
					ТоварыДоИзменения.Удалить(НайденнаяСтрока);
				КонецЕсли;
				
			КонецЦикла;
			
			ПараметрыЗаполнения = ИнтеграцияМДЛПКлиентСервер.ПараметрыЗаполненияТабличнойЧасти();
			ПараметрыЗаполнения.ПересчитатьСумму = Истина;
			ИнтеграцияМДЛППереопределяемый.ПриИзмененииЦены(Документ, СтрокаТовара, ПараметрыЗаполнения);
			
			Если ОбработанноеКоличество > 0 Тогда
				
				// Если не удалось накопить количество упаковок такое же как в строке товара,
				// тогда нужно поискать строки с другой ценой.
				// Для этого нужно создать новую строку товара, по которому не удалось найти цену, как в текущей строке.
				Если ОбработанноеКоличество < СтрокаТовара.Количество Тогда
					
					ПараметрыЗаполнения = ИнтеграцияМДЛПКлиентСервер.ПараметрыЗаполненияТабличнойЧасти();
					ПараметрыЗаполнения.ПересчитатьКоличествоУпаковок = Истина;
					
					// Создаем строку товара, у которой цена отличается от текущей.
					НоваяСтрокаТовара = Документ.Товары.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрокаТовара, СтрокаТовара,, "Количество, КоличествоУпаковок, ИдентификаторСтроки, Цена, Сумма, СуммаНДС");
					НоваяСтрокаТовара.Количество = СтрокаТовара.Количество - ОбработанноеКоличество;
					НоваяСтрокаТовара.ИдентификаторСтроки = Строка(Новый УникальныйИдентификатор);
					
					// Переносим "последние" упаковки на новую строку товара, у которой цена отличается от текущей.
					ОтборПоИдентификатору = Новый Структура("ИдентификаторСтроки", СтрокаТовара.ИдентификаторСтроки);
					НайденныеСтрокиУпаковок = Документ.НомераУпаковок.НайтиСтроки(ОтборПоИдентификатору);
					Для Индекс = ОбработанноеКоличество По НайденныеСтрокиУпаковок.Количество() - 1 Цикл
						СтрокаУпаковки = НайденныеСтрокиУпаковок[Индекс];
						СтрокаУпаковки.ИдентификаторСтроки = НоваяСтрокаТовара.ИдентификаторСтроки;
					КонецЦикла;
					
					ИнтеграцияМДЛППереопределяемый.ПриИзмененииКоличества(Документ, НоваяСтрокаТовара, ПараметрыЗаполнения);
					
					// Уменьшаем количество упаковок в строке товара, из которой были перенесены упаковки в строку нового товара.
					СтрокаТовара.Количество = ОбработанноеКоличество;
					
					ПараметрыЗаполнения.ПересчитатьСумму = Истина;
					ИнтеграцияМДЛППереопределяемый.ПриИзмененииКоличества(Документ, СтрокаТовара, ПараметрыЗаполнения);
					
					// Добавляем в начало очереди созданную строку, т.к. по ней нужно также выполнить поиск цен.
					Отбор = Новый Структура("Номенклатура, Серия");
					ЗаполнитьЗначенияСвойств(Отбор, НоваяСтрокаТовара);
					Очередь.Вставить(0, Новый Структура("СтрокаТовара, Отбор, НомерПопытки", НоваяСтрокаТовара, Отбор, 1));
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПередОжиданиемПолученияИнформацииОПотребительскихУпаковках(ДлительнаяОперация, ДополнительныеПараметры) Экспорт
	
	ИдентификаторЗаданияПолученияИнформацииОКИЗ = ДлительнаяОперация.ИдентификаторЗадания;
	
КонецПроцедуры

&НаСервере
Процедура ОтменитьПолучениеИнформациюОПотребительскихУпаковках()
	
	Если ЗначениеЗаполнено(ИдентификаторЗаданияПолученияИнформацииОКИЗ) Тогда
		ДлительныеОперации.ОтменитьВыполнениеЗадания(ИдентификаторЗаданияПолученияИнформацииОКИЗ);
		ИдентификаторЗаданияПолученияИнформацииОКИЗ = Неопределено;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ЗапросИнформацииОТранспортныхУпаковках

&НаКлиенте
Процедура ЗапроситьИнформациюОТранспортныхУпаковках(ПараметрыПодключения, НомераУпаковок)
	
	СтандартнаяОбработка = Истина;
	СобытияФормМДЛПКлиентПереопределяемый.ЗапроситьИнформациюОТранспортныхУпаковках(ЭтотОбъект, ПараметрыПодключения, НомераУпаковок, СтандартнаяОбработка);
	Если Не СтандартнаяОбработка Тогда
		Возврат;
	КонецЕсли;
	
	ОтменитьПолучениеИнформациюОТранспортныхУпаковках();
	
	ОтобразитьВыполнениеПолученияИнформацииОбУпаковках("Начало");
	
	ЕстьДобавленныеПерераспределением = Ложь;
	Для Каждого СтрокаУпаковки Из НомераУпаковок Цикл
		Если ЗначениеЗаполнено(СтрокаУпаковки.НомерУпаковки)
		   И СтрокаУпаковки.ДобавляемаяПерераспределением Тогда
			ЕстьДобавленныеПерераспределением = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Контекст = Новый Структура;
	Контекст.Вставить("ПараметрыПодключения", ПараметрыПодключения);
	Контекст.Вставить("НомераУпаковок", НомераУпаковок);
	
	Оповещение = Новый ОписаниеОповещения("ЗапроситьИнформациюОТранспортныхУпаковках_ПослеВопросаПользователю", ЭтотОбъект, Контекст);
	Если ЕстьДобавленныеПерераспределением Тогда
		ЗаголовокВопроса = НСтр("ru = 'Обнаружены несоответствия'");
		ТекстВопроса     = НСтр("ru = 'Обнаружены введенные россыпью потребительские упаковки, которые по данным ИС МДЛП находятся в составе транспортной упаковки.'");
		ТекстВопроса     = ТекстВопроса + Символы.ПС + НСтр("ru = 'Перераспределить или показать несоответствия без перераспределения?'");
		КнопкиВопроса    = Новый СписокЗначений;
		КнопкиВопроса.Добавить(КодВозвратаДиалога.ОК    , НСтр("ru = 'Перераспределить'"));
		КнопкиВопроса.Добавить(КодВозвратаДиалога.Отмена, НСтр("ru = 'Показать несоответствия'"));
		ПоказатьВопрос(Оповещение, ТекстВопроса, КнопкиВопроса,, КодВозвратаДиалога.Отмена, ЗаголовокВопроса);
	Иначе
		ВыполнитьОбработкуОповещения(Оповещение, КодВозвратаДиалога.Отмена);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗапроситьИнформациюОТранспортныхУпаковках_ПослеВопросаПользователю(Ответ, Контекст) Экспорт
	
	ПараметрыПодключения = Контекст.ПараметрыПодключения;
	НомераУпаковок       = Контекст.НомераУпаковок;
	
	Если Ответ <> КодВозвратаДиалога.ОК Тогда
		// Если не нужно перераспределять, тогда удаляем транспортные упаковки,
		// которые были добавлены по данным запроса информации об упаковках.
		Граница = НомераУпаковок.Количество() - 1;
		Для Индекс = 0 По Граница Цикл
			СтрокаУпаковки = НомераУпаковок[Граница - Индекс];
			Если СтрокаУпаковки.ДобавляемаяПерераспределением Тогда
				НомераУпаковок.Удалить(Граница - Индекс);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	// Удаляем временные признаки перераспределения.
	Для Каждого СтрокаУпаковки Из Объект.НомераУпаковок Цикл
		СтрокаУпаковки.Перераспределяемая = Неопределено;
	КонецЦикла;
	Для Каждого СтрокаУпаковки Из Объект.ТранспортныеУпаковки Цикл
		СтрокаУпаковки.ДобавляемаяПерераспределением = Неопределено;
	КонецЦикла;
	
	// Продолжаем выполнение запроса информации о транспортных упаковках.
	Оповещение = Новый ОписаниеОповещения("ОбработатьПолучениеИнформацииОТранспортныхУпаковках", ЭтотОбъект);
	
	НомераТранспортныхУпаковок = Новый Массив;
	Для Каждого СтрокаУпаковки Из НомераУпаковок Цикл
		Если ЗначениеЗаполнено(СтрокаУпаковки.НомерУпаковки) Тогда
			НомераТранспортныхУпаковок.Добавить(СтрокаУпаковки.НомерУпаковки);
		КонецЕсли;
	КонецЦикла;
	
	Если НомераТранспортныхУпаковок.Количество() = 0 Тогда
		ТекстОповещения = НСтр("ru = 'Получение информации'");
		ПояснениеОповещения = НСтр("ru = 'Нет данных транспортных упаковок для обработки'");
		ПоказатьОповещениеПользователя(ТекстОповещения,, ПояснениеОповещения, БиблиотекаКартинок.Информация32);
		ВыполнитьОбработкуОповещения(Оповещение, ТранспортМДЛПКлиентСервер.РезультатВыполненияОперации());
		Возврат;
	КонецЕсли;
	
	ПараметрыМетода = ТранспортМДЛПАПИКлиентСервер.ПараметрыПолученияИнформацииОТранспортныхУпаковках(Строка(УникальныйИдентификатор));
	ПараметрыМетода.НомераУпаковок = НомераТранспортныхУпаковок;
	ПараметрыМетода.ПолучатьРасширеннуюИнформациюОВложенныхКИЗ = Истина;
	ПараметрыМетода.ТипИсточникаИнформацииОВложенныхКИЗ = ПредопределенноеЗначение("Перечисление.ТипыИсточниковИнформацииОбУпаковкахМДЛП.Приватный");
	
	ПараметрыЗапуска = ТранспортМДЛПАПИКлиент.ПараметрыЗапускаМетодовАПИВДлительнойОперации(ЭтотОбъект);
	ПараметрыЗапуска.ОповещениеПередОжиданиемДлительнойОперации = Новый ОписаниеОповещения("ПередОжиданиемПолученияИнформацииОТранспортныхУпаковках", ЭтотОбъект);
	
	ТранспортМДЛПАПИКлиент.НачатьПолучениеИнформацииОТранспортныхУпаковках(ПараметрыПодключения, Оповещение, ПараметрыМетода, ПараметрыЗапуска);
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьПолучениеИнформацииОТранспортныхУпаковках(Результат, Контекст) Экспорт
	
	СтандартнаяОбработка = Истина;
	СобытияФормМДЛПКлиентПереопределяемый.ОбработатьПолучениеИнформацииОТранспортныхУпаковках(ЭтотОбъект, Результат, Контекст, СтандартнаяОбработка);
	Если Не СтандартнаяОбработка Тогда
		Возврат;
	КонецЕсли;
	
	ИдентификаторЗаданияПолученияИнформацииОТранспортныхУпаковках = Неопределено;
	Если Не Открыта() Тогда
		Возврат;
	КонецЕсли;
	
	ОтобразитьВыполнениеПолученияИнформацииОбУпаковках("Конец");
	
	АдресРезультатаМетодаАПИ = ОбщегоНазначенияКлиентСервер.СвойствоСтруктуры(Результат, "АдресРезультатаМетодаАПИ");
	Если АдресРезультатаМетодаАПИ <> Неопределено Тогда
		ОбработатьПолучениеИнформацииОТранспортныхУпаковкахНаСервере(АдресРезультатаМетодаАПИ);
		СобытияФормМДЛПКлиентСервер.ОбновитьЗаголовокКоличествоНомеровУпаковок(ЭтотОбъект);
	КонецЕсли;
	
	Если Результат.Статус = "Ошибка" Тогда
		ВызватьИсключение Результат.ОписаниеОшибки;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОбработатьПолучениеИнформацииОТранспортныхУпаковкахНаСервере(Знач АдресРезультата)
	
	Результат = ПолучитьИзВременногоХранилища(АдресРезультата);
	Данные = ОбщегоНазначенияКлиентСервер.СвойствоСтруктуры(Результат, "Данные");
	Если ЗначениеЗаполнено(Данные) Тогда
		
		СтандартнаяОбработка = Истина;
		СобытияФормМДЛППереопределяемый.ОбработатьПолучениеИнформацииОТранспортныхУпаковках(ЭтотОбъект, Данные, СтандартнаяОбработка);
		Если Не СтандартнаяОбработка Тогда
			Возврат;
		КонецЕсли;
		
		Если Объект.СхемаАкцептования = Перечисления.СхемыАкцептованияМДЛП.ПрямойПорядок Тогда
			
			ЗаполнитьДанныеТранспортныхУпаковок(Данные);
			
			Модифицированность = Истина;
			
		Иначе
			
			НачатьТранзакцию();
			Попытка
				
				ЗаполнитьДанныеТранспортныхУпаковок(Данные);
				
				Если Не Записать() Тогда
					ВызватьИсключение НСтр("ru = 'Ошибка записи документа.'");
				КонецЕсли;
				
				ДальнейшиеДействия = Документы.УведомлениеОбОтгрузкеМДЛП.ПолучитьДальнейшиеДействияПоДокументу(Объект.Ссылка, Объект.Операция);
				
				Статусы = РегистрыСведений.СтатусыИнформированияМДЛП.СтатусыОбработки();
				Статусы.Принят = СтатусМДЛП;
				ОбщегоНазначенияКлиентСервер.ДополнитьМассив(Статусы.ПринятДействия, ДальнейшиеДействия);
				ПараметрыОбновления = РегистрыСведений.СтатусыИнформированияМДЛП.РассчитатьСтатусы(Объект.Ссылка, Перечисления.СтатусыОбработкиСообщенийМДЛП.Принято, Статусы);
				РегистрыСведений.СтатусыИнформированияМДЛП.ОбновитьСтатус(Объект.Ссылка, ПараметрыОбновления);
				
				ЗафиксироватьТранзакцию();
				
			Исключение
				
				ОтменитьТранзакцию();
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Не удалось получить информацию об упаковках в документе: %1 по причине: %2'"), 
					Объект.Ссылка,
					ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
				
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
				
			КонецПопытки;
			
			Прочитать();
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьДанныеТранспортныхУпаковок(Данные)
	
	Для Каждого КлючЗначение Из Данные Цикл
		НайденныйСтроки = Объект.ТранспортныеУпаковки.НайтиСтроки(Новый Структура("НомерУпаковки", КлючЗначение.Ключ));
		Если НайденныйСтроки.Количество() = 0 Тогда
			Продолжить;
		КонецЕсли;
		СтрокаУпаковки = НайденныйСтроки[0];
		
		ДанныеУпаковки = КлючЗначение.Значение;
		ЕстьИнформация = ДанныеУпаковки["error_code"] = Неопределено;
		Если ЕстьИнформация Тогда
			СтрокаУпаковки.СостояниеПолученияИнформации = Перечисления.СостоянияПодтвержденияМДЛП.Подтверждено;
			
			ТекущийСостав = Объект.СоставТранспортныхУпаковок.НайтиСтроки(Новый Структура("ИдентификаторСтроки", СтрокаУпаковки.ИдентификаторСтроки));
			Для Каждого СтрокаСостава Из ТекущийСостав Цикл
				УпаковкиВСоставе = Объект.НомераУпаковок.НайтиСтроки(Новый Структура("ИдентификаторСтроки", СтрокаСостава.ИдентификаторСтрокиУпаковки));
				Для Каждого УдаляемаяСтрока Из УпаковкиВСоставе Цикл
					Объект.НомераУпаковок.Удалить(УдаляемаяСтрока);
				КонецЦикла;
			КонецЦикла;
			ГрупповыеУпаковкиВСоставе = Объект.ИерархияГрупповыхУпаковок.НайтиСтроки(Новый Структура("ИдентификаторСтроки", СтрокаУпаковки.ИдентификаторСтроки));
			Для Каждого УдаляемаяСтрока Из ГрупповыеУпаковкиВСоставе Цикл
				Объект.ИерархияГрупповыхУпаковок.Удалить(УдаляемаяСтрока);
			КонецЦикла;
			
			ПараметрыЗаполнения = ИнтеграцияМДЛПКлиентСервер.ПараметрыЗаполненияТабличнойЧасти();
			ПараметрыЗаполнения.ОбработатьУпаковки = Ложь;
			ПараметрыЗаполнения.ПроверитьСериюРассчитатьСтатус = Истина;
			ПараметрыЗаполнения.ПараметрыУказанияСерий = ГосударственныеИнформационныеСистемыПереопределяемый.ПараметрыУказанияСерийФормыОбъекта(Объект, ОбщегоНазначения.МенеджерОбъектаПоСсылке(Объект.Ссылка));
			
			СтекУпаковок = Новый Массив;
			СтекУпаковок.Добавить(ДанныеУпаковки["down"]);
			
			Пока СтекУпаковок.Количество() > 0 Цикл
				ТекущаяУпаковка = СтекУпаковок[0];
				СтекУпаковок.Удалить(0);
				
				Состав = ТекущаяУпаковка["childs"];
				Для Каждого ЭлементСостава Из Состав Цикл
					ЭтоКИЗ = ЭлементСостава["sgtin"] <> Неопределено;
					Если ЭтоКИЗ Тогда
						
						НомерКиЗ = ЭлементСостава["sgtin"];
						Отбор = Новый Структура;
						Отбор.Вставить("ИдентификаторСтроки", СтрокаУпаковки.ИдентификаторСтроки);
						Отбор.Вставить("GTIN"      , ЭлементСостава["gtin"]);
						Отбор.Вставить("НомерСерии", Строка(ЭлементСостава["batch"]));
						
						ИзменилисьДанныеВСтроке = Ложь;
						
						НайденныеСтроки = Объект.СоставТранспортныхУпаковок.НайтиСтроки(Отбор);
						Если НайденныеСтроки.Количество() > 0 Тогда
							СтрокаТовара = НайденныеСтроки[0];
						Иначе
							СтрокаТовара = Объект.СоставТранспортныхУпаковок.Добавить();
							ЗаполнитьЗначенияСвойств(СтрокаТовара, Отбор);
							ИзменилисьДанныеВСтроке = Истина;
						КонецЕсли;
						
						ОбновляемыеРеквизиты = Новый Массив;
						ОбновляемыеРеквизиты.Добавить("Цена");
						ОбновляемыеРеквизиты.Добавить("СуммаНДС");
						Для Каждого ОбновляемыйРеквизит Из ОбновляемыеРеквизиты Цикл
							Если Не ЗначениеЗаполнено(СтрокаТовара[ОбновляемыйРеквизит]) И СтрокаТовара[ОбновляемыйРеквизит] <> СтрокаУпаковки[ОбновляемыйРеквизит] Тогда
								СтрокаТовара[ОбновляемыйРеквизит] = СтрокаУпаковки[ОбновляемыйРеквизит];
								ИзменилисьДанныеВСтроке = Истина;
							КонецЕсли;
						КонецЦикла;
						
						Если ПустаяСтрока(СтрокаТовара.ИдентификаторСтрокиУпаковки) Тогда
							СтрокаТовара.ИдентификаторСтрокиУпаковки = Строка(Новый УникальныйИдентификатор);
						КонецЕсли;
						Если Не ЗначениеЗаполнено(СтрокаТовара.ГоденДо) Тогда
							СтрокаТовара.ГоденДо = ТранспортМДЛПАПИКлиентСервер.СтрокаВДату(ЭлементСостава["expiration_date"]);
							ИзменилисьДанныеВСтроке = Истина;
						КонецЕсли;
						
						Если ИзменилисьДанныеВСтроке Тогда
							ИнтеграцияМДЛППереопределяемый.ПриИзмененииПараметровНоменклатуры(Объект, СтрокаТовара, ПараметрыЗаполнения);
						КонецЕсли;
						
						НайденныйСтрокиУпаковок = Объект.НомераУпаковок.НайтиСтроки(Новый Структура("НомерКиЗ", НомерКиЗ));
						Если НайденныйСтрокиУпаковок.Количество() > 0 Тогда
							
							НоваяСтрока = НайденныйСтрокиУпаковок[0];
							
							// Перемещение потребительской упаковки в состав транспортной упаковки
							// средством смены идентификаторов строк и пересчетом количественных и суммовых показателей.
							ПараметрыЗаполненияСтаройСтрокиТовара = ИнтеграцияМДЛПКлиентСервер.ПараметрыЗаполненияТабличнойЧасти();
							ПараметрыЗаполненияСтаройСтрокиТовара.ПересчитатьКоличествоУпаковок = Истина;
							ПараметрыЗаполненияСтаройСтрокиТовара.ПересчитатьСумму = Истина;
							
							СтрокиТовараСтарые = Объект.Товары.НайтиСтроки(Новый Структура("ИдентификаторСтроки", НоваяСтрока.ИдентификаторСтроки));
							Если ЗначениеЗаполнено(СтрокиТовараСтарые) Тогда
								
								СтрокаТовараСтарая = СтрокиТовараСтарые[0];
								
								Если СтрокаТовараСтарая.Количество > 1 Тогда
									СуммаНДС = Окр(СтрокаТовараСтарая.СуммаНДС / СтрокаТовараСтарая.Количество, 2);
								Иначе
									СуммаНДС = СтрокаТовараСтарая.СуммаНДС;
								КонецЕсли;
								
								СтрокаТовараСтарая.Количество = СтрокаТовараСтарая.Количество - 1;
								СтрокаТовараСтарая.СуммаНДС = СтрокаТовараСтарая.СуммаНДС - СуммаНДС;
								Если СтрокаТовараСтарая.Количество = 0 Тогда
									Объект.Товары.Удалить(СтрокаТовараСтарая);
								Иначе
									ИнтеграцияМДЛППереопределяемый.ПриИзмененииКоличества(Объект, СтрокаТовараСтарая, ПараметрыЗаполненияСтаройСтрокиТовара);
								КонецЕсли;
								
							КонецЕсли;
							
						Иначе
							НоваяСтрока = Объект.НомераУпаковок.Добавить();
						КонецЕсли;
						
						НоваяСтрока.ИдентификаторСтроки = СтрокаТовара.ИдентификаторСтрокиУпаковки;
						НоваяСтрока.НомерКИЗ = НомерКиЗ;
						НоваяСтрока.Статус    = ЭлементСостава["status"];
						НоваяСтрока.СостояниеПолученияИнформации = Перечисления.СостоянияПодтвержденияМДЛП.Подтверждено;
						НоваяСтрока.СостояниеПодтверждения = Перечисления.СостоянияПодтвержденияМДЛП.НеТребуется;
						СтрокаУпаковки.Статус = ЭлементСостава["status"];
						
					Иначе
						НоваяСтрока = Объект.ИерархияГрупповыхУпаковок.Добавить();
						НоваяСтрока.НомерУпаковки = ЭлементСостава["sscc"];
						НоваяСтрока.ИдентификаторСтроки = СтрокаУпаковки.ИдентификаторСтроки;
						СтекУпаковок.Добавить(ЭлементСостава);
					КонецЕсли;
					НоваяСтрока.НомерРодительскойУпаковки = ТекущаяУпаковка["sscc"];
				КонецЦикла;
				
			КонецЦикла;
			
		Иначе
			ОписаниеОшибки = ДанныеУпаковки["error_desc"];
			Если Не ЗначениеЗаполнено(ОписаниеОшибки) Тогда
				ОписаниеОшибки = ДанныеУпаковки["error_description"];
			КонецЕсли;
			СтрокаУпаковки.Статус = СтрШаблон("(%1) %2", ДанныеУпаковки["error_code"], ОписаниеОшибки);
			СтрокаУпаковки.СостояниеПолученияИнформации = Перечисления.СостоянияПодтвержденияМДЛП.ОтклоненоГИСМ;
			Если Объект.СхемаАкцептования = Перечисления.СхемыАкцептованияМДЛП.ОбратныйПорядок Тогда
				СтрокаУпаковки.СостояниеПодтверждения = Перечисления.СостоянияПодтвержденияМДЛП.АктуализироватьДанныеОбУпаковках;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	ОбновитьПредставленияСостоянияПодтвержденияУпаковок(Объект);
	
КонецПроцедуры

&НаКлиенте
Процедура ПередОжиданиемПолученияИнформацииОТранспортныхУпаковках(ДлительнаяОперация, ДополнительныеПараметры) Экспорт
	
	ИдентификаторЗаданияПолученияИнформацииОТранспортныхУпаковках = ДлительнаяОперация.ИдентификаторЗадания;
	
КонецПроцедуры

&НаСервере
Процедура ОтменитьПолучениеИнформациюОТранспортныхУпаковках()
	
	Если ЗначениеЗаполнено(ИдентификаторЗаданияПолученияИнформацииОТранспортныхУпаковках) Тогда
		ДлительныеОперации.ОтменитьВыполнениеЗадания(ИдентификаторЗаданияПолученияИнформацииОТранспортныхУпаковках);
		ИдентификаторЗаданияПолученияИнформацииОТранспортныхУпаковках = Неопределено;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти // ЗапросИнформацииОбУпаковках

&НаКлиенте
Процедура АктуализироватьДанныеОбУпаковках(ЗаписаноУспешно, ДополнительныеПараметры) Экспорт
	
	Если Не ЗаписаноУспешно Тогда
		Возврат;
	КонецЕсли;
	
	АктуализироватьДанныеОбУпаковкахНаСервере();
	
	ПараметрОповещения = Новый Структура;
	ПараметрОповещения.Вставить("Ссылка", Объект.Ссылка);
	Оповестить("ИзменениеСостоянияМДЛП", ПараметрОповещения);
	
	ПоказатьОповещениеПользователя(
		НСтр("ru = 'Выполнено действие'"),
		ПолучитьНавигационнуюСсылку(Объект.Ссылка),
		НСтр("ru = 'Выполнена актуализация данных об упаковках'"),
		БиблиотекаКартинок.Информация32);
	
КонецПроцедуры

&НаСервере
Процедура АктуализироватьДанныеОбУпаковкахНаСервере()
	
	НачатьТранзакцию();
	
	Попытка
		
		Для Каждого Строка Из Объект.НомераУпаковок Цикл
			Если Строка.СостояниеПодтверждения = Перечисления.СостоянияПодтвержденияМДЛП.АктуализироватьДанныеОбУпаковках Тогда
				Строка.СостояниеПодтверждения = Перечисления.СостоянияПодтвержденияМДЛП.ДанныеОбУпаковкахАктуализированы;
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого Строка Из Объект.ТранспортныеУпаковки Цикл
			Если Строка.СостояниеПодтверждения = Перечисления.СостоянияПодтвержденияМДЛП.АктуализироватьДанныеОбУпаковках Тогда
				Строка.СостояниеПодтверждения = Перечисления.СостоянияПодтвержденияМДЛП.ДанныеОбУпаковкахАктуализированы;
			КонецЕсли;
		КонецЦикла;
		
		Если Не Записать() Тогда
			ВызватьИсключение НСтр("ru = 'Ошибка записи документа.'");
		КонецЕсли;
		
		Статусы = РегистрыСведений.СтатусыИнформированияМДЛП.СтатусыОбработки();
		
		ДальнейшиеДействия = Документы.УведомлениеОбОтгрузкеМДЛП.ПолучитьДальнейшиеДействияПоДокументу(Объект.Ссылка, Объект.Операция);
		Если ДальнейшиеДействия.Количество() = 0 Тогда
			Статусы.Принят  = Перечисления.СтатусыИнформированияМДЛП.Закрыто;
		Иначе
			Статусы.Принят = СтатусМДЛП;
		КонецЕсли;
		
		ОбщегоНазначенияКлиентСервер.ДополнитьМассив(Статусы.ПринятДействия, ДальнейшиеДействия);
		ПараметрыОбновления = РегистрыСведений.СтатусыИнформированияМДЛП.РассчитатьСтатусы(Объект.Ссылка, Перечисления.СтатусыОбработкиСообщенийМДЛП.Принято, Статусы);
		РегистрыСведений.СтатусыИнформированияМДЛП.ОбновитьСтатус(Объект.Ссылка, ПараметрыОбновления);
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Не удалось выполнить операцию в документе: %1 по причине: %2'"), 
			Объект.Ссылка,
			ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		
	КонецПопытки;
	
	Прочитать();
	
КонецПроцедуры

#КонецОбласти

#Область СтандартныеПодсистемы

// СтандартныеПодсистемы.ПодключаемыеКоманды

&НаКлиенте
Процедура Подключаемый_ВыполнитьКоманду(Команда)
	МодульПодключаемыеКомандыКлиент = ОбщегоНазначенияКлиент.ОбщийМодуль("ПодключаемыеКомандыКлиент");
	МодульПодключаемыеКомандыКлиент.ВыполнитьКоманду(ЭтотОбъект, Команда, Объект);
КонецПроцедуры

&НаСервере
Процедура Подключаемый_ВыполнитьКомандуНаСервере(Контекст, Результат) Экспорт
	МодульПодключаемыеКоманды = ОбщегоНазначения.ОбщийМодуль("ПодключаемыеКоманды");
	МодульПодключаемыеКоманды.ВыполнитьКоманду(ЭтотОбъект, Контекст, Объект, Результат);
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ОбновитьКоманды()
	МодульПодключаемыеКомандыКлиентСервер = ОбщегоНазначенияКлиент.ОбщийМодуль("ПодключаемыеКомандыКлиентСервер");
	МодульПодключаемыеКомандыКлиентСервер.ОбновитьКоманды(ЭтотОбъект, Объект);
КонецПроцедуры

// Конец СтандартныеПодсистемы.ПодключаемыеКоманды

#КонецОбласти
