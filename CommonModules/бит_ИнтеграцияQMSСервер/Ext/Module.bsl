#Область ПланОбмена
 
Процедура ЗаданиеОбмена() Экспорт
	СтруктураПараметровЗапроса = ПолучитьСтруктуруПараметровЗапроса();
	АдресСервераQMS = СтруктураПараметровЗапроса.АдресСервераQMS;
	ДополнительныеПараметры = СтруктураПараметровЗапроса.ДополнительныеПараметры;
	СтруктураСообщенияЖурнала = СтруктураПараметровЗапроса.СтруктураСообщенияЖурнала;
	Узел = СтруктураПараметровЗапроса.Узел;
	ВыборкаИзменений = ПланыОбмена.ВыбратьИзменения(Узел, Узел.НомерОтправленного);
	//Проходим все зарегистрированные к обмену объекты
	Пока ВыборкаИзменений.Следующий() Цикл
		ОбъектКОбмену = ВыборкаИзменений.Получить();
		//Выгрузка номенклатуры
		Если ТипЗнч(ОбъектКОбмену) = Тип("СправочникОбъект.Номенклатура") Тогда  
			ФайлXML = XML_CreateUpdateProductWMHS(ОбъектКОбмену.Ссылка); 
			Ответ = КлиентHTTPКлиентСервер.ОтправитьФайл(АдресСервераQMS, ФайлXML, ДополнительныеПараметры);
			ТелоОтвета = Ответ.Тело.Body.CreateUpdateProductWMHSResponse.Response;
			СтатусОтвета = Лев(ТелоОтвета, 1);
			Если СтатусОтвета = "0" Тогда
				СтруктураСообщенияЖурнала.Комментарий = ТелоОтвета;
				ЗаписатьВЖурналРегистрации(СтруктураСообщенияЖурнала);
			ИначеЕсли СтатусОтвета = "1" Тогда
				ПланыОбмена.УдалитьРегистрациюИзменений(Узел, ОбъектКОбмену);
			КонецЕсли;	
		КонецЕсли;
		//Выгрузка источников финансирования
		Если ТипЗнч(ОбъектКОбмену) = Тип("СправочникОбъект.ИсточникиФинансирования") Тогда  
			ФайлXML = XML_CreateUpdateFinanceWMHS(ОбъектКОбмену.Ссылка); 
			Ответ = КлиентHTTPКлиентСервер.ОтправитьФайл(АдресСервераQMS, ФайлXML, ДополнительныеПараметры);
			ТелоОтвета = Ответ.Тело.Body.CreateUpdateFinanceWMHSResponse.Response;
			СтатусОтвета = Лев(ТелоОтвета, 1);
			Если СтатусОтвета = "0" Тогда
				СтруктураСообщенияЖурнала.Комментарий = ТелоОтвета;
				ЗаписатьВЖурналРегистрации(СтруктураСообщенияЖурнала);
			ИначеЕсли СтатусОтвета = "1" Тогда
				ПланыОбмена.УдалитьРегистрациюИзменений(Узел, ОбъектКОбмену);
			КонецЕсли;	
		КонецЕсли;
		//Выгрузка источников финансирования
		Если ТипЗнч(ОбъектКОбмену) = Тип("СправочникОбъект.ИсточникиФинансирования") Тогда  
			ФайлXML = XML_CreateUpdateFinanceWMHS(ОбъектКОбмену.Ссылка); 
			Ответ = КлиентHTTPКлиентСервер.ОтправитьФайл(АдресСервераQMS, ФайлXML, ДополнительныеПараметры);
			ТелоОтвета = Ответ.Тело.Body.CreateUpdateFinanceWMHSResponse.Response;
			СтатусОтвета = Лев(ТелоОтвета, 1);
			Если СтатусОтвета = "0" Тогда
				СтруктураСообщенияЖурнала.Комментарий = ТелоОтвета;
				ЗаписатьВЖурналРегистрации(СтруктураСообщенияЖурнала);
			ИначеЕсли СтатусОтвета = "1" Тогда
				ПланыОбмена.УдалитьРегистрациюИзменений(Узел, ОбъектКОбмену);	
			КонецЕсли;	
		КонецЕсли;
		//Выгрузка даты запрета изменения данных
		Если ТипЗнч(ОбъектКОбмену) = Тип("РегистрСведенийНаборЗаписей.ДатыЗапретаИзменения") Тогда	
			Запрос = Новый Запрос;
			Запрос.Текст = 
				"ВЫБРАТЬ
				|	ДатыЗапретаИзменения.Объект КАК Объект,
				|	ДатыЗапретаИзменения.ОписаниеДатыЗапрета КАК ОписаниеДатыЗапрета,
				|	ДатыЗапретаИзменения.Пользователь КАК Пользователь,
				|	ДатыЗапретаИзменения.ДатаЗапрета КАК ДатаЗапрета
				|ИЗ
				|	РегистрСведений.ДатыЗапретаИзменения КАК ДатыЗапретаИзменения,
				|	РегистрСведений.ДатыЗапретаИзменения.Изменения КАК ДатыЗапретаИзмененияИзменения
				|ГДЕ
				|	ДатыЗапретаИзменения.Пользователь = &Пользователь";
			
			Запрос.УстановитьПараметр("Пользователь", Перечисления.ВидыНазначенияДатЗапрета.ДляВсехПользователей);
			
			РезультатЗапроса = Запрос.Выполнить();
			
			Выборка = РезультатЗапроса.Выбрать();
			
			Пока Выборка.Следующий() Цикл
				ДатаЗапрета = ДатыЗапретаИзмененияСлужебный.ДатаЗапретаПоОписанию(Выборка.ОписаниеДатыЗапрета, Выборка.ДатаЗапрета);
				ДатаЗапрета =  Формат(ДатаЗапрета, "ДФ=yyyy-MM-dd");
				КодПодразделения = КодОбъекта(Выборка.Объект);
				Если ЗначениеЗаполнено(Выборка.Объект) Тогда
					КодПодразделения = КодОбъекта(Выборка.Объект);
				Иначе
					КодПодразделения = "000001";
				КонецЕсли;
				ФайлXML = XML_CloseDepartmentPeriodIWMHS(КодПодразделения, ДатаЗапрета); 
				Ответ = КлиентHTTPКлиентСервер.ОтправитьФайл(АдресСервераQMS, ФайлXML, ДополнительныеПараметры);
				ТелоОтвета = Ответ.Тело.Body.CloseDepartmentPeriodIWMHSResponse.Response;
				СтатусОтвета = Лев(ТелоОтвета, 1);
				Если СтатусОтвета = "0" Тогда
					СтруктураСообщенияЖурнала.Комментарий = ТелоОтвета;
					ЗаписатьВЖурналРегистрации(СтруктураСообщенияЖурнала);
				ИначеЕсли СтатусОтвета = "1" Тогда
					ПланыОбмена.УдалитьРегистрациюИзменений(Узел, ОбъектКОбмену);
				КонецЕсли;
			КонецЦикла;	
		КонецЕсли;
		//Выгрузка документов Отпуск в отделение
		Если ТипЗнч(ОбъектКОбмену) = Тип("ДокументОбъект.ОтпускТоваровВОтделение") Тогда
			ФайлXML = XML_CreateDocumentWMHS(ОбъектКОбмену.Ссылка); 
			Ответ = КлиентHTTPКлиентСервер.ОтправитьФайл(АдресСервераQMS, ФайлXML, ДополнительныеПараметры);
			ТелоОтвета = Ответ.Тело.Body.CreateDocumentWMHSResponse.Response;
			СтатусОтвета = Лев(ТелоОтвета, 1);
			Если СтатусОтвета = "0" Тогда
				СтруктураСообщенияЖурнала.Комментарий = ТелоОтвета;
				ЗаписатьВЖурналРегистрации(СтруктураСообщенияЖурнала);
			ИначеЕсли СтатусОтвета = "1" Тогда
				ПланыОбмена.УдалитьРегистрациюИзменений(Узел, ОбъектКОбмену);
				ОбъектКОбмену.Бит_ОтправленВQMS = Истина;
				ОбъектКОбмену.Записать();
			КонецЕсли;	
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

Процедура бит_ДатаЗапретаQMSПриЗаписиПриЗаписи(Источник, Отказ, Замещение) Экспорт 
	Если Источник.Отбор.Пользователь.Значение = Перечисления.ВидыНазначенияДатЗапрета.ДляВсехПользователей Тогда
		ЗарегистрироватьОбъектКОбмену(Источник);
	КонецЕсли;
КонецПроцедуры

Процедура ЗарегистрироватьОбъектКОбмену(Объект) Экспорт
	СтруктураПараметровЗапроса = ПолучитьСтруктуруПараметровЗапроса();
	Узел = СтруктураПараметровЗапроса.Узел;
	ПланыОбмена.ЗарегистрироватьИзменения(Узел, Объект);
КонецПроцедуры

#КонецОбласти

#Область XMLGET

Функция XML_GetFinanceListWMHS() 

	СтруктураТиповEnvelopeBody = ПолучитьСтруктуруТиповEnvelopeBody();
	ТипGetFinanceListWMHS = СтруктураТиповEnvelopeBody.ТипBody.Свойства.Получить("GetFinanceListWMHS").Тип;	

	ОбъектXDTOGetFinanceListWMHS = ФабрикаXDTO.Создать(ТипGetFinanceListWMHS); 

	ОбъектXDTOGetFinanceListWMHS.RequestName = "";
	ОбъектXDTOGetFinanceListWMHS.pIDo = ИдентификаторОрганизации();

																						  
	ОбъектBodyXDTO = ФабрикаXDTO.Создать(СтруктураТиповEnvelopeBody.ТипBody); 
	ОбъектBodyXDTO.GetFinanceListWMHS = ОбъектXDTOGetFinanceListWMHS;

	Возврат СоздатьЗаписатьВXMLОбъектEnvelopeXDTO(СтруктураТиповEnvelopeBody.ТипEnvelope, ОбъектBodyXDTO);

КонецФункции

Функция XML_GetDepartmentListWMHS() 

	СтруктураТиповEnvelopeBody = ПолучитьСтруктуруТиповEnvelopeBody();
	ТипGetDepartmentListWMHS = СтруктураТиповEnvelopeBody.ТипBody.Свойства.Получить("GetDepartmentListWMHS").Тип;	

	ОбъектXDTOGetDepartmentListWMHS = ФабрикаXDTO.Создать(ТипGetDepartmentListWMHS); 

	ОбъектXDTOGetDepartmentListWMHS.RequestName = "";
	ОбъектXDTOGetDepartmentListWMHS.pIDo = ИдентификаторОрганизации();

	ОбъектBodyXDTO = ФабрикаXDTO.Создать(СтруктураТиповEnvelopeBody.ТипBody); 
	ОбъектBodyXDTO.GetDepartmentListWMHS = ОбъектXDTOGetDepartmentListWMHS;

	Возврат СоздатьЗаписатьВXMLОбъектEnvelopeXDTO(СтруктураТиповEnvelopeBody.ТипEnvelope, ОбъектBodyXDTO);

КонецФункции 

Функция XML_GetDEPAWMHS(ДатаНачала,ДатаОкончания)Экспорт 

	СтруктураТиповEnvelopeBody = ПолучитьСтруктуруТиповEnvelopeBody();
	ТипGetDEPAWMHS = СтруктураТиповEnvelopeBody.ТипBody.Свойства.Получить("GetDEPAWMHS").Тип;	

	ОбъектXDTOGetDEPAWMHS = ФабрикаXDTO.Создать(ТипGetDEPAWMHS);  

	ОбъектXDTOGetDEPAWMHS.pIDo = ИдентификаторОрганизации();
	ОбъектXDTOGetDEPAWMHS.DateBegin = Формат(ДатаНачала,"ДФ=yyyy-MM-dd");
	ОбъектXDTOGetDEPAWMHS.DateEnd = Формат(ДатаОкончания,"ДФ=yyyy-MM-dd");
	ОбъектXDTOGetDEPAWMHS.sdstDoc = "1";
	ОбъектXDTOGetDEPAWMHS.DepCodeFrom = "";
	ОбъектXDTOGetDEPAWMHS.RequestName = "";
	
	ОбъектBodyXDTO = ФабрикаXDTO.Создать(СтруктураТиповEnvelopeBody.ТипBody); 
	ОбъектBodyXDTO.GetDEPAWMHS = ОбъектXDTOGetDEPAWMHS;

	Возврат СоздатьЗаписатьВXMLОбъектEnvelopeXDTO(СтруктураТиповEnvelopeBody.ТипEnvelope, ОбъектBodyXDTO);

КонецФункции 

Функция XML_GetAPTRWMHS(ДатаНачала,ДатаОкончания) Экспорт
	
	СтруктураТиповEnvelopeBody = ПолучитьСтруктуруТиповEnvelopeBody();
	ТипGetAPTRWMHS = СтруктураТиповEnvelopeBody.ТипBody.Свойства.Получить("GetAPTRWMHS").Тип;
	
	ОбъектXDTOGetAPTRWMHS = ФабрикаXDTO.Создать(ТипGetAPTRWMHS);
	
	ОбъектXDTOGetAPTRWMHS.pIDo = ИдентификаторОрганизации(); 	
	ОбъектXDTOGetAPTRWMHS.DateBegin = Формат(ДатаНачала,"ДФ=yyyy-MM-dd");
	ОбъектXDTOGetAPTRWMHS.DateEnd = Формат(ДатаОкончания,"ДФ=yyyy-MM-dd");
	ОбъектXDTOGetAPTRWMHS.sdstDoc = "1";
	ОбъектXDTOGetAPTRWMHS.DepCodeFrom = "";
	ОбъектXDTOGetAPTRWMHS.RequestName = "";
	
	ОбъектBodyXDTO = ФабрикаXDTO.Создать(СтруктураТиповEnvelopeBody.ТипBody); 
	ОбъектBodyXDTO.GetAPTRWMHS = ОбъектXDTOGetAPTRWMHS;
	
	Возврат СоздатьЗаписатьВXMLОбъектEnvelopeXDTO(СтруктураТиповEnvelopeBody.ТипEnvelope, ОбъектBodyXDTO)
	
КонецФункции 

Функция XML_CreateUpdateProductWMHS(Номенклатура)  
	
	СтруктураТиповEnvelopeBody = ПолучитьСтруктуруТиповEnvelopeBody();
	ТипCreateUpdateProductWMHS = СтруктураТиповEnvelopeBody.ТипBody.Свойства.Получить("CreateUpdateProductWMHS").Тип;
	ТипProduct = ТипCreateUpdateProductWMHS.Свойства.Получить("Product").Тип;
	
	НоменклатураXDTO = ФабрикаXDTO.Создать(ТипProduct);
	
	НоменклатураРЛС = Номенклатура.ЭлементКАТ;
	
	НоменклатураXDTO.BarcodeMain = НоменклатураРЛС.Штрихкоды[0].Штрихкод;
																																							
	//НоменклатураXDTO.ESKLP = НоменклатураРЛС.АТХ.КодЕСКЛП;
	НоменклатураXDTO.Name = НоменклатураРЛС.Наименование;
	Если НоменклатураРЛС.ГруппаПКУ.Наименование = "Лекарственные препараты неподлежащие ПКУ" Тогда 
		НоменклатураXDTO.PKU = 0;
	Иначе
		НоменклатураXDTO.PKU = 1;
	КонецЕсли;
	НоменклатураXDTO.ProductCode = Номенклатура.Код;
	НоменклатураXDTO.ProductGroup = Номенклатура.ВидНоменклатуры.ГруппаБухгалтерскогоУчета.Наименование;
	НоменклатураXDTO.RLS = НоменклатураРЛС.НомерРЛС;
	НоменклатураXDTO.Ration = НоменклатураРЛС.Упаковка.Коэффициент;
	НоменклатураXDTO.Category = КодОбъекта(Номенклатура.ВидНоменклатуры);
	НоменклатураXDTO.SubCategory = КодОбъекта(Номенклатура.ВидНоменклатуры);
	НоменклатураXDTO.UnitCodeMax = НоменклатураРЛС.Упаковка.Наименование;
	НоменклатураXDTO.UnitCodeMin = НоменклатураРЛС.Упаковка.БазоваяЕдиницаИзмерения.Наименование;
	
	ОбъектXDTOCreateUpdateProductWMHS = ФабрикаXDTO.Создать(ТипCreateUpdateProductWMHS);
	
	ОбъектXDTOCreateUpdateProductWMHS.Product = НоменклатураXDTO;
	ОбъектXDTOCreateUpdateProductWMHS.RequestName = "";
	ОбъектXDTOCreateUpdateProductWMHS.pIDo = ИдентификаторОрганизации(); 
	
	ОбъектBodyXDTO = ФабрикаXDTO.Создать(СтруктураТиповEnvelopeBody.ТипBody); 
	ОбъектBodyXDTO.CreateUpdateProductWMHS = ОбъектXDTOCreateUpdateProductWMHS;
	 
	Возврат СоздатьЗаписатьВXMLОбъектEnvelopeXDTO(СтруктураТиповEnvelopeBody.ТипEnvelope, ОбъектBodyXDTO)
		
КонецФункции

Функция XML_VerifyChangeUnitRatioWMHS(НоменклатураВладельца) 
	
	СтруктураТиповEnvelopeBody = ПолучитьСтруктуруТиповEnvelopeBody();
	ТипVerifyChangeUnitRatioWMHS = СтруктураТиповEnvelopeBody.ТипBody.Свойства.Получить("VerifyChangeUnitRatioWMHS").Тип;
	
	ПроверкаУпаковкиXDTO = ФабрикаXDTO.Создать(ТипVerifyChangeUnitRatioWMHS); 
	
	ПроверкаУпаковкиXDTO.pIDo = ИдентификаторОрганизации();
	ПроверкаУпаковкиXDTO.ProductCode = НоменклатураВладельца.ЭлементКАТ.Код;
	ПроверкаУпаковкиXDTO.RequestName = "";  
	
	ОбъектBodyXDTO = ФабрикаXDTO.Создать(СтруктураТиповEnvelopeBody.ТипBody); 
	ОбъектBodyXDTO.VerifyChangeUnitRatioWMHS = ПроверкаУпаковкиXDTO;
	 
	Возврат СоздатьЗаписатьВXMLОбъектEnvelopeXDTO(СтруктураТиповEnvelopeBody.ТипEnvelope, ОбъектBodyXDTO)
																	 
КонецФункции 

Функция XML_CreatePresenceAPTOSTWMHS(НоменклатураВладельца) 
	
	СтруктураТиповEnvelopeBody = ПолучитьСтруктуруТиповEnvelopeBody();
	ТипCreatePresenceAPTOSTWMHS = СтруктураТиповEnvelopeBody.ТипBody.Свойства.Получить("pCreatePresenceAPTOSTWMHS").Тип;

	ОстаткиXDTO = ФабрикаXDTO.Создать(ТипCreatePresenceAPTOSTWMHS); 
																		  
	
	//... 
	
	ОбъектBodyXDTO = ФабрикаXDTO.Создать(СтруктураТиповEnvelopeBody.ТипBody); 
	ОбъектBodyXDTO.pCreatePresenceAPTOSTWMHS = ОстаткиXDTO;
	 
	Возврат СоздатьЗаписатьВXMLОбъектEnvelopeXDTO(СтруктураТиповEnvelopeBody.ТипEnvelope, ОбъектBodyXDTO)

КонецФункции

Функция XML_CreateUpdateFinanceWMHS(ИсточникФинансирования) 
	
	СтруктураТиповEnvelopeBody = ПолучитьСтруктуруТиповEnvelopeBody();
	ТипCreateUpdateFinanceWMHS = СтруктураТиповEnvelopeBody.ТипBody.Свойства.Получить("CreateUpdateFinanceWMHS").Тип;	
	ТипFinance = ТипCreateUpdateFinanceWMHS.Свойства.Получить("Finance").Тип;
	
	ИсточникФинансированияXDTO = ФабрикаXDTO.Создать(ТипFinance); 
	
	ИсточникФинансированияXDTO.FinanceName = ИсточникФинансирования.Наименование;
	ИсточникФинансированияXDTO.FinanceCode = ИсточникФинансирования.Код; 
	
	ОбъектXDTOCreateUpdateFinanceWMHS = ФабрикаXDTO.Создать(ТипCreateUpdateFinanceWMHS);
																														 
	ОбъектXDTOCreateUpdateFinanceWMHS.Finance = ИсточникФинансированияXDTO;
	ОбъектXDTOCreateUpdateFinanceWMHS.RequestName = "";
	ОбъектXDTOCreateUpdateFinanceWMHS.pIDo = ИдентификаторОрганизации();
	
	ОбъектBodyXDTO = ФабрикаXDTO.Создать(СтруктураТиповEnvelopeBody.ТипBody); 
	ОбъектBodyXDTO.CreateUpdateFinanceWMHS = ОбъектXDTOCreateUpdateFinanceWMHS;

	Возврат СоздатьЗаписатьВXMLОбъектEnvelopeXDTO(СтруктураТиповEnvelopeBody.ТипEnvelope, ОбъектBodyXDTO)

КонецФункции

Функция XML_CloseDepartmentPeriodIWMHS(КодПодразделения, ДатаЗапрета) 
	СтруктураТиповEnvelopeBody = ПолучитьСтруктуруТиповEnvelopeBody();
	ТипCloseDepartmentPeriodIWMHS = СтруктураТиповEnvelopeBody.ТипBody.Свойства.Получить("CloseDepartmentPeriodIWMHS").Тип;
	
	CloseDepartmentPeriodIWMHSXDTO = ФабрикаXDTO.Создать(ТипCloseDepartmentPeriodIWMHS); 

	CloseDepartmentPeriodIWMHSXDTO.pIDo = ИдентификаторОрганизации();
	CloseDepartmentPeriodIWMHSXDTO.DepCode = КодПодразделения;
	CloseDepartmentPeriodIWMHSXDTO.Date = ДатаЗапрета;
	CloseDepartmentPeriodIWMHSXDTO.RequestName = "";
	
	ОбъектBodyXDTO = ФабрикаXDTO.Создать(СтруктураТиповEnvelopeBody.ТипBody); 
	ОбъектBodyXDTO.CloseDepartmentPeriodIWMHS = CloseDepartmentPeriodIWMHSXDTO;
	 
	Возврат СоздатьЗаписатьВXMLОбъектEnvelopeXDTO(СтруктураТиповEnvelopeBody.ТипEnvelope, ОбъектBodyXDTO)
 
КонецФункции

Функция XML_CreateDocumentWMHS(Документ) Экспорт
	СтруктураТиповEnvelopeBody = ПолучитьСтруктуруТиповEnvelopeBody();
	ТипCreateDocumentWMHS = СтруктураТиповEnvelopeBody.ТипBody.Свойства.Получить("CreateDocumentWMHS").Тип;
	ТипItems = ТипCreateDocumentWMHS.Свойства.Получить("Items").Тип; 
	ТипProductTransferStructure = ТипItems.Свойства.Получить("ProductTransferStructure").Тип;
	ТипCategory = ТипProductTransferStructure.Свойства.Получить("Category").Тип;
	ТипFinance = ТипProductTransferStructure.Свойства.Получить("Finance").Тип;
	ТипMDLP = ТипProductTransferStructure.Свойства.Получить("MDLP").Тип;
	ТипMDLPStructure = ТипMDLP.Свойства.Получить("MDLPStructure").Тип;
	
	CreateDocumentWMHSXDTO = ФабрикаXDTO.Создать(ТипCreateDocumentWMHS); 

	CreateDocumentWMHSXDTO.pIDo = ИдентификаторОрганизации();
	CreateDocumentWMHSXDTO.DocNum = Документ.Номер;
	CreateDocumentWMHSXDTO.DocDate = Документ.Дата;
	CreateDocumentWMHSXDTO.DocType = "отпуск_на_отделение";
	Если ЗначениеЗаполнено(Документ.ТребованиеОтделения) Тогда
		CreateDocumentWMHSXDTO.OrderNum = Документ.ТребованиеОтделения.Номер;
		CreateDocumentWMHSXDTO.OrderDate = Документ.ТребованиеОтделения.Дата;
	КонецЕсли;
	CreateDocumentWMHSXDTO.DepStoreCode = КодОбъекта(Документ.СкладПолучатель);
	CreateDocumentWMHSXDTO.PharmStoreCode = КодОбъекта(Документ.СкладОтправитель);
	CreateDocumentWMHSXDTO.RequestName = "";
	
	ОбъектItems = ФабрикаXDTO.Создать(ТипItems);
	
	Для Каждого Товар Из Документ.Товары Цикл
		ОбъектProductTransferStructureXDTO = ФабрикаXDTO.Создать(ТипProductTransferStructure);
		ОбъектProductTransferStructureXDTO.ItemsKey = Товар.НомерСтроки;
		ОбъектCategoryXDTO = ФабрикаXDTO.Создать(ТипCategory);
		ОбъектCategoryXDTO.ProductCode = Товар.Номенклатура.Код;
		ОбъектCategoryXDTO.Name = Товар.Номенклатура.Наименование;
		//ОбъектCategoryXDTO.ESKLP = Товар.Номенклатура.ЭлементКАТ.АТХ.КодЕСКЛП;
		ОбъектCategoryXDTO.Ration = Товар.Коэффициент;
		ОбъектCategoryXDTO.Category = КодОбъекта(Товар.Номенклатура.ВидНоменклатуры);
		ОбъектCategoryXDTO.SubCategory = КодОбъекта(Товар.Номенклатура.ВидНоменклатуры); 
		Если ЗначениеЗаполнено(Товар.Номенклатура.ЭлементКАТ) Тогда
			ОбъектCategoryXDTO.UnitCodeMax = Товар.Номенклатура.ЭлементКАТ.Упаковка.Наименование;
			ОбъектCategoryXDTO.UnitCodeMin = Товар.Номенклатура.ЭлементКАТ.Упаковка.БазоваяЕдиницаИзмерения.Наименование;
		Иначе
			ОбъектCategoryXDTO.UnitCodeMax = Товар.ЕдиницаИзмерения.Наименование;
			ОбъектCategoryXDTO.UnitCodeMin = Товар.ЕдиницаИзмерения.Наименование;
		КонецЕсли;
		ОбъектProductTransferStructureXDTO.Category = ОбъектCategoryXDTO;
		ОбъектProductTransferStructureXDTO.ProductSerial = Строка(Товар.СерияНоменклатуры);
		ОбъектProductTransferStructureXDTO.Barcode = Товар.Штрихкод; 
		ОбъектProductTransferStructureXDTO.Price = Товар.Коэффициент;
		ОбъектProductTransferStructureXDTO.NumMin = Товар.Количество; 
		ОбъектProductTransferStructureXDTO.NumMax = Товар.КоличествоВЕдиницахИзмерения;
		Если ЗначениеЗаполнено(Товар.Номенклатура.ЭлементКАТ) Тогда
			ОбъектProductTransferStructureXDTO.ValidityPeriod = Формат(ДобавитьМесяц(ТекущаяДата(), Товар.Номенклатура.ЭлементКАТ.СрокГодности), "ДФ=yyyy-MM-dd");
		КонецЕсли;
		ОбъектFinanceXDTO = ФабрикаXDTO.Создать(ТипFinance);
		ОбъектFinanceXDTO.FinanceName = Товар.ИсточникФинансирования.Наименование;
		ОбъектFinanceXDTO.FinanceCode = Товар.ИсточникФинансирования.Код;
		ОбъектProductTransferStructureXDTO.Finance = ОбъектFinanceXDTO; 
		//ОбъектProductTransferStructure.KSU
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	УведомлениеОВыдачеВОтделенияМДЛП.Ссылка КАК УведомлениеМДЛП
			|ИЗ
			|	Документ.УведомлениеОВыдачеВОтделенияМДЛП КАК УведомлениеОВыдачеВОтделенияМДЛП
			|ГДЕ
			|	УведомлениеОВыдачеВОтделенияМДЛП.Основание = &Основание";
		
		Запрос.УстановитьПараметр("Основание", Документ);
		
		РезультатЗапроса = Запрос.Выполнить();
		
		Выборка = РезультатЗапроса.Выбрать();
		
		ОбъектMDLPXDTO = ФабрикаXDTO.Создать(ТипMDLP);
		Если Выборка.Следующий() Тогда
			НомераКИЗ = НомераКИЗ(Товар.Номенклатура, Выборка.УведомлениеМДЛП);
			Если НомераКИЗ <> Неопределено Тогда	
				Для Каждого НомерКИЗ Из НомераКИЗ Цикл
					ОбъектMDLPStructureXDTO = ФабрикаXDTO.Создать(ТипMDLPStructure);
					ОбъектMDLPStructureXDTO.MDLPKey = НомерКИЗ.НомерСтроки;
					ОбъектMDLPStructureXDTO.SGTIN = НомерКИЗ.GTIN;
					ОбъектMDLPStructureXDTO.NumMark = 1;
					ОбъектMDLPXDTO.MDLPStructure.Добавить(ОбъектMDLPStructureXDTO);
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
		ОбъектProductTransferStructureXDTO.MDLP = ОбъектMDLPXDTO;
 
		ОбъектItems.ProductTransferStructure.Добавить(ОбъектProductTransferStructureXDTO);
	КонецЦикла;
	
	CreateDocumentWMHSXDTO.Items = ОбъектItems;
	
	ОбъектBodyXDTO = ФабрикаXDTO.Создать(СтруктураТиповEnvelopeBody.ТипBody); 
	ОбъектBodyXDTO.CreateDocumentWMHS = CreateDocumentWMHSXDTO;
	 
	Возврат СоздатьЗаписатьВXMLОбъектEnvelopeXDTO(СтруктураТиповEnvelopeBody.ТипEnvelope, ОбъектBodyXDTO)
	
КонецФункции

Функция XML_VerifyDocumentMinusWMHS(Документ) Экспорт
	
	СтруктураТиповEnvelopeBody = ПолучитьСтруктуруТиповEnvelopeBody();
	ТипVerifyDocumentMinusWMHS = СтруктураТиповEnvelopeBody.ТипBody.Свойства.Получить("VerifyDocumentMinusWMHS").Тип;
	
	ОбъектVerifyDocumentMinusWMHS = ФабрикаXDTO.Создать(ТипVerifyDocumentMinusWMHS);
	
	ОбъектVerifyDocumentMinusWMHS.pIDo = ИдентификаторОрганизации();
	ОбъектVerifyDocumentMinusWMHS.DocNum = Документ.Номер; 
	ОбъектVerifyDocumentMinusWMHS.DocDate = Документ.Дата;
	ОбъектVerifyDocumentMinusWMHS.RequestName = "";
	
	ОбъектBodyXDTO = ФабрикаXDTO.Создать(СтруктураТиповEnvelopeBody.ТипBody); 
	ОбъектBodyXDTO.VerifyDocumentMinusWMHS = ОбъектVerifyDocumentMinusWMHS;

	Возврат СоздатьЗаписатьВXMLОбъектEnvelopeXDTO(СтруктураТиповEnvelopeBody.ТипEnvelope, ОбъектBodyXDTO)
	
КонецФункции 

Функция XML_DeleteDocumentWMHS(Документ) Экспорт
	
	СтруктураТиповEnvelopeBody = ПолучитьСтруктуруТиповEnvelopeBody();
	ТипDeleteDocumentWMHS = СтруктураТиповEnvelopeBody.ТипBody.Свойства.Получить("DeleteDocumentWMHS").Тип;
	
	ОбъектDeleteDocumentWMHS = ФабрикаXDTO.Создать(ТипDeleteDocumentWMHS);
	
	ОбъектDeleteDocumentWMHS.pIDo = ИдентификаторОрганизации();
	ОбъектDeleteDocumentWMHS.DocNum = Документ.Номер;
	ОбъектDeleteDocumentWMHS.StoreCod = КодОбъекта(Документ.СкладПолучатель); 
	ОбъектDeleteDocumentWMHS.DocDate = Документ.Дата;
	ОбъектDeleteDocumentWMHS.RequestName = "";
	
	ОбъектBodyXDTO = ФабрикаXDTO.Создать(СтруктураТиповEnvelopeBody.ТипBody); 
	ОбъектBodyXDTO.DeleteDocumentWMHS = ОбъектDeleteDocumentWMHS;

	Возврат СоздатьЗаписатьВXMLОбъектEnvelopeXDTO(СтруктураТиповEnvelopeBody.ТипEnvelope, ОбъектBodyXDTO)
	
КонецФункции

Функция СоздатьЗаписатьВXMLОбъектEnvelopeXDTO(ТипEnvelope, ОбъектBodyXDTO)
	
	ОбъектEnvelopeXDTO = ФабрикаXDTO.Создать(ТипEnvelope);
	ОбъектEnvelopeXDTO.Body.Добавить(ОбъектBodyXDTO);
	
	ИмяПромежуточногоФайла = ПолучитьИмяВременногоФайла("xml"); 

	ЗаписьXML = Новый ЗаписьXML();
	ЗаписьXML.ОткрытьФайл(ИмяПромежуточногоФайла, "UTF-8");
	ФабрикаXDTO.ЗаписатьXML(ЗаписьXML, ОбъектEnvelopeXDTO);
	ЗаписьXML.Закрыть();
	
	ФайлXML = Новый Файл(ИмяПромежуточногоФайла);
	
	Возврат ФайлXML;
	
КонецФункции

#КонецОбласти  

#Область ВыгрузкаДанных 

Функция ПроверитьДвиженияНоменклатурыВQMS(Номенклатура) Экспорт
	СтруктураПараметровЗапроса = ПолучитьСтруктуруПараметровЗапроса();
	АдресСервераQMS = СтруктураПараметровЗапроса.АдресСервераQMS;
	ДополнительныеПараметры = СтруктураПараметровЗапроса.ДополнительныеПараметры;
	СтруктураСообщенияЖурнала = СтруктураПараметровЗапроса.СтруктураСообщенияЖурнала;
	
	ФайлXML = XML_VerifyChangeUnitRatioWMHS(Номенклатура); 
	Ответ = КлиентHTTPКлиентСервер.ОтправитьФайл(АдресСервераQMS, ФайлXML, ДополнительныеПараметры);
	ТелоОтвета = Ответ.Тело.Body.VerifyChangeUnitRatioWMHSResponse.Response;
	СтатусОтвета = Лев(ТелоОтвета, 1);
	Если СтатусОтвета = "0" Тогда
		СтруктураСообщенияЖурнала.Комментарий = ТелоОтвета;
		бит_ИнтеграцияQMSСервер.ЗаписатьВЖурналРегистрации(СтруктураСообщенияЖурнала);
		Возврат Ложь;
	ИначеЕсли СтатусОтвета = "1" Тогда
		
		Возврат Истина;	
		
	КонецЕсли;
КонецФункции

Функция ПроверитьДвиженияДокументаВQMS(Документ) Экспорт
	Если Документ.Статус = Перечисления.СтатусыПеремещенийТоваров.Принято И Документ.Бит_ОтправленВQMS Тогда
		СтруктураПараметровЗапроса = ПолучитьСтруктуруПараметровЗапроса();
		АдресСервераQMS = СтруктураПараметровЗапроса.АдресСервераQMS;
		ДополнительныеПараметры = СтруктураПараметровЗапроса.ДополнительныеПараметры;
		СтруктураСообщенияЖурнала = СтруктураПараметровЗапроса.СтруктураСообщенияЖурнала;
		Если Не РольДоступна("Бит_РедактироватьДокументБезПроверкиВQMS") Тогда
			ФайлXML = XML_VerifyDocumentMinusWMHS(Документ); 
			Ответ = КлиентHTTPКлиентСервер.ОтправитьФайл(АдресСервераQMS, ФайлXML, ДополнительныеПараметры);
			ТелоОтвета = Ответ.Тело.Body.VerifyDocumentMinusWMHSResponse.Response;
			СтатусОтвета = Лев(ТелоОтвета, 1);
			Если СтатусОтвета = "0" Тогда
				СтруктураСообщенияЖурнала.Комментарий = ТелоОтвета;
				бит_ИнтеграцияQMSСервер.ЗаписатьВЖурналРегистрации(СтруктураСообщенияЖурнала);
			ИначеЕсли СтатусОтвета = "1" Тогда
				РазрешеноУдаление = Ответ.Тело.Body.VerifyDocumentMinusWMHSResponse.DeleteAllowed;
				Если РазрешеноУдаление = "true" Тогда
					Возврат Истина;
				Иначе
					Возврат Ложь;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;			 
	КонецЕсли;
КонецФункции

Функция УдалитьДокументВQMS(Документ) Экспорт
	СтруктураПараметровЗапроса = ПолучитьСтруктуруПараметровЗапроса();
	АдресСервераQMS = СтруктураПараметровЗапроса.АдресСервераQMS;
	ДополнительныеПараметры = СтруктураПараметровЗапроса.ДополнительныеПараметры;
	СтруктураСообщенияЖурнала = СтруктураПараметровЗапроса.СтруктураСообщенияЖурнала;
	ФайлXML = XML_DeleteDocumentWMHS(Документ); 
	Ответ = КлиентHTTPКлиентСервер.ОтправитьФайл(АдресСервераQMS, ФайлXML, ДополнительныеПараметры);
	ТелоОтвета = Ответ.Тело.Body.DeleteDocumentWMHSResponse.Response;
	СтатусОтвета = Лев(ТелоОтвета, 1);
	Если СтатусОтвета = "0" Тогда
		СтруктураСообщенияЖурнала.Комментарий = ТелоОтвета;
		бит_ИнтеграцияQMSСервер.ЗаписатьВЖурналРегистрации(СтруктураСообщенияЖурнала);
		Возврат Ложь;
	ИначеЕсли СтатусОтвета = "1" Тогда
		ДокументОбъект = Документ.ПолучитьОбъект();
		ДокументОбъект.Бит_ОтправленВQMS = Ложь; 
		ДокументОбъект.Записать();
		Возврат Истина;
	КонецЕсли;
КонецФункции

Функция НомераКИЗ(ТоварИзТребования, ДокументУведомлениеМДЛП)
	
	НомераКИЗ = Новый ТаблицаЗначений;
	НомераКИЗ.Колонки.Добавить("GTIN");
	НомераКИЗ.Колонки.Добавить("НомерКИЗ");
	НомераКИЗ.Колонки.Добавить("НомерСтроки");
	
	СтрокаТовара = ДокументУведомлениеМДЛП.Товары.Найти(ТоварИзТребования);
	
	Если СтрокаТовара = Неопределено Тогда
		Возврат Неопределено;	
	КонецЕсли;
	
	Сч = 1;
	
	Для Каждого НомерУпаковки Из ДокументУведомлениеМДЛП.НомераУпаковок Цикл 
		Если НомерУпаковки.ИдентификаторСтроки = СтрокаТовара.ИдентификаторСтроки Тогда
			СтрокаТаблицы = НомераКИЗ.Добавить();
			СтрокаТаблицы.GTIN = СтрокаТовара.GTIN;
			СтрокаТаблицы.НомерКИЗ = НомерУпаковки.НомерКИЗ;
			СтрокаТаблицы.НомерСтроки = Сч;
			Сч = Сч + 1;
		КонецЕсли;
	КонецЦикла;
	
	Возврат НомераКИЗ; 
	
КонецФункции

#КонецОбласти

#Область ЗагрузкаДанных 

   
Процедура ЗагрузитьПодразделения() Экспорт
	
	ФайлXML = XML_GetDepartmentListWMHS(); 

	Ответ = ОтветQMS(ФайлXML);
	
	Если Ответ <> Неопределено Тогда  		
		СписокПодразделенийИзQMS = Ответ.Тело.Body.GetDepartmentListWMHSResponse.DepartmentList.DepartmentStructure;
		ТелоОтвета = Ответ.Тело.Body.GetDepartmentListWMHSResponse.Response;
		Для Каждого ПодразделениеQMS Из СписокПодразделенийИзQMS Цикл  
			Если Не ЗначениеЗаполнено(Справочники.ПодразделенияОрганизаций.НайтиПоКоду(ПодразделениеQMS.DepartmentCode)) Тогда
				НовоеПодразделение = Справочники.ПодразделенияОрганизаций.СоздатьЭлемент();
				НовоеПодразделение.Код = ПодразделениеQMS.DepartmentCode;
				НовоеПодразделение.Наименование = ПодразделениеQMS.DepartmentName;
				НовоеПодразделение.Владелец = ОбъектПоКоду(ИдентификаторОрганизации());
				НовоеПодразделение.ОбменДанными.Загрузка = Истина;
				НовоеПодразделение.Записать();
			КонецЕсли;
		КонецЦикла;		
	КонецЕсли;
	
КонецПроцедуры

Функция ЗагрузитьИсточникиФинансирования() Экспорт
	
	ФайлXML = XML_GetFinanceListWMHS(); 
    Ответ = ОтветQMS(ФайлXML);
	Если Ответ <> Неопределено Тогда
		СписокИсточниковФинансированияИзQMS = Ответ.Тело.Body.GetFinanceListWMHSResponse.FinanceList.FinanceStructure;
	    Для Каждого ИсточникФинансированияQMS Из СписокИсточниковФинансированияИзQMS Цикл  
			Если НЕ ЗначениеЗаполнено(Справочники.ИсточникиФинансирования.НайтиПоКоду(ИсточникФинансированияQMS.FinanceCode)) Тогда
				НовыйИсточникФинансирования = Справочники.ИсточникиФинансирования.СоздатьЭлемент();
				НовыйИсточникФинансирования.Код = ИсточникФинансированияQMS.FinanceCode;
				НовыйИсточникФинансирования.Наименование = ИсточникФинансированияQMS.FinanceName;
				НовыйИсточникФинансирования.Записать();
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;   
	
КонецФункции

Процедура ЗагрузитьТребования(ДатаНачала = Неопределено, ДатаОкончания = Неопределено) Экспорт
	
	Если НЕ ЗначениеЗаполнено(ДатаНачала) Тогда
		ДатаНачала = НачалоДня(ТекущаяДатаСеанса());
	КонецЕсли;	
	Если НЕ ЗначениеЗаполнено(ДатаОкончания) Тогда
		ДатаОкончания =  НачалоДня(ТекущаяДатаСеанса());	
	КонецЕсли;
	
	ФайлXML = XML_GetDEPAWMHS(ДатаНачала,ДатаОкончания); 
	
	Ответ = ОтветQMS(ФайлXML);	
	Если Ответ <> Неопределено Тогда		
		ТаблицаВыгрузки = НоваяТаблицаProductTransferStructure();
		СписокXDTO = Ответ.Тело.Body.GetDEPAWMHSResponse.Product.ProductTransferStructure; 
		Для Каждого ЭлементСписка Из СписокXDTO Цикл
			СтрокаТаблицы = ТаблицаВыгрузки.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаТаблицы,ЭлементСписка);
		КонецЦикла;
		
		ТаблицаВыгрузкиПослеСвертки = ТаблицаВыгрузки.Скопировать();
		ТаблицаВыгрузкиПослеСвертки.Свернуть("DocType,DocNum,DocDate,DocOTD,DocSKL,DocOTDTO,DocSKLTO");
		Для Каждого СтрокаДок Из ТаблицаВыгрузкиПослеСвертки Цикл 
			ПараметрыОтбора = Новый Структура("DocNum,DocDate",СтрокаДок.DocNum,СтрокаДок.DocDate); 
			МассивСтрокСНоменклатурой = ТаблицаВыгрузки.НайтиСтроки(ПараметрыОтбора);
			ЗаполнитьТребованиеОтделения(СтрокаДок, МассивСтрокСНоменклатурой);
		КонецЦикла;	
	КонецЕсли; 
	
КонецПроцедуры

Процедура ЗагрузитьРасходныеДокументы(ДатаНачала = Неопределено, ДатаОкончания = Неопределено) Экспорт
	
	Если НЕ ЗначениеЗаполнено(ДатаНачала) Тогда
		ДатаНачала = НачалоДня(ТекущаяДатаСеанса());
	КонецЕсли;	
	Если НЕ ЗначениеЗаполнено(ДатаОкончания) Тогда
		ДатаОкончания =  НачалоДня(ТекущаяДатаСеанса());	
	КонецЕсли;
	
	ФайлXML = XML_GetAPTRWMHS(ДатаНачала,ДатаОкончания);
	
	Ответ = ОтветQMS(ФайлXML);
	
	Если Ответ <> Неопределено Тогда	
		ТаблицаВыгрузки = НоваяТаблицаProductTransferStructure(); 	
		СписокXDTO = Ответ.Тело.Body.GetAPTRWMHSResponse.Product.ProductTransferStructure;
		
		Для Каждого ЭлементСписка Из СписокXDTO Цикл
			СтрокаТаблицы = ТаблицаВыгрузки.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаТаблицы,ЭлементСписка);
		КонецЦикла;  
		
		ДокументыQMS = ТаблицаВыгрузки.Скопировать();
		ДокументыQMS.Свернуть("DocType,DocNum,DocDate,DocOTD,DocSKL"); 
		
		Для Каждого СтрокаДок Из ДокументыQMS Цикл 
			ПараметрыОтбора = Новый Структура("DocNum,DocDate",СтрокаДок.DocNum,СтрокаДок.DocDate);
			МассивСтрокСНоменклатурой = ТаблицаВыгрузки.НайтиСтроки(ПараметрыОтбора);
			ЗаполнитьРасходныеДокументы(СтрокаДок, МассивСтрокСНоменклатурой);
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры  

#КонецОбласти 

#Область ЗагрузкаДокументов 

Процедура ЗаполнитьТребованиеОтделения(Шапка, ТаблицаНоменклатуры)	
	
	ИмяДокумента = ИмяДокумента(Шапка.DocType); 
	Если ИмяДокумента = Неопределено Тогда
		Возврат
	КонецЕсли; 
	
	ШапкаДокумента = ЗаполнитьШапкуДокумента(Шапка, ТаблицаНоменклатуры);
	ШапкаДокумента.Вставить("ИмяДокумента",ИмяДокумента);  
	
	//Из кумыса приходит как ТЧ, в 1с - шапка. По словам Дмитрия Павлова, если  в доке кумыса есть вид ассигнования, то у всей номенклатуры он одинаковый 
	Для каждого Строка из ТаблицаНоменклатуры Цикл
		СтруктураИсточникФинансирования = НоваяСтруктураFinance();
		ЗаполнитьЗначенияСвойств(СтруктураИсточникФинансирования,Строка.Finance);
		Если ТипЗнч(СтруктураИсточникФинансирования.FinanceCode) = Тип("ОбъектXDTO") Тогда 
			ШапкаДокумента.Вставить("ИсточникФинансирования", Справочники.бит_НастройкиИнтеграцииQMS.ИсточникиФинансирования.Значение);//ПОКА ТАК 
			Прервать;
		Иначе
			ШапкаДокумента.Вставить("ИсточникФинансирования", Справочники.ИсточникиФинансирования.НайтиПоКоду(СтруктураИсточникФинансирования.FinanceCode));
			Прервать;
		КонецЕсли
	КонецЦикла;
	
	Товары = Новый Массив;
	Для Каждого Строка из ТаблицаНоменклатуры Цикл	
		
		СтруктураНоменклатура = НоваяСтруктураCategory();
		ЗаполнитьЗначенияСвойств(СтруктураНоменклатура,Строка.Category);
		Номенклатура = Неопределено;
		Номенклатура = НайтиНоменклатуру(?(ТипЗнч(СтруктураНоменклатура.BarcodeMain) = Тип("Строка"),
										СтруктураНоменклатура.BarcodeMain,""),СтруктураНоменклатура.ProductCode);//ПОКА ТАК
		
		ДанныеСтроки = Новый Структура();
		ДанныеСтроки.Вставить("Номенклатура",Номенклатура); //ПОКА ТАК, не знаю доделала ли Таня. Пока встает другая номенклатутра
		ДанныеСтроки.Вставить("ЕдиницаИзмерения", Номенклатура.ОсновнаяЕдиницаУчета);
		ДанныеСтроки.Вставить("КоличествоВЕдиницахИзмерения", СтроковыеФункцииКлиентСервер.СтрокаВЧисло(Строка.NumMax));
		
		Товары.Добавить(ДанныеСтроки);
	КонецЦикла;
	
	ТабличныеЧасти = Новый Структура();
	ТабличныеЧасти.Вставить("Товары",Товары);	
	
	ДанныеДокумента = Новый Структура;
	ДанныеДокумента.Вставить("ШапкаДокумента",ШапкаДокумента);
	ДанныеДокумента.Вставить("ТабличныеЧасти",ТабличныеЧасти); 
	
	ЗаписатьДокумент(ДанныеДокумента);
	
КонецПроцедуры  

Процедура ЗаполнитьРасходныеДокументы(Шапка, ТаблицаНоменклатуры)
	
	ИмяДокумента = ИмяДокумента(Шапка.DocType); 
	Если ИмяДокумента = Неопределено Тогда
		Возврат
	КонецЕсли;

	ШапкаДокумента = ЗаполнитьШапкуДокумента(Шапка, ТаблицаНоменклатуры);
	ШапкаДокумента.Вставить("ИмяДокумента",ИмяДокумента); 	
	
	ШапкаДокумента.Вставить("Склад",ОбъектПоКоду(Шапка.DocSKL));
	ШапкаДокумента.Вставить("ХозяйственнаяОперация",Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию);
	ШапкаДокумента.Вставить("ВидЦены",Справочники.ВидыЦен.НайтиПоНаименованию("Закупочная"));
	
	ШапкаДокумента.Вставить("СкладОтправитель", ОбъектПоКоду(Шапка.DocSKL));
	ШапкаДокумента.Вставить("СкладПолучатель",сок_Сервер.ПолучитьСкладАптека());
	ШапкаДокумента.Вставить("ПодразделениеОрганизации", сок_Сервер.ПолучитьПодразделениеАптека());
	
	ИсточникФинансирования = Неопределено;	
	Товары = Новый Массив;

	Для Каждого Строка Из ТаблицаНоменклатуры Цикл 
		
		СтруктураНоменклатура = НоваяСтруктураCategory();
		ЗаполнитьЗначенияСвойств(СтруктураНоменклатура,Строка.Category); 
		
		ДанныеСтроки = Новый Структура();

		
		НовСтр = Товары.Добавить();
		
		Номенлатура1С = Неопределено;
		МассивШтрихкодов = Новый Массив; 
		
		Если ТипЗнч(СтруктураНоменклатура.BarcodeMain) = Тип("Строка") И СтруктураНоменклатура.BarcodeMain <> "" Тогда
			МассивШтрихкодов = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(СтрЗаменить(СтруктураНоменклатура.BarcodeMain,"_",""));
		Иначе
			Номенлатура1С = НайтиНоменклатуру("",СтруктураНоменклатура.ProductCode);
		КонецЕсли;
				
		Для Каждого Элемент Из МассивШтрихкодов Цикл
			Если ЗначениеЗаполнено(Номенлатура1С) Тогда
				Прервать;
			Иначе
				Номенлатура1С = НайтиНоменклатуру(Элемент,СтруктураНоменклатура.ProductCode);
			КонецЕсли;
		КонецЦикла;
		
		
								
		ДанныеСтроки.Вставить("Номенклатура", Номенлатура1С);
		Если ЗначениеЗаполнено(Номенлатура1С) Тогда
			ДанныеСтроки.Вставить("ЕдиницаИзмерения", Номенлатура1С.ОсновнаяЕдиницаУчета);
		КонецЕсли;
		
		ДанныеСтроки.Вставить("КоличествоВЕдиницахИзмерения", СтроковыеФункцииКлиентСервер.СтрокаВЧисло(Строка.NumMax)); 
		ДанныеСтроки.Вставить("Количество", СтроковыеФункцииКлиентСервер.СтрокаВЧисло(Строка.NumMin));
		ДанныеСтроки.Вставить("Коэффициент",?(НовСтр.КоличествоВЕдиницахИзмерения = 0, 0,
								НовСтр.Количество / НовСтр.КоличествоВЕдиницахИзмерения));
		ДанныеСтроки.Вставить("СтатусУказанияСерий", 6);
		ДанныеСтроки.Вставить("СтатусУказанияПартий", 4);
		
		ДанныеСтроки.Вставить("СтатьяРасходов",?(Номенлатура1С.ЭтоЛекарственноеСредство,ПланыВидовХарактеристик.СтатьиРасходов.НайтиПоКоду("202"),
											ПланыВидовХарактеристик.СтатьиРасходов.НайтиПоКоду("203"))); 
		ДанныеСтроки.Вставить("АналитикаРасходов", ШапкаДокумента.Организация);
		
		ДанныеСтроки.Вставить("СтатусУказанияПартийОтправитель", 4);
		ДанныеСтроки.Вставить("СтатусУказанияПартийПолучатель", 4); 
		
		ДанныеСтроки.Вставить("СтатусУказанияСерийОтправитель", 6);
		ДанныеСтроки.Вставить("СтатусУказанияСерийПолучатель", 6);
								
		Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(Строка,"ProductSerial") И ТипЗнч(Строка.ProductSerial) = Тип("Строка") Тогда
			ДанныеСтроки.Вставить("СерияНоменклатуры", Справочники.СерииНоменклатуры.НайтиПоРеквизиту("Номер",Строка.ProductSerial));;
			Если Не ЗначениеЗаполнено(ДанныеСтроки.СерияНоменклатуры) И ЗначениеЗаполнено(ДанныеСтроки.Номенклатура) Тогда
				 ДанныеСтроки.Вставить("СерияНоменклатуры", СоздатьСериюНоменклатуры(НовСтр.Номенклатура,Строка.ProductSerial,Строка.ValidityPeriod));
			КонецЕсли;
		КонецЕсли;
		Если ИсточникФинансирования = Неопределено Тогда
			СтруктураИсточникФинансирования = НоваяСтруктураFinance();
			ЗаполнитьЗначенияСвойств(СтруктураИсточникФинансирования,Строка.Finance);
			ИсточникФинансирования = Справочники.ИсточникиФинансирования.НайтиПоКоду(СтруктураИсточникФинансирования.FinanceCode);
			Шапка.Вставить("ИсточникФинансирования", ИсточникФинансирования); 
		КонецЕсли;
		ДанныеСтроки.Вставить("ИсточникФинансирования", ИсточникФинансирования);
		ДанныеСтроки.Вставить("Партия", ПодобратьПартию(НовСтр.Номенклатура,НовСтр.СерияНоменклатуры,НовСтр.ЕдиницаИзмерения,НовСтр.КоличествоВЕдиницахИзмерения,
						ШапкаДокумента.Организация,ШапкаДокумента.Склад,ШапкаДокумента.Дата));
	КонецЦикла;
	
	ТабличныеЧасти = Новый Структура();
	ТабличныеЧасти.Вставить("Товары",Товары);	
	
	ДанныеДокумента = Новый Структура;
	ДанныеДокумента.Вставить("ШапкаДокумента",ШапкаДокумента);
	ДанныеДокумента.Вставить("ТабличныеЧасти",ТабличныеЧасти); 
	
	ЗаписатьДокумент(ДанныеДокумента);
	
КонецПроцедуры

Функция ЗаполнитьШапкуДокумента(Шапка, ТаблицаНоменклатуры)
	
	ШапкаДокумента = Новый Структура;	
	
	ШапкаДокумента.Вставить("Дата", СтроковыеФункцииКлиентСервер.СтрокаВДату(Шапка.DocDate));
	ШапкаДокумента.Вставить("Организация",Справочники.бит_НастройкиИнтеграцииQMS.Организация.Значение);
	ШапкаДокумента.Вставить("Отделение", ОбъектПоКоду(Шапка.DocOTDTO));
	ШапкаДокумента.Вставить("ПодразделениеОрганизации", ОбъектПоКоду(Шапка.DocOTD)); 
	ШапкаДокумента.Вставить("СкладОтправитель", ОбъектПоКоду(Шапка.DocSKL));
	ШапкаДокумента.Вставить("СкладПолучатель", ОбъектПоКоду(Шапка.DocSKLTO));  
	ШапкаДокумента.Вставить("Статус", Перечисления.СтатусыТребованийОтделений.НеСогласован);
	ШапкаДокумента.Вставить("Приоритет", Справочники.бит_НастройкиИнтеграцииQMS.ПриоритетТребования.Значение);
	ШапкаДокумента.Вставить("НомерQMS", Шапка.DocNum);	
	ШапкаДокумента.Вставить("Ответственный", ПараметрыСеанса.ТекущийПользователь); 
	ШапкаДокумента.Вставить("Автор", ПараметрыСеанса.ТекущийПользователь);
	ШапкаДокумента.Вставить("Комментарий", "QMS");	
	ШапкаДокумента.Вставить("Хэш",ХэшДанных(ТаблицаНоменклатуры));
	
	Возврат  ШапкаДокумента
	
КонецФункции

Процедура ЗаписатьДокумент(ДанныеДокумента)

	ИмяДокумента = ДанныеДокумента.ШапкаДокумента.ИмяДокумента;
    ПараметрыПоиска = НовыеПараметрыПоискаДокумента();
	ЗаполнитьЗначенияСвойств(ПараметрыПоиска,ДанныеДокумента);	
	РезультатПоиска = НайтиДокумент(ПараметрыПоиска);
	
	Если ЗначениеЗаполнено(РезультатПоиска.ДокументСсылка) Тогда 
		Если РезультатПоиска.ХэшИзменен Тогда
			ДокОбъект = РезультатПоиска.ДокументСсылка.ПолучитьОбъект();
		КонецЕсли;
	Иначе 
		ДокОбъект = Документы[ИмяДокумента].СоздатьДокумент();
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(ДокОбъект,ДанныеДокумента.ШапкаДокумента);
	
	Для Каждого КлючЗначение из ДанныеДокумента.ТабличныеЧасти Цикл
		ДокОбъект[КлючЗначение.Ключ].Очистить();		
		Для Каждого СтрокаТабличнойЧасти из КлючЗначение.Значение Цикл 		
			ЗаполнитьЗначенияСвойств(ДокОбъект[КлючЗначение.Ключ].Добавить(),СтрокаТабличнойЧасти);
		КонецЦикла;		
	КонецЦикла; 
	
	СтруктураСообщенияЖурнала =НоваяСтруктураСообщенияЖурнала();
	Попытка
		ДокОбъект.Записать();
	Исключение
		СтруктураСообщенияЖурнала.Комментарий = ОписаниеОшибки();
		ЗаписатьВЖурналРегистрации(СтруктураСообщенияЖурнала);
	КонецПопытки;
	
	Непроведенные = ОбщегоНазначения.ПровестиДокументы(ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ДокОбъект.Ссылка));

	Если ЗначениеЗаполнено(Непроведенные) Тогда
		СтруктураСообщенияЖурнала.Комментарий = Непроведенные[0].ОписаниеОшибки;
		ЗаписатьВЖурналРегистрации(СтруктураСообщенияЖурнала); 
	КонецЕсли;  
	
	ЗаписатьХэшСсылки(ДокОбъект.Ссылка, ДанныеДокумента.Хэш)	
	
КонецПроцедуры

Функция НайтиДокумент(ПараметрыПоиска)
	
	ИмяДокумента = ПараметрыПоиска.ИмяДокумента;
	НомерДокумента = ПараметрыПоиска.НомерДокумента;
	ДатаДокумента = ПараметрыПоиска.ДатаДокумента;
	Отделение = ПараметрыПоиска.Отделение;
	ХэшДокумента = ПараметрыПоиска.ХэшДокумента;
	
	ПустаяСсылка = Документы[ИмяДокумента].ПустаяСсылка();
	СтруктураДанные = Новый Структура("ДокументСсылка, ХэшИзменен",ПустаяСсылка,Истина);
	Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ПустаяСсылка,"НомерQMS") Тогда
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|  Документ.Ссылка КАК ДокументСсылка,
		|  ЕСТЬNULL(ДополнительныеСведения.Значение, """") КАК Хэш
		|ИЗ
		|  Документ."+ИмяДокумента+" КАК Документ
		|    ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДополнительныеСведения КАК ДополнительныеСведения
		|    ПО Документ.Ссылка = ДополнительныеСведения.Объект
		|      И (ДополнительныеСведения.Свойство.Имя = ""ХэшДокументаQMS"")
		|ГДЕ
		|  Документ.НомерQMS = &НомерДокумента
		|  И НАЧАЛОПЕРИОДА(Документ.Дата, ДЕНЬ) = НАЧАЛОПЕРИОДА(&ДатаДокумента, ДЕНЬ)
		|  И Документ.Отделение = &Отделение"; 
		
		Запрос.УстановитьПараметр("НомерДокумента", НомерДокумента);
		Запрос.УстановитьПараметр("ДатаДокумента", СтроковыеФункцииКлиентСервер.СтрокаВДату(ДатаДокумента));
		Запрос.УстановитьПараметр("Отделение",ОбъектПоКоду(Отделение));
		
		РезультатЗапроса = Запрос.Выполнить();
		
		Выборка = РезультатЗапроса.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			СтруктураДанные.ДокументСсылка = Выборка.ДокументСсылка;
			Если ХэшДокумента = Выборка.Хэш Тогда
				СтруктураДанные.ХэшИзменен = Ложь;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	Возврат СтруктураДанные;
  
КонецФункции

Функция ИмяДокумента(DocType) Экспорт 

	Мэп = Новый Соответствие();
	Мэп.Вставить("списание без назначения", "ВнутреннееПотреблениеТоваровВОтделении");
	Мэп.Вставить("акт списания", 			"ВнутреннееПотреблениеТоваровВОтделении");
	Мэп.Вставить("списание на отделении", 	"ВнутреннееПотреблениеТоваровВОтделении");
	Мэп.Вставить("возврат на главный склад","ВозвратТоваровИзОтделения"); 
	Мэп.Вставить("требование", 				"ТребованиеОтделения");
	
	Возврат Мэп[DocType]; 

КонецФункции

#КонецОбласти

#Область РаботаСоСправочниками
  
Функция ШтрихкодНоменклатуры(Первые = 0, Номенклатура = Неопределено) Экспорт
	Запрос = Новый Запрос;	
	Запрос.Текст =
	"ВЫБРАТЬ 
	|	Товары.Ссылка КАК Ссылка,
	|	ПОДСТРОКА(УпаковкиМаркируемогоТовара.НомерУпаковки, 1, 14) КАК ШтрихКод
	|ПОМЕСТИТЬ ВТ_МаркируемыеУпаковки
	|ИЗ
	|	Справочник.УпаковкиМаркируемогоТовара КАК УпаковкиМаркируемогоТовара
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Товары
	|		ПО УпаковкиМаркируемогоТовара.Номенклатура = Товары.Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	Товары.Ссылка,
	|	ПОДСТРОКА(УпаковкиМаркируемогоТовара.НомерУпаковки, 1, 14)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Товары.Ссылка КАК Ссылка,
	|	ШтрихкодыНоменклатуры.Штрихкод КАК Штрихкод
	|ПОМЕСТИТЬ ВТ_Штрихкоды
	|ИЗ
	|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Товары
	|		ПО ШтрихкодыНоменклатуры.Номенклатура = Товары.Ссылка
	|ГДЕ
	|	Товары.ЭтоЛекарственноеСредство
	|
	|СГРУППИРОВАТЬ ПО
	|	Товары.Ссылка,
	|	ШтрихкодыНоменклатуры.Штрихкод
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Товары.Ссылка КАК Ссылка,
	|	РегистрЛекарственныхСредствШтрихкоды.Штрихкод КАК Штрихкод
	|ПОМЕСТИТЬ ВТ_ШтрихкодыРЛС
	|ИЗ
	|	Справочник.Номенклатура КАК Товары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.РегистрЛекарственныхСредств.Штрихкоды КАК РегистрЛекарственныхСредствШтрихкоды
	|		ПО (РегистрЛекарственныхСредствШтрихкоды.Ссылка = Товары.ЭлементКАТ)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 1 
	|	Номенклатура.Ссылка КАК Ссылка,
	|	ВТ_МаркируемыеУпаковки.ШтрихКод КАК ШтрихкодКИЗ,
	|	МАКСИМУМ(ВТ_Штрихкоды.Штрихкод) КАК ШтрихкодРС,
	|	МАКСИМУМ(ВТ_Штрихкоды.Штрихкод) КАК ШтрихкодРЛС,
	|	МАКСИМУМ(Номенклатура.ЭлементКАТ) КАК ЭлементКАТ
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МаркируемыеУпаковки КАК ВТ_МаркируемыеУпаковки
	|		ПО (ВТ_МаркируемыеУпаковки.Ссылка = Номенклатура.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Штрихкоды КАК ВТ_Штрихкоды
	|		ПО (ВТ_Штрихкоды.Ссылка = Номенклатура.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ШтрихкодыРЛС КАК ВТ_ШтрихкодыРЛС
	|		ПО (ВТ_ШтрихкодыРЛС.Ссылка = Номенклатура.Ссылка)
	|ГДЕ
	|	Номенклатура.ЭтоЛекарственноеСредство
	|
	|СГРУППИРОВАТЬ ПО
	|	Номенклатура.Ссылка,
	|	ВТ_МаркируемыеУпаковки.ШтрихКод"; 
	
	Если ЗначениеЗаполнено(Первые) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"ПЕРВЫЕ 1","ПЕРВЫЕ " + Первые);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"ПЕРВЫЕ 1","");
	КонецЕсли; 
	
	Если ЗначениеЗаполнено(Номенклатура) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "Номенклатура.ЭтоЛекарственноеСредство","Номенклатура.ЭтоЛекарственноеСредство И Номенклатура.Ссылка = &Ссылка" );
		Запрос.УстановитьПараметр("Ссылка",Номенклатура);
	КонецЕсли;

	
	Результат = Запрос.Выполнить(); 
	Выборка = Результат.Выбрать();
	Штрихкод = "";
	Пока Выборка.Следующий() Цикл  		
		Если ЗначениеЗаполнено(Выборка.ШтрихкодРС) Тогда 
			ШтрихКод = Выборка.ШтрихкодРС
		ИначеЕсли ЗначениеЗаполнено(Выборка.ШтрихкодКИЗ) Тогда
			Штрихкод = Выборка.ШтрихкодКИЗ
		ИначеЕсли ЗначениеЗаполнено(Выборка.ШтрихкодРЛС) Тогда 
			Штрихкод = Выборка.ШтрихкодРЛС
		КонецЕсли;
	КонецЦикла;
		
	Возврат Штрихкод;	
КонецФункции

Функция НайтиНоменклатуру(Штрихкод, Код)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.Ссылка КАК Номенклатура
		|ИЗ
		|	Справочник.РегистрЛекарственныхСредств КАК РегистрЛекарственныхСредств
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Номенклатура
		|		ПО РегистрЛекарственныхСредств.Ссылка = Номенклатура.ЭлементКАТ
		|ГДЕ
		|	&Штрихкод <> """"
		|	И ВЫРАЗИТЬ(РегистрЛекарственныхСредств.Штрихкод КАК СТРОКА(300)) ПОДОБНО ""%"" + &Штрихкод + ""%""
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ШтрихкодыНоменклатуры.Номенклатура
		|ИЗ
		|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
		|ГДЕ
		|	(ВЫРАЗИТЬ(ШтрихкодыНоменклатуры.Штрихкод КАК СТРОКА(50))) = &Штрихкод
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	Номенклатура.Ссылка
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	Номенклатура.Код = &Код";
	
	Запрос.УстановитьПараметр("Штрихкод", Штрихкод);
	Запрос.УстановитьПараметр("Код", Код);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Если Выборка.Следующий() Тогда 
		Возврат Выборка.Номенклатура;
	Иначе
		Возврат Неопределено;
	КонецЕсли;  
	
	  
КонецФункции

Функция СоздатьСериюНоменклатуры(Номенклатура, НомерСерии, ГоденДо)
	
	СпрОбъект = Справочники.СерииНоменклатуры.СоздатьЭлемент();
	СпрОбъект.Владелец = Номенклатура;
	СпрОбъект.Номер = НомерСерии;
	СпрОбъект.ГоденДо = СтроковыеФункцииКлиентСервер.СтрокаВДату(ГоденДо);
	Попытка
		СпрОбъект.Записать();
	Исключение
		
	КонецПопытки;
	
	Возврат СпрОбъект.Ссылка;
	
КонецФункции

Функция ПодобратьПартию(Номенклатура,СерияНоменклатуры,ЕдиницаИзмерения,Количество,Организация,Склад,ДатаДокумента)
	
	Запрос = Новый Запрос;
	ТекстЗапроса = "ВЫБРАТЬ ПЕРВЫЕ 1
	               |	Товары.Партия КАК Партия,
	               |	АналитикаПартий.ДокументОприходования КАК Документ,
	               |	АналитикаПартий.Поставщик КАК Поставщик,
	               |	Товары.ВНаличииОстаток / ЕСТЬNULL(ЕдиницыИзмерения.Коэффициент, 1) КАК Остаток
	               |ИЗ
	               |	РегистрНакопления.СвободныеОстатки.Остатки(
	               |			&КонецПериода,
	               |			Партия <> ЗНАЧЕНИЕ(Справочник.ПартииНоменклатуры.ПустаяСсылка)
	               |				И Организация = &Организация
	               |				И Номенклатура = &Номенклатура
	               |				И СерияНоменклатуры В (&СерияНоменклатуры, ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка))
	               |				И Склад = &Склад) КАК Товары
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПартий КАК АналитикаПартий
	               |		ПО Товары.Партия = АналитикаПартий.КлючАналитики
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЕдиницыИзмеренияНоменклатуры КАК ЕдиницыИзмерения
	               |		ПО (ЕдиницыИзмерения.Номенклатура = &Номенклатура)
	               |			И (ЕдиницыИзмерения.ЕдиницаИзмерения = &ЕдиницаИзмерения)
	               |ГДЕ
	               |	Товары.ВНаличииОстаток / ЕСТЬNULL(ЕдиницыИзмерения.Коэффициент, 1) >= &Количество
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	Товары.Партия.ДокументОприходования.Дата";
	
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("КонецПериода", ДатаДокумента);
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("Склад", Склад);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Запрос.УстановитьПараметр("СерияНоменклатуры", СерияНоменклатуры);
	Запрос.УстановитьПараметр("ЕдиницаИзмерения", ЕдиницаИзмерения);
	Запрос.УстановитьПараметр("Количество", Количество);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Возврат ?(Выборка.Следующий(),Выборка.Партия,Неопределено);
	
КонецФункции     

#КонецОбласти

#Область РаботаСХэшами  

Функция ХэшДанных(ОбъектДанных) Экспорт

	Возврат ОбщегоНазначения.КонтрольнаяСуммаСтрокой(ОбъектДанных);
	
КонецФункции 

Процедура ЗаписатьХэшСсылки(Ссылка, Хэш)
	
	Если Не ЗначениеЗаполнено(Ссылка) Тогда
		Возврат
	КонецЕсли;
	
	ТаблицаСвойств = Новый ТаблицаЗначений;
	ТаблицаСвойств.Колонки.Добавить("Значение");
	ТаблицаСвойств.Колонки.Добавить("Свойство");
	
	НоваяСтрока = ТаблицаСвойств.Добавить();
	НоваяСтрока.Значение = Хэш;
	НоваяСтрока.Свойство = бит_ИнтеграцияQMSСерверПовтИсп.ДополнительноеСведениеХэш();
	
	УправлениеСвойствами.ЗаписатьСвойстваУОбъекта(Ссылка,ТаблицаСвойств);	

КонецПроцедуры

Функция СохраненныйХэшСсылки(Ссылка)
	
	Если НЕ ЗначениеЗаполнено(Ссылка) Тогда
		Возврат Неопределено
	КонецЕсли;
	
	УправлениеСвойствами.ЗначениеСвойства(Ссылка, бит_ИнтеграцияQMSСерверПовтИсп.ДополнительноеСведениеХэш());
	
КонецФункции

#КонецОбласти

#Область Служебные 

Функция ОтветQMS(ФайлXML) 
	
	СтруктураПараметровЗапроса = ПолучитьСтруктуруПараметровЗапроса();
	АдресСервераQMS = СтруктураПараметровЗапроса.АдресСервераQMS;
	ДополнительныеПараметры = СтруктураПараметровЗапроса.ДополнительныеПараметры;
	СтруктураСообщенияЖурнала = СтруктураПараметровЗапроса.СтруктураСообщенияЖурнала;
	
	Ответ = КлиентHTTPКлиентСервер.ОтправитьФайл(АдресСервераQMS, ФайлXML, ДополнительныеПараметры);
	ТелоОтвета = Ответ;
	СтатусОтвета = Лев(ТелоОтвета, 1);
	
	Если СтатусОтвета = "0" Тогда
		СтруктураСообщенияЖурнала.Комментарий = ТелоОтвета;
		ЗаписатьВЖурналРегистрации(СтруктураСообщенияЖурнала); 
		Возврат Неопределено;
	КонецЕсли;
	
	Возврат Ответ;
	
КонецФункции

// Процедура - Записать в журнал регистрации
//
// Параметры:
//  СтруктураСообщения	 - Структура:
//	           * ИмяСобытия  - Строка - "Интеграция QMS".
//             * ПредставлениеУровня  - Строка - "Информация"
//                                       Доступные значения: "Информация", "Ошибка", "Предупреждение", "Примечание".
//             * Комментарий - Строка - комментарий события.
//             * ДатаСобытия - Дата   - текущая дата сеанса
Процедура ЗаписатьВЖурналРегистрации(СтруктураСообщения) Экспорт

	СобытияЖурнала = Новый СписокЗначений;
	СобытияЖурнала.Добавить(СтруктураСообщения);
	ЖурналРегистрации.ЗаписатьСобытияВЖурналРегистрации(СобытияЖурнала);
	
КонецПроцедуры 

Функция СвойстваXDTOВСоответствие(СписокСвойствXDTO) Экспорт  
	
	Мэп = Новый Соответствие;
	Если ТипЗнч(СписокСвойствXDTO) = Тип("ОбъектXDTO") Тогда
		Для Каждого Свойство Из СписокСвойствXDTO.Свойства() Цикл
			Мэп.Вставить(Свойство.Имя);
		КонецЦикла;
	ИначеЕсли ТипЗнч(СписокСвойствXDTO) = Тип("СписокXDTO") Тогда
		Для Каждого Свойство Из СписокСвойствXDTO[0].Свойства() Цикл
			Мэп.Вставить(Свойство.Имя);
		КонецЦикла;
	КонецЕсли;
	Возврат Мэп;
	
КонецФункции 

Функция ДополнительноеСведениеПоИмени(Имя) Экспорт 
	
	ПВХ = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоРеквизиту("Имя",Имя);
	
	Если НЕ ЗначениеЗаполнено(ПВХ) Тогда
		ПВХОбъект = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.СоздатьЭлемент();
		ПВХОбъект.Наименование = Имя;
		ПВХОбъект.Имя = Имя;
		ПВХОбъект.ВидСвойств = Перечисления.ВидыСвойств.ДополнительныеСведения;
		ПВХОбъект.ТипЗначения = Тип("Строка");
		ПВХОбъект.Виден = Истина;
		ПВХОбъект.Доступен = Истина;
		ПВХОбъект.Заголовок = Имя;
		ПВХОбъект.ЗаголовокЯзык1 = Имя;
		ПВХОбъект.ЗаголовокЯзык2 = Имя;
		ПВХОбъект.ЭтоДополнительноеСведение = Истина;
		ПВХОбъект.Записать();
		ПВХ = ПВХОбъект.Ссылка;
	КонецЕсли;
	
	Возврат ПВХ
	
КонецФункции

// Функция - Получает код объекта 
// Параметры:
//  Объект - 	 СправочникСсылка.ОтделенияОрганизаций, СправочникСсылка.Склады, СправочникСсылка.ПодразделенияОрганизаций, СправочникСсылка.Организации 
// Возвращаемое значение:
//   -    Строка - Код объектаQMS
//
Функция КодОбъекта(Объект) Экспорт
	
	Возврат РегистрыСведений.бит_СоответствияОбъектовУчетаQMS.ПолучитьКодОбъекта(Объект);

КонецФункции 

Функция ОбъектПоКоду(Код) Экспорт 
	
	Возврат РегистрыСведений.бит_СоответствияОбъектовУчетаQMS.ПолучитьОбъектПоКоду(Код);
																						  
КонецФункции 

Функция ПолучитьСтруктуруТиповEnvelopeBody()
	
	ТипEnvelope = ФабрикаXDTO.Тип("http://schemas.xmlsoap.org/soap/envelope/", "Envelope"); 
	ТипBody = ТипEnvelope.Свойства.Получить("Body").Тип;
	СтруктураТиповEnvelopeBody = Новый Структура;
	СтруктураТиповEnvelopeBody.Вставить("ТипEnvelope", ТипEnvelope);
	СтруктураТиповEnvelopeBody.Вставить("ТипBody", ТипBody);
	Возврат СтруктураТиповEnvelopeBody;
КонецФункции

Функция ПолучитьСтруктуруПараметровЗапроса()
	
	АдресСервераQMS = бит_ИнтеграцияQMSСерверПовтИсп.НастройкиПодключения().АдресСервера;
	ДополнительныеПараметры = КлиентHTTPКлиентСервер.НовыеДополнительныеПараметры();
	КлиентHTTPКлиентСервер.ТелоОтветаКакXML(ДополнительныеПараметры);
	СтруктураСообщенияЖурнала =НоваяСтруктураСообщенияЖурнала();
	Узел = ПланыОбмена.бит_ПланОбменаQMS.НайтиПоКоду("001");
	
	СтруктураПараметров = Новый Структура();
	
	СтруктураПараметров.Вставить("АдресСервераQMS", АдресСервераQMS);
	СтруктураПараметров.Вставить("ДополнительныеПараметры", ДополнительныеПараметры);
	СтруктураПараметров.Вставить("СтруктураСообщенияЖурнала", СтруктураСообщенияЖурнала);
	СтруктураПараметров.Вставить("Узел", Узел);
	
	Возврат СтруктураПараметров;  
	
	
КонецФункции 

Функция ИдентификаторОрганизации()
	
	Возврат "Хадасса";
	
КонецФункции

#КонецОбласти 

#Область Конструкторы

Функция НоваяСтруктураFinance() Экспорт
	
	Возврат Новый Структура("FinanceCode,FinanceName");
	
КонецФункции 

Функция НовыеПараметрыПоискаДокумента() 
	
	ПараметрыПоиска = Новый Структура;
	ПараметрыПоиска.Вставить("Имя");
	ПараметрыПоиска.Вставить("НомерДокумента");
	ПараметрыПоиска.Вставить("ДатаДокумента");
	ПараметрыПоиска.Вставить("Отделение");
	ПараметрыПоиска.Вставить("Хэш");
	
	Возврат ПараметрыПоиска;
	
КонецФункции

Функция НоваяТаблицаProductTransferStructure() Экспорт
																
	
	ТЗ = Новый ТаблицаЗначений;    
    ТЗ.Колонки.Добавить("Category");
    ТЗ.Колонки.Добавить("PST");
    ТЗ.Колонки.Добавить("Finance");
	ТЗ.Колонки.Добавить("MDLP");
    ТЗ.Колонки.Добавить("ProductSerial");
    ТЗ.Колонки.Добавить("Price");
	ТЗ.Колонки.Добавить("NumMin");
    ТЗ.Колонки.Добавить("NumMax");
    ТЗ.Колонки.Добавить("ValidityPeriod");
	ТЗ.Колонки.Добавить("Barcode");
    ТЗ.Колонки.Добавить("KSU");
    ТЗ.Колонки.Добавить("DocType");
	ТЗ.Колонки.Добавить("DocNum");
    ТЗ.Колонки.Добавить("DocDate");
    ТЗ.Колонки.Добавить("DocSKL");
	ТЗ.Колонки.Добавить("DocOTD");
    ТЗ.Колонки.Добавить("GUIDs41");
    ТЗ.Колонки.Добавить("uCode");
	ТЗ.Колонки.Добавить("uName");
	ТЗ.Колонки.Добавить("num174");
    ТЗ.Колонки.Добавить("Finance174");
    ТЗ.Колонки.Добавить("dat174b");
	ТЗ.Колонки.Добавить("dat174e");
    ТЗ.Колонки.Добавить("GUID174");
    ТЗ.Колонки.Добавить("DocSKLTO");	
	ТЗ.Колонки.Добавить("DocOTDTO");
	ТЗ.Колонки.Добавить("Doctor");
	ТЗ.Колонки.Добавить("Nurse");
    ТЗ.Колонки.Добавить("fio");
    ТЗ.Колонки.Добавить("pB");
	ТЗ.Колонки.Добавить("birthday");
    ТЗ.Колонки.Добавить("pstName");
    ТЗ.Колонки.Добавить("pstINN");
	ТЗ.Колонки.Добавить("ContractNum");
	ТЗ.Колонки.Добавить("ContractDate");
	
	Возврат ТЗ;
	
КонецФункции  

Функция НоваяСтруктураCategory() Экспорт
	
	Возврат Новый Структура("pIDo,ProductCode,Name,Category,SubCategory,Ration,UnitCodeMin,UnitCodeMax,RLS,ESKLP,BarcodeMain,ProductGroup,PKU,FederalCode,RegionalCode");
	
КонецФункции 

Функция НоваяСтруктураСообщенияЖурнала() Экспорт 
	
	СтруктураСообщения = Новый Структура;
	СтруктураСообщения.Вставить("ИмяСобытия", "Интеграция QMS");
	СтруктураСообщения.Вставить("ПредставлениеУровня", "Информация");
	СтруктураСообщения.Вставить("Комментарий", Неопределено);
	СтруктураСообщения.Вставить("ДатаСобытия", ТекущаяДатаСеанса());	
	Возврат СтруктураСообщения; 	

КонецФункции

#КонецОбласти

 




