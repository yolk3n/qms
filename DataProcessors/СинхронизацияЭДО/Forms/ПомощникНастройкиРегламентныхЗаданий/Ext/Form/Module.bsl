
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	РезультатПроверкиНастроек = Параметры.РезультатПроверки;
	Операция = Параметры.Операция;
	
	// Если база файловая, то не показываем ссылки для настроек, так как в них нет смысла.
	// Настраивать можно только для режима клиент-сервер.
	ПоказыватьСсылки = РезультатПроверкиНастроек.РежимРаботы;
	
	ОтобразитьРезультатПроверки();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если ИмяСобытия = "ПроверитьНастройкиРегламентныхЗаданий" Тогда
		
		НачатьПроверкуНастроекРегламентныхЗаданий();
		ОжидатьЗавершенияПроверкиНастроекРегламентныхЗаданий();
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ДекорацияЗаголовокОбработкаНавигационнойСсылки(
	Элемент, НавигационнаяСсылкаФорматированнойСтроки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	СсылкаНаИнструкцию = СинхронизацияЭДОСлужебныйКлиент.СсылкаНаИнструкциюПоНастройкеЭлектронногоДокументооборота();
	ФайловаяСистемаКлиент.ОткрытьНавигационнуюСсылку(СсылкаНаИнструкцию);
	
КонецПроцедуры

&НаКлиенте
Процедура НадписьСертификатОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылкаФорматированнойСтроки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ОткрытьФормуСертификатов();
	
КонецПроцедуры

&НаКлиенте
Процедура НадписьПарольСертификатаОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылкаФорматированнойСтроки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ОткрытьФормуСертификатов();
	
КонецПроцедуры

&НаКлиенте
Процедура ПодсказкаПроверятьПодписьОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылкаФорматированнойСтроки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	АктивироватьНастройкуПроверкиПодписиНаСервере();
	ОжидатьЗавершенияПроверкиНастроекРегламентныхЗаданий();
	
КонецПроцедуры

&НаКлиенте
Процедура ПодсказкаСоздаватьПодписьОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылкаФорматированнойСтроки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	АктивироватьНастройкуСозданияПодписиНаСервере();
	ОжидатьЗавершенияПроверкиНастроекРегламентныхЗаданий();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ВключитьЗадание(Команда)
	
	Оповестить("ПомощникНастроекРегламентныхЗаданийВключитьЗадание", Операция);
	Закрыть();
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура НачатьПроверкуНастроекРегламентныхЗаданий()
	
	ПроверкаНастроек = СинхронизацияЭДО.НачатьПроверкуНастроекРегламентныхЗаданий(
		УникальныйИдентификатор);
	
КонецПроцедуры

&НаКлиенте
Процедура ОжидатьЗавершенияПроверкиНастроекРегламентныхЗаданий()
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(ЭтотОбъект);
	ПараметрыОжидания.ВыводитьОкноОжидания = Истина;
	ПараметрыОжидания.ТекстСообщения = НСтр("ru='Проверяется возможность включения регламентного задания.'");
	
	ОповещениеОЗавершении = Новый ОписаниеОповещения("ОбработатьРезультатПроверкиНастроекРегламентныхЗаданий", ЭтотОбъект);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ПроверкаНастроек, ОповещениеОЗавершении, ПараметрыОжидания);
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьРезультатПроверкиНастроекРегламентныхЗаданий(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если Результат.Статус <> "Выполнено" Тогда
		
		Если Результат.Статус = "Ошибка" Тогда
			
			ОбработкаНеисправностейБЭДВызовСервера.ОбработатьОшибку(НСтр("ru='Автоматическая проверка настроек регламентных заданий'"),
				ОбщегоНазначенияБЭДКлиентСервер.ПодсистемыБЭД().ОбменСКонтрагентами, Результат.ПодробноеПредставлениеОшибки,
				Результат.КраткоеПредставлениеОшибки);
			
		КонецЕсли;
		
		Возврат;
		
	КонецЕсли;
	
	РезультатПроверкиНастроек = ПолучитьИзВременногоХранилища(Результат.АдресРезультата);
	ОтобразитьРезультатПроверки();
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьФормуСертификатов()
	
	ОткрытьФорму("Обработка.СинхронизацияЭДО.Форма.СписокСертификатов",,
		ЭтотОбъект,,,,, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаСервере
Процедура ОтобразитьРезультатПроверки()
	
	Операции = СинхронизацияЭДОКлиентСервер.ОперацииПроверкиНастроекРегламентныхЗаданий();
	Заголовки = Новый Структура;
	Заголовки.Вставить(Операции.Отправка, НСтр("ru='Автоматическая отправка документов'"));
	Заголовки.Вставить(Операции.Получение,   НСтр("ru='Автоматическое получение документов'"));
	Заголовки.Вставить(Операции.ПоУмолчанию, НСтр("ru='Автоматическая отправка/получение документов'"));
	
	Заголовок = Заголовки[Операция];
	
	Если РезультатПроверкиНастроек.Успех Тогда
		ЗаголовокПодсказка = НСтр("ru='Настройки для автоматической отправки/получения выполнены.'");
	Иначе
		Шаблон = НСтр("ru='Для работы с электронными документами в автоматическом режиме требуется дополнительная настройка. <a href = ""ПерейтиВСправкуВИнтернете"">Узнать больше</a>'");
		ЗаголовокПодсказка = СтроковыеФункции.ФорматированнаяСтрока(Шаблон);
	КонецЕсли;
	
	Элементы.ДекорацияЗаголовок.Заголовок = ЗаголовокПодсказка;
	Элементы.ВключитьЗадание.Доступность  = РезультатПроверкиНастроек.Успех;
	
	// Режим работы.
	КартинкаРежимРаботы = ИндексКартинкиСостояния(РезультатПроверкиНастроек.РежимРаботы);
	Описание = ОписаниеСостояния(Элементы.НадписьРежимРаботы, РезультатПроверкиНастроек.РежимРаботы);
	УстановитьТекстЭлемента(Элементы.НадписьРежимРаботы, Описание);
	
	// Наличие криптопровайдера.
	КартинкаКриптоПровайдер = ИндексКартинкиСостояния(РезультатПроверкиНастроек.ЕстьКриптоПровайдер);
	Описание = ОписаниеСостояния(Элементы.НадписьКриптоПровайдер, РезультатПроверкиНастроек.ЕстьКриптоПровайдер);
	УстановитьТекстЭлемента(Элементы.НадписьКриптоПровайдер, Описание);
	
	// Наличие сертификатов.
	КартинкаСертификат = ИндексКартинкиСостояния(РезультатПроверкиНастроек.ЕстьСертификаты);
	Описание = ОписаниеСостояния(Элементы.НадписьСертификат, РезультатПроверкиНастроек.ЕстьСертификаты);
	УстановитьТекстЭлемента(Элементы.НадписьСертификат, Описание);
	
	// Наличие паролей.
	КартинкаПарольСертификата = ИндексКартинкиСостояния(РезультатПроверкиНастроек.ПаролиСохранены);
	Описание = ОписаниеСостояния(Элементы.НадписьПарольСертификата, РезультатПроверкиНастроек.ПаролиСохранены);
	УстановитьТекстЭлемента(Элементы.НадписьПарольСертификата, Описание);
	
	// Проверка подписи на сервере.
	КартинкаПроверкаПодписи = ИндексКартинкиСостояния(РезультатПроверкиНастроек.ПроверкаПодписи);
	Описание = ОписаниеСостояния(Элементы.НадписьПроверятьПодпись, РезультатПроверкиНастроек.ПроверкаПодписи);
	УстановитьТекстЭлемента(Элементы.НадписьПроверятьПодпись, Описание);
	
	// Создание подписи на сервере.
	КартинкаСозданиеПодписи = ИндексКартинкиСостояния(РезультатПроверкиНастроек.СозданиеПодписи);
	Описание = ОписаниеСостояния(Элементы.НадписьСоздаватьПодпись, РезультатПроверкиНастроек.СозданиеПодписи);
	УстановитьТекстЭлемента(Элементы.НадписьСоздаватьПодпись, Описание);
	
КонецПроцедуры

&НаСервере
Функция ИндексКартинкиСостояния(ИндексСостояния)
	
	// Индекс состояния и индекс картинки в коллекции могут не совпадать, необходимо установить соответствие.
	
	// Индексы состояний.
	// 0 - Блокирующая ошибка.
	// 1 - Неблокирующая ошибка.
	// 2 - Ошибок нет.
	
	Индексы = Новый Соответствие; // состояние - индекс картинки в коллекции
	Индексы.Вставить(0, 0);
	Индексы.Вставить(1, 1);
	Индексы.Вставить(2, 3);
	
	Возврат Индексы[ИндексСостояния];
	
КонецФункции

&НаСервере
Процедура УстановитьТекстЭлемента(Элемент, Описание)
	
	Элемент.Заголовок                      = Описание.Заголовок;
	Элемент.РасширеннаяПодсказка.Заголовок = Описание.Подсказка
	
КонецПроцедуры

&НаСервере
Функция ОписаниеСостояния(ЭлементФормы, ИндексСостояния)
	
	// Индексы состояний.
	// 0 - Блокирующая ошибка.
	// 1 - Неблокирующая ошибка.
	// 2 - Ошибок нет.
	
	ОписаниеСостояний = Новый Соответствие;
	ОписаниеПодсказок = Новый Соответствие;
	
	ОписаниеПодсказок.Вставить(2, ""); // если нет ошибок, то подсказку не выводим
	
	Если ЭлементФормы = Элементы.НадписьРежимРаботы Тогда
		
		ОписаниеСостояний.Вставить(0, НСтр("ru='Информационная база должна работать в режиме клиент-сервер'"));
		ОписаниеПодсказок.Вставить(0, НСтр("ru='Работа регламентных заданий по отправке и получению документов поддерживается только в режиме клиент-сервер.'"));
		
		ОписаниеСостояний.Вставить(2, НСтр("ru='Информационная база работает в режиме клиент-сервер'"));
		
	ИначеЕсли ЭлементФормы = Элементы.НадписьКриптоПровайдер Тогда
		
		ОписаниеСостояний.Вставить(0, НСтр("ru='Необходимо установить криптопровайдер'"));
		ОписаниеПодсказок.Вставить(0, НСтр("ru='Криптопровайдер должен быть установлен на сервере.'"));
		
		ОписаниеСостояний.Вставить(2, НСтр("ru='Криптопровайдер установлен на сервере'"));
		
	ИначеЕсли ЭлементФормы = Элементы.НадписьСертификат Тогда
		
		ОписаниеСостояний.Вставить(0, НСтр("ru='Нет доступных сертификатов'"));
		ОписаниеПодсказок.Вставить(0, НСтр("ru='По каждой учетной записи ЭДО должен быть сертификат, установленный на сервере. Сертификат должен быть установлен для пользователя, от имени которого работает сервер 1с. Значение поля ""Используют"" сертификата должно быть ""Не указаны"".'"));
		
		Шаблон = НСтр("ru='Не у всех учетных записей есть доступные <a href = ""%1"">сертификаты</a> на сервере.'");
		ФорматированнаяСтрока = СтроковыеФункции.ФорматированнаяСтрока(Шаблон,
			?(ПоказыватьСсылки, "ОткрытьФормуСертификатов", ""));
		ОписаниеСостояний.Вставить(1, ФорматированнаяСтрока);
		ОписаниеПодсказок.Вставить(1, НСтр("ru='Автоматически получать документы можно только по тем учетным записям ЭДО, по которым есть сертификат. Сертификат должен быть установлен для пользователя, от имени которого работает сервер 1с. Значение поля ""Используют"" сертификата должно быть ""Не указаны"".'"));
		
		ОписаниеСостояний.Вставить(2, НСтр("ru='Есть доступные сертификаты на сервере'"));
		
	ИначеЕсли ЭлементФормы = Элементы.НадписьПарольСертификата Тогда
		
		Шаблон = НСтр("ru='Пароли <a href = ""%1"">сертификатов</a> не сохранены'");
		ФорматированнаяСтрока = СтроковыеФункции.ФорматированнаяСтрока(Шаблон,
			?(ПоказыватьСсылки, "ОткрытьФормуСертификатов", ""));
		
		ОписаниеСостояний.Вставить(0, ФорматированнаяСтрока);
		ОписаниеПодсказок.Вставить(0, НСтр("ru='Пароль для сертификата должен быть сохранен без привязки к пользователю и не должен быть пустым.'"));
		
		Шаблон = НСтр("ru='Пароли сохранены не для всех <a href = ""%1"">сертификатов</a>'");
		ФорматированнаяСтрока = СтроковыеФункции.ФорматированнаяСтрока(Шаблон,
			?(ПоказыватьСсылки, "ОткрытьФормуСертификатов", ""));
			
		ОписаниеСостояний.Вставить(1, ФорматированнаяСтрока);
		ОписаниеПодсказок.Вставить(1, НСтр("ru='Отправлять/получать документы автоматически можно только по сертификатам с сохраненным паролем.'"));
		
		ОписаниеСостояний.Вставить(2, НСтр("ru='Пароли сертификатов сохранены'"));
		
	ИначеЕсли ЭлементФормы = Элементы.НадписьПроверятьПодпись Тогда
		
		ОписаниеСостояний.Вставить(0, НСтр("ru='Проверка подписей и сертификатов на сервере'"));
		
		Шаблон = НСтр("ru='Проверка подписей и сертификатов должна происходить на сервере.'");
		Если ПоказыватьСсылки Тогда
			Шаблон = Шаблон + Символы.ПС
				+ НСтр("ru='<a href = ""АктивироватьПроверкуНаСервере"">Нажмите, чтобы активировать</a>'");
		КонецЕсли;
		
		ФорматированнаяСтрока = СтроковыеФункции.ФорматированнаяСтрока(Шаблон);
		
		ОписаниеПодсказок.Вставить(0, ФорматированнаяСтрока);
		
		ОписаниеСостояний.Вставить(2, НСтр("ru='Проверка подписей и сертификатов выполняется на сервере'"));
		
	ИначеЕсли ЭлементФормы = Элементы.НадписьСоздаватьПодпись Тогда
		
		ОписаниеСостояний.Вставить(0, НСтр("ru='Подпись и шифрование на сервере'"));
		
		Шаблон = НСтр("ru='Подпись и шифрование должно происходить на сервере.'");
		Если ПоказыватьСсылки Тогда
			Шаблон = Шаблон + Символы.ПС
				+ НСтр("ru='<a href = ""АктивироватьПроверкуНаСервере"">Нажмите, чтобы активировать</a>'");
		КонецЕсли;
		ФорматированнаяСтрока = СтроковыеФункции.ФорматированнаяСтрока(Шаблон);
			
		ОписаниеПодсказок.Вставить(0, ФорматированнаяСтрока);
		
		ОписаниеСостояний.Вставить(2, НСтр("ru='Подпись и шифрование выполняется на сервере'"));
		
	КонецЕсли;
	
	Возврат
		Новый Структура("Заголовок, Подсказка", ОписаниеСостояний[ИндексСостояния], ОписаниеПодсказок[ИндексСостояния]);
	
КонецФункции

&НаСервере
Процедура АктивироватьНастройкуПроверкиПодписиНаСервере()
	
	КриптографияБЭД.УстановитьНастройкиСервернойКриптографии(, Истина);
	НачатьПроверкуНастроекРегламентныхЗаданий();
	
КонецПроцедуры

&НаСервере
Процедура АктивироватьНастройкуСозданияПодписиНаСервере()
	
	КриптографияБЭД.УстановитьНастройкиСервернойКриптографии(Истина);
	НачатьПроверкуНастроекРегламентныхЗаданий();
	
КонецПроцедуры

#КонецОбласти